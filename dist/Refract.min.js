// Version 2022.1.25.2104
// License: MIT
// https://github.com/vorticode/Refract
var lexCache={};function lex(e,t,r=null,i=1,l=1,s=0){let n;if(r=r||Object.keys(e)[0],256>(t+="").length){var o=r+"|"+t;if(n=lexCache[o],n)return n.slice()}for(n=[];t.length>s;){let o,h,c=t.slice(s);for(var[f,a]of Object.entries(e[r])){if(a instanceof RegExp)h=(c.match(a)||[])[0];else if("function"==typeof a)[h,o]=a(c,t.slice(0,s),n)||[];else if(Array.isArray(a)){for(let e of a)if(c.startsWith(e)){h=e;break}}else c.startsWith(a)&&(h=a);if(void 0!==h)break}if(h=Object.assign(h,{type:f,mode:o&&-1!==o?o:r,line:i,col:l}),-1===o)return[...n,h];if(o){let n=[h,...lex(e,t,o,i,l+h.length,s+h.length)].filter((e=>e.length));h=Object.assign(n.join(""),{type:f,tokens:n,mode:r,line:i,col:l})}if(h.length){s+=h.length,n.push(h),i+=(h.match(/\n/g)||[]).length;let e=h.lastIndexOf("\n");l=(e>-1?-e:l)+h.length}}return 256>t.length&&(lexCache[o]=n),n}var descendIf=(e,t,r)=>i=>{if(e instanceof RegExp){let l=i.match(e)||[];if(l.length)return r&&r(l),[l[0],t]}else if(i.startsWith(e))return r&&r(e),[e,t]},ascendIf=e=>t=>{if(e instanceof RegExp){let r=t.match(e)||[];if(r.length)return[r[0],-1]}else if(t.startsWith(e))return[e,-1]};{let e=null,t=0,r=[],i=0,l=/^[ \t\v\f\xa0]+/,s=/^\r?\n/,n=/^<!?([\w\xA0-\uFFFF:-]+)/i,o=/^<\/[\w\xA0-\uFFFF:-]+\s*>/i,f="&& || ! => <<= >>= &= ^= |= &&= ||= & | ^ ~ >>> << >> === !=== == != >= > <= < = **= += -= *= /= %= ??= ++ -- ** + - * / % , ... . ( ) [ ] ? :".split(/ /g),a=e=>{if("{"===e[1])return lexHtmlJs.allowHashTemplates&&e.startsWith("#{")||e.startsWith("${")?(i>0||(i=1),r.push(t),t=0,[e.slice(0,2),"js"]):void 0},h=e=>{if("`"===e[0])return--i,t=r.pop(),["`",-1]},c={whitespace:/^[ \r\n\t\v\f\xa0]+/,attribute:/^[\-_$\w\xA0-\uFFFF:]+/i,string:e=>descendIf("'","squote")(e)||descendIf('"',"dquote")(e),equals:"=",tagEnd:e=>">"===e[0]?[">",-1]:e.startsWith("/>")?["/>",-1]:void 0,unknown:e=>lexHtmlJs.allowUnknownTagTokens?e.match(/^\w+|\S/)||[]:void 0},u=(t,r,i)=>{let l=i[i.length-1];if("script"===e&&l&&l.tokens&&">"==l.tokens[l.tokens.length-1])return["","js"]},p="await break case catch class constructor const continue debugger default delete do enum else export extends\n\t\t\t\tfinally for function if implements import in instanceof interface let new package private protected public\n\t\t\t\treturn static super switch this throw try typeof var void while with yield".split(/\s+/g),d="{ ( [ . ; , < > <= >= == != === !== + - * % << >> >>> & | ^ ! ~ && || ? : = += -= *= %= <<= >>= >>>= &= |= ^= /=".split(/ /g);var lexHtmlJs={js:{whitespace:l,ln:s,comment:/^\/\/.*(?=\r?\n)|^\/\*[\s\S]*?\*\//,end:e=>e.startsWith("<\/script>")?["",-1]:void 0,regex(e,t,r){if("/"!==e[0])return;if(r.length){let e;for(let t=r.length-1;t>=0;t--)if("ln"!==r[t].type&&"whitespace"!==r[t].type&&"comment"!==r[t].type){e=r[t]+"";break}if(!d.includes(e))return}let i=1;for(;;){if(i=e.indexOf("/",i+1),-1===i)return;try{let t=e.slice(0,i+1);return RegExp(t.slice(1,-1)),[t+e.slice(t.length).match(/^[agimsx]*/)[0]]}catch(e){}}},hex:/^0x[0-9a-f]+/,number:/^\d*\.?\d+(e\d+)?/,identifier(e){let t=(e.match(/^[_$a-z\xA0-\uFFFF][_$\w\xA0-\uFFFF]*/i)||[])[0];if(!p.includes(t))return[t]},template(e){if("`"===e[0])return++i,r.push(t),t=0,["`","template"]},brace1(e){if("{"===e[0])return t++,["{"]},brace2(e){if("}"===e[0])return 0===t&&i?(t=r.pop(),["}",-1]):(t--,["}"])},semicolon:";",keyword:p,operator(e){for(let t of f)if(e.startsWith(t))return[t]},string:/^"(\\\\|\\"|[^"])*"|^'(\\\\|\\'|[^'])*'/},html:{script:u,comment:descendIf("\x3c!--","htmlComment"),closeTag:o,openTag:descendIf(n,"tag",(t=>e=t[1])),text:/^[\s\S]+?(?=<|$)/},htmlComment:{commentEnd:ascendIf("--\x3e"),commentBody:/^[\s\S]+?(?=-->|$)/},template:{script:u,expr:a,comment:descendIf("\x3c!--","templateComment"),closeTag:o,openTag:descendIf(n,"templateTag",(t=>e=t[1])),templateEnd:h,text:e=>e.match(lexHtmlJs.allowHashTemplates?/^(?:\\#{|\\\${|\s|(?!(#{|\${|`|<[\w\xA0-\uFFFF!:/-]|$)).)+/:/^(?:\\\${|\s|(?!(\${|`|<[\w\xA0-\uFFFF!:/-]|$)).)+/)||[]},templateComment:{expr:a,commentEnd:ascendIf("--\x3e"),commentBody:e=>e.match(lexHtmlJs.allowHashTemplates?/^[\s\S]+?(?=-->|[$#]{|$)/:/^[\s\S]+?(?=-->|\${|$)/)||[]},tag:c,templateTag:{expr:a,templateEnd:h,...c},squote:{expr:a,quote:ascendIf("'"),text:e=>e.match(lexHtmlJs.allowHashTemplates?/^(?:\\'|(?!'|#{|\${)[\S\s])+/:/^(?:\\'|(?!'|#{)[\S\s])+/)||[]},dquote:{expr:a,quote:ascendIf('"'),text:e=>e.match(lexHtmlJs.allowHashTemplates?/^(?:\\"|(?!"|#{|\${)[\S\s])+/:/^(?:\\"|(?!"|#{)[\S\s])+/)||[]},allowHashTemplates:!1,allowUnknownTagTokens:!1}}function fregex(...e){return e=prepare(e),t=>{let r=0;for(let i of e){let e=i(t.slice(r));if(!1===e)return!1;r+=e}return r}}fregex.or=(...e)=>(e=prepare(e),t=>{for(let r of e){let e=r(t);if(!1!==e)return e}return!1}),fregex.not=(...e)=>{let t=fregex(e);return e=>!1===t(e)&&0},fregex.nor=(...e)=>(e=prepare(e),t=>{for(let r of e)if(r(t)>0)return!1;return 1}),fregex.zeroOrOne=(...e)=>{let t=fregex(e);return e=>{let r=t(e);return!1===r?0:r}},fregex.xOrMore=(e,...t)=>{let r=fregex(t);return t=>{let i=0;for(let l=0;t.length;l++){let s=r(t);if(!1===s)return l>=e&&i;i+=s||1,t=t.slice(s||1)}return i}},fregex.zeroOrMore=(...e)=>fregex.xOrMore(0,...e),fregex.oneOrMore=(...e)=>fregex.xOrMore(1,...e),fregex.matchFirst=(e,t,r=0)=>{let i=fregex.matchAll(e,t,1,r);return i.length?i[0]:null},fregex.matchAll=(e,t,r=1/0,i=0)=>{Array.isArray(e)&&(e=fregex(e));let l=[];for(let s=i;t.length>s&&r>l.length;s++){let r=e(t.slice(s));!1!==r&&l.push(Object.assign(t.slice(s,s+r),{index:s}))}return l},fregex.lookAhead=(...e)=>(e=prepare(e),t=>{for(let r of e)if(!1===r(t))return!1;return 0}),fregex.end=e=>!e.length&&0;var prepare=e=>{Array.isArray(e[0])&&1===e.length&&(e=e[0]);let t=[];for(let r in e){let i=e[r];t[r]="string"==typeof i?e=>e[0]==i:Array.isArray(i)?fregex(i):"object"!=typeof i||i.prototype?e[r]:e=>{for(let t in i)if(e[0][t]!=i[t])return!1;return 1}}return t};let varExpressionCache={};var Parse={t(e=[]){let t=e.join(",");return varExpressionCache[t]||(varExpressionCache[t]=fregex(fregex.or(fregex("this",Parse.ws,fregex.oneOrMore(property)),...e.map((e=>fregex(e,fregex.zeroOrMore(property))))),terminator))},filterArgNames(e){let t=[],r=1,i=0;for(let l of e)1!==r||"identifier"!==l.type||i?"("==l||"{"==l||"["==l?i++:")"!=l&&"}"!=l&&"]"!=l||i--:t.push(l+""),i||(r={",":1,"=":-1}[l]||r);return t},replaceHashExpr(e,t,r){let i=[],l=!1;for(let t of e)if(t.tokens){let e=Parse.replaceHashExpr(t.tokens,t.mode,r);i.push(Object.assign(e.join(""),{type:t.type,tokens:e,mode:t.mode}))}else"#{"==t&&"expr"==t.type?(i.push("${",r,".","htmlEncode","("),l=!0):i.push(t+"");if(l){let e=[];"squote"===t?e=[",",'"\'"']:"dquote"===t&&(e=[",","'\"'"]),i.splice(i.length-1,0,...e,")")}return i},findGroupEnd(e,t=0,r=1,i=null){let l=0;for(let s,n=t;s=e[n];n+=r)if("("==s||"{"==s)l+=r;else if(")"==s||"}"==s){if(l-=r,0>l)return n}else if(!l&&s==i)return n;return null},findFunctionArgs(e,t=0){if("function"!=e[t]&&"("!=e[t])return[t,t+1];for(;"("!=e[t]&&e.length>t;)t++;return[t+1,this.findGroupEnd(e,t+1)]},findFunctionBody(e,t=0){},findFunctionStart(e,t=0){for(let r,i=t;r=e[i];i++){if("function"==r)return i;if("=>"==r){let t=0;for(let r,l=-1;r=e[i+l];l--)if("whitespace"!==r.type&&"ln"!==r.type&&(")"==r?t++:"("==r&&t--,0===t))return i+l}}return null},findFunctionEnd(e,t){let r="function"!=e[t],i=0,l=r&&"("!=e[t]?1:2;for(let s,n=t;s=e[n];n++){if(!i&&r&&(";"==s||")"==s))return n;if("("==s||"{"==s)i++;else if(!(")"!=s&&"}"!=s||(i--,i||(l--,l))))return n+1}return null},findFunction(e,t=0){let r=this.findFunctionStart(e,t);return null===r?null:[r,this.findFunctionEnd(e,r)]},escape$(e){let t=this.findFunctionStart(e);for(let r,i=0;r=e[i];i++)i===t&&(i=this.findFunctionEnd(e,i),t=this.findFunctionStart(e,i)),"template"===r.type&&(e[i]="`"+r.slice(1,-1).replace(/\${/g,"\\${").replace(/`/g,"\\`")+"`");return e},i(e,t=[]){let r=[Parse.t(t),Parse.ws,".",Parse.ws,"map",Parse.ws,"(",Parse.ws],i=fregex.matchFirst(r,e);if(!i)return[null,null];let l=e.slice(i.length),s=Parse.findFunction(l);if(!s||0!==s[0])return[null,null];l=l.slice(...s);let n=Parse.findFunctionArgs(l),o=l.slice(...n),f=Parse.filterArgNames(o),a=[Parse.ws,fregex.or([{type:"identifier"},["(",Parse.ws,Parse.argList,Parse.ws,")"]]),Parse.ws,"=>",Parse.ws],h=fregex.matchFirst(a,e.slice(i.length)),c=[],u=0,p=0,d=0,m=e.length-1;for(;"whitespace"===e[m].type||"ln"===e[m].type;)m--;let x=e.slice(i.length+h.length,m+1);for(let e,t=0;e=x[t];t++){if(u+=0|{"{":1,"}":-1}[e],p+=0|{"[":1,"]":-1}[e],d+=0|{"(":1,")":-1}[e],0===u&&0===p&&-1===d){if(t===x.length-1)return[f,c];break}c.push(e)}return[null,null]},l(e,t=[]){},o(e,t=[]){return fregex.matchAll(Parse.t(t),e).filter((t=>"."!=e[t.index-1]))},h(expr){let result=[];for(let piece of expr)"this"==piece||"identifier"===piece.type||"number"===piece.type?result.push(piece+""):"string"!==piece.type&&"template"!==piece.type||result.push(eval(piece+""));return result}};Parse.ws=fregex.zeroOrMore(fregex.or({type:"whitespace"},{type:"ln"}));let indexType=[{type:"number"},{type:"hex"},{type:"string"},{type:"template"}];Parse.isLValue=fregex.oneOrMore(fregex.or("this",".","[","]",{type:"identifier"},{type:"number"},{type:"hex"},{type:"string"},{type:"template"},{type:"whitespace"},{type:"ln"}));let terminator=fregex.lookAhead([fregex.or(fregex.end,fregex.not(Parse.ws,"("))]),property=fregex(fregex.or(fregex(Parse.ws,".",Parse.ws,{type:"identifier"}),fregex(Parse.ws,"[",Parse.ws,fregex.or(...indexType),Parse.ws,"]")),terminator);Parse.arg=fregex([{type:"identifier"},Parse.ws,fregex.zeroOrOne(["=",Parse.ws,fregex.or([...indexType,{type:"identifier"},{type:"regex"}])])]),Parse.argList=fregex.zeroOrMore([Parse.arg,fregex.zeroOrMore([Parse.ws,",",Parse.ws,Parse.arg])]);var dontCreateValue={};function delve(e,t,r=dontCreateValue,i=!1){let l=r!==dontCreateValue;if(!e&&!l&&t.length)return;let s=0;for(let n of t){let o=s===t.length-1;if(i&&"object"==typeof(e=e.$removeProxy||e)&&(e.$disableWatch=!0),void 0===e[n]){if(!l)return void delete e.$disableWatch;o||(e[n]=(t[s+1]+"").match(/^\d+$/)?[]:{})}o&&l&&(e[n]=r),i&&delete e.$disableWatch,e=e[n],i&&(e=null!=e?e.$removeProxy||e:null),s++}return e}delve.dontCreateValue=dontCreateValue;var removeProxy=e=>e&&e.$removeProxy||e,Utils={arrayEq(e,t){if(e.length!==t.length)return!1;for(let r=0;e.length>r;r++)if(e[r]!==t[r])return!1;return!0},arrayStartsWith(e,t){for(let r=0;t.length>r;r++)if(e[r]!==t[r])return!1;return!0},u(e,t){for(let r in e)if(r.startsWith(t))return!0;return!1},toString(e){return null==e?"":e+""},watchInput(e,t){let r=e.tagName,i=e.hasAttribute("contenteditable")&&"false"!==e.getAttribute("contenteditable");"TEXTAREA"===r||i||"INPUT"===r&&!["button","color","file","hidden","image","radio","reset","submit"].includes(e.getAttribute("type"))?e.addEventListener("input",(()=>{let r=e.getAttribute("type")||"",l=i?e.innerHTML:e.value;"number"===r||"range"===r?l=parseFloat(l):"datetime-local"===r||"datetime"===r?l=new Date(l):"checkbox"===e.type&&(l=e.checked),t(l)}),!0):e.addEventListener("change",(()=>{let l;l="SELECT"===r&&e.hasAttribute("multiple")?Array.from(e.children).filter((e=>e.selected)).map((e=>e.value)):i?e.innerHTML:e.value,t(l)}),!0)}},csv=e=>JSON.stringify(e).slice(1,-1),isObj=e=>e&&"object"==typeof e,removeProxies=(e,t)=>{if(null==e)return e;if(e.$isProxy&&(e=e.$removeProxy),"object"==typeof e){if(t){if(t.has(e))return e}else t=new WeakSet;t.add(e);for(let r in Object.keys(e)){let i=e[r],l=removeProxies(i,t);if(l!==i)if(Object.getOwnPropertyDescriptor(e,r).writable)e[r]=l;else{let t=watch.objects.get(e);(t?t.p:e)[r]=l}}}return e};{let e=["indexOf","lastIndexOf","includes"],t=["push","pop","splice","shift","sort","reverse","unshift"],r={get(e,t){if("$"===t[0]){if("$removeProxy"===t)return e;if("$isProxy"===t)return!0;if("$trigger"===t)return t=>{let r=WatchUtil.getRoots(e);for(let i of r)for(let r of WatchUtil.getCallbacks(i))r("set",t||[],e);return r}}let r=e[t];if(t===Symbol.iterator)return r;if("function"==typeof r){let r=e.$removeProxy||e,i=r[t];return i.prototype?i:i.bind(r)}if(r&&"object"==typeof r){r=r.$removeProxy||r;let i=WatchUtil.getRoots(e);for(let l of i){let i=WatchUtil.getPaths(l,e);for(let e of i)WatchUtil.addPath(l,[...e,t],r)}return WatchUtil.getProxy(r)}return r},set(e,t,i){let l=e[t];i=removeProxies(i),e[t]=i;let s=r.getWatchedPaths(e,t);for(let e of s){let t=WatchUtil.getCallbacks(e[0]);for(let r of t)r("set",e[1],i,l,e[0])}return!0},getWatchedPaths(e,t){let r=WatchUtil.getRoots(e),i=[];for(let l of r){let r=WatchUtil.getPaths(l,e);for(let e of r){let r=[...e,t];i.push([l,r])}}return i},deleteProperty(e,t){Array.isArray(e)?e.splice(t,1):delete e[t];let r=WatchUtil.getRoots(e);for(let i of r){let r=WatchUtil.getPaths(i,e);for(let e of r){let r=[...e,t];for(let e of WatchUtil.getCallbacks(i))e("set",r)}}return!0}};var WatchUtil={proxies:new WeakMap,roots:new WeakMap,callbacks:new WeakMap,paths:new WeakMap,getProxy(i){let l=WatchUtil.proxies.get(i);if(!l&&(WatchUtil.proxies.set(i,l=new Proxy(i,r)),Array.isArray(i))){for(let t of e)Object.defineProperty(l,t,{enumerable:!1,get:()=>e=>Array.prototype[t].call(i,removeProxy(e))});for(let e of t)Object.defineProperty(l,e,{configurable:!0,enumerable:!1,get:()=>(...t)=>WatchUtil.arrayFunction(i,e,t)})}return l},arrayFunction(e,t,r){let i=e.length,l=0;"push"===t?l=i:"pop"===t?l=i-1:"splice"===t&&(l=0>r[0]?i-r[0]:r[0]);let s=Array.prototype[t].apply(e,r);["splice","shift","sort","reverse","unshift"].includes(t)&&WatchUtil.rebuildArray(e,l,null,null);let n=Array.from(WatchUtil.getRoots(e));for(let f of n){let n=WatchUtil.getPaths(f,e);for(let a of WatchUtil.getCallbacks(f))for(let h of n)if("pop"===t)a("remove",[...h,l+""],s,null,f);else if("shift"===t)a("remove",[...h,"0"],s,null,f);else if("unshift"===t)a("insert",[...h,"0"],e[0],null,f);else if("splice"===t){let t=r[1],i=r.length-2,n=Math.min(i,t);for(o=0;n>o;o++)a("set",[...h,l+o+""],e[l+o],null,f);if(i>t)for(o=n;i>o;o++)a("insert",[...h,l+o+""],e[l+o],null,f);else if(t>i)for(o=t-1;o>=n;o--)a("remove",[...h,l+o+""],s[o-n+1],null,f)}else{for(var o=l;e.length>o;o++)a("set",[...h,o+""],e[o],null,f);for(;i>o;o++)a("delete",[...h,o+""],null,f)}}return s},rebuildArray(e,t,r,i){if(r=r||[],void 0===t&&(t=0),!(i=i||new WeakSet).has(e)){if(i.add(e),r.length){let t=WatchUtil.roots.get(e);if(!t)return;for(let i of t){let t=WatchUtil.getPaths(i,e);for(let l in t){let s=t[l],n=s.length-r.length;if(n>=0){let o=s.slice();for(let e=n;s.length>e;e++)o[e]=r[e-n];let f=i;for(let e of o)if(f=f[e],!f)break;f===e&&(t[l]=o)}}}}if(Array.isArray(e))for(let l=t;e.length>l;l++)(Array.isArray(e[l])||isObj(e[l]))&&WatchUtil.rebuildArray(e[l],0,[...r,l+""],i);else if(isObj(e))for(let t in e)(Array.isArray(e[t])||isObj(e[t]))&&WatchUtil.rebuildArray(e[t],0,[...r,t+""],i)}},getRoots(e){return WatchUtil.roots.get(e=e.$removeProxy||e)||[]},addPath(e,t,r){e=e.$removeProxy||e;let i=WatchUtil.roots.get(r=r.$removeProxy||r);i||WatchUtil.roots.set(r,i=new Set),i.add(e);let l=WatchUtil.paths.get(e);l||WatchUtil.paths.set(e,l=new WeakMap);let s=l.get(r);if(s){for(let e of s){let r=e.length;if(r>t.length)continue;let i=!1;for(let l=0;r>l&&!(i=e[l]!==t[l]);l++);if(!i)return}s.push(t)}else l.set(r,[t])},getPaths(e,t){let r=WatchUtil.paths.get(e);return r&&r.get(t.$removeProxy||t)||[]},addCallback(e,t){let r=WatchUtil.callbacks.get(e=e.$removeProxy||e);r||WatchUtil.callbacks.set(e,r=[]),r.push(t)},getCallbacks(e){return WatchUtil.callbacks.get(e=e.$removeProxy||e)||[]}},watchProxy=(e,t)=>(WatchUtil.addPath(e,[],e),WatchUtil.addCallback(e,t),WatchUtil.getProxy(e))}class WatchProperties{constructor(e){this.m=e,this.p={},this.g=watchProxy(this.p,this.v.bind(this)),this.P={}}v(e,t,r,i){let l=[];if("info"===e)return this.P;let s=csv(t),n=t.slice(0,-1);for(;n.length;){let s=csv(n);if(s in this.P)for(let n of this.P[s])l.push([n,[e,t,r,i,this.m]]);n.pop()}if(s in this.P)for(let n of this.P[s])l.push([n,[e,t,r,i,this.m]]);let o=delve(this.m,t,delve.dontCreateValue,!0);for(let t in this.P)if(t.startsWith(s)&&t.length>s.length){let r=t.slice(s.length>0?s.length+1:s.length),n=JSON.parse("["+r+"]"),f=removeProxy(delve(i,n,delve.dontCreateValue,!0)),a=removeProxy(delve(o,n,delve.dontCreateValue,!0));if(f!==a){let r=this.P[t];if(r.length){let i=JSON.parse("["+t+"]");for(let t of r)l.push([t,[e,i,a,f,this.m]])}}}for(let e of l)e[0].apply(this.m,e[1])}W(e,t){e.startsWith&&(e=[e]);let r=this,i=e[0];i in r.p||(r.p[i]=r.m[i],delete r.m[i],Object.defineProperty(r.m,i,{enumerable:1,configurable:1,get:()=>r.m.$disableWatch?r.p[i]:r.g[i],set(e){r.m.$disableWatch?r.g.$removeProxy[i]=e:r.g[i]=e}})),delve(this.p,e,void 0);let l=csv(e);l in r.P||(r.P[l]=[]),r.P[l].push(t)}U(e,t){e.startsWith&&(e=[e]);let r=csv(e);if(r in this.P){if(t){let e=this.P[r].indexOf(t);this.P[r].splice(e,1)}if(!t||!this.P[r].length){delete this.P[r];let t=csv([e[0]]);if(!Utils.u(this.P,t)){delete this.m[e[0]],this.m[e[0]]=this.p[e[0]];let t=WatchUtil.roots.get(this.p[e[0]]);t&&(t.delete(this.p),t.size||WatchUtil.roots.delete(this.p[e[0]])),delete this.p[e[0]],Object.keys(this.p).length||(WatchUtil.paths.delete(this.p),WatchUtil.roots.delete(this.p),WatchUtil.roots.delete(this.m[e[0]])),Object.keys(this.m).length||(WatchUtil.paths.delete(this.m),WatchUtil.roots.delete(this.m))}}}}}var Watch={objects:new WeakMap,add(e,t,r){e=removeProxy(e);var i=Watch.objects.get(e);i||Watch.objects.set(e,i=new WatchProperties(e)),i.W(t,r)},remove(e,t,r){e=removeProxy(e);var i=Watch.objects.get(e);if(i){if(t)i.U(t,r);else for(let e in i.P)i.U(e);Object.keys(i.P).length||Watch.objects.delete(e)}},cleanup(){Watch.objects=new WeakMap}},div=document.createElement("div"),decodeCache={},Html={decode(e){return e?e.replace(/&[#A-Z0-9]+;/gi,(e=>decodeCache[e]||(div.innerHTML=e,decodeCache[e]=div.textContent))):""},encode(e,t=""){return e=Utils.toString(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\a0/g,"&nbsp;"),t.includes("'")&&(e=e.replace(/'/g,"&apos;")),t.includes('"')&&(e=e.replace(/"/g,"&quot;")),e}};class VText{text="";el=null;startIndex=0;constructor(e=""){null==e?e="":"string"==typeof e||e instanceof String||(e=JSON.stringify(e)),this.text=Html.decode(e)}apply(e=null,t=null){return t?this.el=t:(this.el?this.el.textContent=this.text:(this.el=document.createTextNode(this.text),e.insertBefore(this.el,e.childNodes[this.startIndex])),Refract.elsCreated&&Refract.elsCreated.push(Utils.toString(this.text))),1}clone(){let e=new VText;return e.text=this.text,e}remove(){this.el.parentNode.removeChild(this.el)}}class VExpression{watchPaths=[];attrName=null;type="simple";isHash=!1;exec=null;loopParamNames=[];loopItemEls=[];xel=null;parent=null;vParent=null;vChildren=[];scope={};startIndex=0;childCount=0;watches=[];constructor(){}apply(e=null,t=null){this.parent=e||this.parent;for(let e of this.vChildren)for(let t of e.slice())t.remove();this.vChildren=this.evaluateToVElements();let r=0,i=this.startIndex;for(let e of this.vChildren)for(let t of e){t.startIndex=i;let e=t.apply(this.parent,null);i+=e,r+=e}return r}clone(e=null,t=null,r=null){let i=new VExpression;return i.watchPaths=this.watchPaths,i.attrName=this.attrName,i.type=this.type,i.exec=this.exec,i.loopParamNames=this.loopParamNames,i.loopItemEls=this.loopItemEls,i.xel=e||this.xel,i.parent=r||this.parent,i.vParent=t||this.vParent,i.startIndex=this.startIndex,i.childCount=this.childCount,i.scope={...this.scope},i.isHash=this.isHash,i.code=this.code,i}evaluate(){return this.exec.apply(this.xel,Object.values(this.scope))}evaluateToVElements(){for(let e of this.watches)Watch.remove(...e);this.watches=[],this.receiveNotificationBindThis||(this.receiveNotificationBindThis=this.V.bind(this)),this.watch(this.receiveNotificationBindThis);let e=[];if("loop"!==this.type){let t=[this.evaluate()].flat().map((e=>void 0===e?"":e));if(this.isHash)e=[t.map((e=>new VText(e)))];else for(let r of t)if(r+="",r.length){let t=VElement.fromHtml(r,Object.keys(this.scope),this).flat();e.push(t)}}else{let t=this.evaluate(),r=0;for(let i of t){let i=[];for(let e of this.loopItemEls){let l=e.clone(this.xel,this);l.scope={...this.scope};let s=[t[r],r,t];for(let e in this.loopParamNames)l.scope[this.loopParamNames[e]]=s[e];i.push(l)}e.push(i),r++}}return e}V(e,t,r,i,l){if("loop"!==this.type||!Utils.arrayStartsWith(t.slice(0,-2),this.watchPaths[0].slice(1))){if(this.childCount=this.getAllChildrenLength(),"complex"!==this.type&&t[t.length-1].match(/^\d+$/)){let r=t.slice(0,-1),i=delve(l,r);if(Array.isArray(i)&&Utils.arrayEq(this.watchPaths[0].slice(1),r)){let r=parseInt(t[t.length-1]);if("remove"===e){for(let e of this.vChildren[r])e.remove();this.vChildren.splice(r,1)}else{if("set"===e&&this.vChildren[r])for(let e of this.vChildren[r])e.remove();"insert"===e&&this.vChildren.splice(r,0,[]),this.vChildren[r]="simple"===this.type?[new VText(i[r])]:this.loopItemEls.map((e=>e.clone(this.xel,this)));let t=0,l=this.j(r);for(let e of this.vChildren[r]){e.startIndex=l+t,e.scope={...this.scope};let s=[i[r],r,i];for(let t in this.loopParamNames)e.scope[this.loopParamNames[t]]=s[t];e.apply(this.parent,null),t++}}return void this.$()}}this.apply(),this.$()}}remove(){for(let e of this.watches)Watch.remove(...e);this.watches=[];for(let e of this.vChildren)for(let t of e)t.remove();if(this.vParent instanceof VElement){let e=this.vParent.vChildren.indexOf(this);this.vParent.vChildren.splice(e,1)}else for(let e of this.vParent.vChildren){let t=e.indexOf(this);if(t>=0)return void e.splice(t,1)}}getAllChildrenLength(){let e=0;for(let t of this.vChildren)for(let r of t)r.V?e+=r.getAllChildrenLength():e++;return e}j(e){let t=this.startIndex;for(let r of this.vChildren.slice(0,e))for(let e of r)e instanceof VExpression?t+=e.getAllChildrenLength():t++;return t}O(){let e=this.vParent.vChildren.flat(),t=e.indexOf(this);for(let r of e.slice(t+1))if(r instanceof VExpression)return r;return this.vParent.parent===this.parent&&this.vParent instanceof VExpression?this.vParent.O():null}$(){let e=this.getAllChildrenLength()-this.childCount,t=this;for(;t=t.O();)t.startIndex+=e}watch(e){for(let t of this.watchPaths){let r=this.xel;"this"===t[0]?t=t.slice(1):t[0]in this.scope&&(r=this.scope[t[0]],t=t.slice(1)),("object"==typeof r||Array.isArray(r))&&(this.watches.push([r,t,e]),Watch.add(r,t,e))}}static fromTokens(e,t,r,i){let l=new VExpression;l.vParent=r,r&&(l.xel=r.xel,l.scope={...r.scope}),l.attrName=i,t=(t||[]).slice(),l.code=e.slice(1,-1).join("");let s="#{"==e[0];"${"!=e[0]&&!s||"}"!=e[e.length-1]||(l.isHash=s,e=e.slice(1,-1));let n=Parse.o(e,t),[o,f]=Parse.i(e,t),a=r&&r.xel&&r.xel.constructor||window.RefractCurrentClass;if(f){l.type="loop",l.loopParamNames=o;for(let e of o)t.push(e);l.exec=a.createFunction(...t,"return "+n[0].join(""));let e=f.filter((e=>"whitespace"!==e.type&&"ln"!==e.type));l.loopItemEls=1===e.length&&"template"===e[0].type?VElement.fromTokens(e[0].tokens.slice(1,-1),t,r):[VExpression.fromTokens(f,t,r)]}else{Parse.t(t)(e)!==e.length&&(l.type=Parse.isLValue(e)===e.length?"simple":"complex"),e=Parse.replaceHashExpr(e,null,a.name);let r=(e=Parse.escape$(e)).join("");"{"!=e[0]&&(r="return ("+r.trim()+")"),l.exec=a.createFunction(...t,r)}for(let e of n)l.watchPaths.push(Parse.h(e));return l}}lexHtmlJs.allowHashTemplates=!0;class VElement{tagName="";attributes={};attributeExpressions=[];xel=null;el=null;vParent=null;vChildren=[];scope={};startIndex=0;constructor(e,t){this.tagName=e||"",this.attributes=t||{}}apply(e=null,t=null){let r=this.tagName;"svg"===r&&(Refract.inSvg=!0);var i=this.el;if(t)this.el=t,t.querySelector("slot")||(this.xel.slotHtml=t.innerHTML),t.innerHTML="";else{var l;if(r.includes("-")&&customElements.get(r)){let e=customElements.get(r),t=[];e.constructorArgs&&(t=e.constructorArgs.map((e=>{if(e in this.attributes){let t=this.attributes[e];if(t&&1===t.length&&t[0]instanceof VExpression)return t[0].exec.apply(this.xel,Object.values(this.scope));if(Array.isArray(t)&&!t.length)return!0;let r=VElement.evalVAttributeAsString(this,t||[],this.scope);try{r=JSON.parse(r)}catch(e){}return r}}))),l=new e(...t)}else l=Refract.inSvg?document.createElementNS("http://www.w3.org/2000/svg",r):document.createElement(r);if(i)i.parentNode.insertBefore(l,i),i.remove();else if(!i){let t=e.shadowRoot||e;t!==this.xel&&t.tagName&&t.tagName.includes("-")&&"SLOT"!==l.tagName&&(t=t.querySelector("slot")||t),t.insertBefore(l,t.childNodes[this.startIndex])}this.el=l,Refract.elsCreated&&Refract.elsCreated.push("<"+r+">")}let s="value"in this.attributes&&"option"!==r;for(let e in this.attributes){let t=this.attributes[e];for(let r of t)if(r instanceof VExpression){let i=r;i.parent=this.el,i.scope=this.scope,i.watch((()=>{if("value"===e)setInputValue(this.xel,this.el,t,this.scope,f||o);else{let r=VElement.evalVAttributeAsString(this.xel,t,this.scope);this.el.setAttribute(e,r)}}))}if(VElement.setVAttribute(this.xel,this.el,e,t,this.scope),"id"===e||"data-id"===e)this.xel[this.el.getAttribute(e)]=this.el;else if(e.startsWith("on")&&e in div){let t=(this.xel&&this.xel.constructor||window.RefractCurrentClass).createFunction;this.el[e]=r=>{let i=["event","el",...Object.keys(this.scope)],l=this.el.getAttribute(e);t(...i,l).bind(this.xel)(r,this.el,...Object.values(this.scope))}}else"shadow"!==e||this.el.shadowRoot||this.el.attachShadow({mode:this.el.getAttribute("shadow")||"open"})}if(s){let e=this.attributes.value;if(1===e.length&&e[0]&&"simple"===e[0].type){let t=(0,(this.xel&&this.xel.constructor||window.RefractCurrentClass).createFunction)(...Object.keys(this.scope),"val",e[0].code+"=val;").bind(this.xel);Utils.watchInput(this.el,(e=>{t(...Object.values(this.scope),e)}))}}let n=0;if("slot"===r){let e=VElement.fromHtml(this.xel.slotHtml,Object.keys(this.scope),this);for(let t of e)t.scope={...this.scope},t.startIndex=n,window.inSlot=!0,n+=t.apply(this.el),window.inSlot=!1}for(let e of this.vChildren)e.scope={...this.scope},e.startIndex=n,n+=e.apply(this.el);let o=this.el.hasAttribute("contenteditable")&&"false"!==this.el.getAttribute("contenteditable"),f="textarea"===r;return s&&setInputValue(this.xel,this.el,this.attributes.value,this.scope,f||o),"svg"===r&&(Refract.inSvg=!1),1}clone(e,t){let r=new VElement(this.tagName);r.xel=e||this.xel;for(let e in this.attributes){r.attributes[e]=[];for(let t of this.attributes[e])r.attributes[e].push(t instanceof VExpression?t.clone(r.xel,this):t)}for(let e of this.attributeExpressions)r.attributeExpressions.push(e.clone(r.xel,this));for(let e of this.vChildren)r.vChildren.push(e.clone(r.xel,r));return r}remove(){for(let e of this.vChildren)e.remove();this.el.parentNode.removeChild(this.el)}static evalVAttribute(e,t,r={}){let i=t.map((t=>t instanceof VExpression?t.exec.apply(e,Object.values(r)):t));return 1===i.length?i[0]:i.flat().map(Utils.toString).join("")}static evalVAttributeAsString(e,t,r={}){let i=[];for(let l of t)if(l instanceof VExpression){let t=l.exec.apply(e,Object.values(r));Array.isArray(t)||t instanceof Set?t=Array.from(t).join(" "):t&&"object"==typeof t&&(t=Object.entries(t).map((([e,r])=>`${e}: ${t[e]}; `)).join("")),i.push(t)}else i.push(Refract.htmlDecode(l));return i.map(Utils.toString).join("")}static setVAttribute(e,t,r,i,l={}){let s=VElement.evalVAttributeAsString(e,i,l);t.setAttribute(r,s)}static fromHtml(e,t=[],r=null){let i=lex(lexHtmlJs,[e].flat().join(""),"template");return VElement.fromTokens(i,t,r)}static fromTokens(e,t=[],r=null,i=!1,l=0){if(!e.length)return[];let s=[];do{let n=e[l];if("text"===n.type)s.push(new VText(n));else if("expr"===n.type)s.push(VExpression.fromTokens(n.tokens,t,r));else if("openTag"===n.type){let i=new VElement;i.vParent=r,i.xel=r?.xel,r&&(i.scope={...r.scope});let o="",f=n.tokens.filter((e=>"whitespace"!==e.type));for(let e,l=0;e=f[l];l++)if(0===l)i.tagName=e.slice(1);else if("attribute"===e.type)o=e,i.attributes[o]=[];else if(o&&"="==f[l-1]){let l=[];if("string"===e.type)for(let i of e.tokens.slice(1,-1))l.push("expr"===i.type?VExpression.fromTokens(i.tokens,t,r,o):i+"");else"expr"===e.type&&l.push(VExpression.fromTokens(e.tokens,t,r,o));i.attributes[o]=l,o=void 0}else"expr"===e.type&&i.attributeExpressions.push(VExpression.fromTokens(e.tokens,t,r));"/>"==f[f.length-1]||["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr","command","keygen","menuitem"].includes(i.tagName)||(l++,i.vChildren=VElement.fromTokens(e,t,i,!1,l),l=i.vChildren.index),s.push(i)}else if("closeTag"===n.type)break;if(s.length===i)break;l++}while(e.length>l);return s.index=l,s}}function setInputValue(e,t,r,i,l){if(l||"INPUT"===t.tagName){let s=VElement.evalVAttributeAsString(e,r,i);l?t.innerHTML=s:"checkbox"===t.type?t.checked=["1","true"].includes((s+"").toLowerCase()):t.value=s}else{let l=VElement.evalVAttribute(e,r,i);if("SELECT"===t.tagName)for(let e of t.children)e.selected=Array.isArray(l)?l.includes(e.value):l===e.value;else t.value=l}}let cache={},divCache=new WeakMap,templateCache=new WeakMap;function createEl(e,t=!0,r=document){if(t&&(e=e.trim()),e.match(/^<\S+-\S+/)){let t=divCache.get(r);return t||divCache.set(r,t=r.createElement("div")),t.innerHTML=e,t.removeChild(t.firstChild)}let i=cache[e];if(i)return i.cloneNode(!0);let l=templateCache.get(r);return l||templateCache.set(r,l=r.createElement("template")),l.innerHTML=e,l.content.querySelector("slot")||(cache[e]=l.content.firstChild.cloneNode(!0)),l.content.removeChild(l.content.firstChild)}lexHtmlJs.allowHashTemplates=!0;class Refract extends HTMLElement{static virtualElement;static constructorArgs=[];static elsCreated=!1;static inSvg=!1;slotHtml="";constructor(e={}){super();for(let t in e)this[t]=e[t]}static preCompile(e){let t={};t.self=e,t.constructorArgs=[];let r=lex(lexHtmlJs,""+e);r=function e(t){let r=[];for(let i of t)"comment"!==i.type&&r.push(i),i.tokens&&(i.tokens=e(i.tokens));return r}(r);let i=0,l=0;{let e=0;for(let t,s=0;(t=r[s])&&("{"==t?e++:"}"==t?e--:1===e&&(i||"html"!=t?l||"constructor"!=t||(l=s):i=s),!i||!l);s++);let s=fregex.matchFirst(["html",Parse.ws,"=",Parse.ws,{type:"template"},Parse.ws,fregex.zeroOrOne(";")],r,i),n=r.splice(s.index,s.length).filter((e=>e.tokens))[0].tokens.slice(1,-1);"text"!==n[0].type||n[0].trim().length||(n=n.slice(1)),t.virtualElement=VElement.fromTokens(n,[],null,1)[0]}{let e,i,s=fregex.matchFirst(["constructor",Parse.ws,"("],r,l);if(s){let l=r.slice(s.index+s.length,Parse.findGroupEnd(r,s.index+s.length));t.constructorArgs=Parse.filterArgNames(l);let n=fregex.matchFirst(["super",Parse.ws,"("],r,s.index+s.length+l.length),o=Parse.findGroupEnd(r,n.index+n.length)+1;o+=fregex(Parse.ws,";")(r.slice(o));let f=n.index;n=r.slice(n.index,o),n.index=f,e=n.index+n.length,i=["//Begin Refract injected code.",...t.constructorArgs.map((e=>[`if (this.hasAttribute('${e}')) {`,`   ${e} = this.getAttribute('${e}');`,`   try { ${e} = JSON.parse(${e}) } catch(e) {};`,"}"])).flat(),"if (!this.virtualElement) {","\tthis.virtualElement = this.constructor.virtualElement.clone(this);","\tthis.virtualElement.apply(null, this);","}","//End Refract injected code."].join("\r\n\t\t\t")}else e=fregex.matchFirst(["{"],r).index+1,i="//Begin Refract injected code.\r\n\t\tconstructor() {\r\n\t\t\tsuper();\r\n\t\t\tif (!this.virtualElement) {\r\n\t\t\t\tthis.virtualElement = this.constructor.virtualElement.clone(this);\r\n\t\t\t\tthis.virtualElement.apply(null, this);\r\n\t\t\t}\r\n\t\t}\r\n\t\t//End Refract injected code.";r.splice(e,0,"\r\n\t\t\t"+i),t.code=r.join("")}return t}static decorate(e,t){e.constructorArgs=t.constructorArgs,e.virtualElement=t.virtualElement;for(let r of Object.getOwnPropertyNames(t.self.prototype))"constructor"!==r&&(e.prototype[r]=t.self.prototype[r]);for(let r of Object.getOwnPropertyNames(t.self))r in Refract||(e[r]=t.self[r]);customElements.define(e.virtualElement.tagName.toLowerCase(),e)}static onMount(e,t){new MutationObserver((r=>{(r[0].addedNodes[0]===e||document.body.contains(e))&&t()})).observe(document.body,{childList:!0,subtree:!0})}static onFirstMount(e,t){function r(e,t){for(;t=t.parentNode||t.host;)if(t===e)return!0;return!1}if(r(document,e))t();else{let i=new MutationObserver((l=>{(l[0].addedNodes[0]===e||r(document,e))&&(i.disconnect(),t())}));i.observe(document.body,{childList:!0,subtree:!0})}}static compile(){return`\n\t\t\t(() => {\n\t\t\t\twindow.RefractCurrentClass = ${this.name};\n\t\t\t\t${this.name}.createFunction = (...args) => {\n\t\t\t\t\tlet params = args.slice(0, -1).join(',');\n\t\t\t\t\tlet code = args[args.length-1];\n\t\t\t\t\treturn eval(\`(function(\${params}) {\${code}})\`);\n\t\t\t\t};\n\t\t\t\tlet compiled = ${this.name}.preCompile(${this.name});\n\t\t\t\t${this.name} = eval('('+compiled.code+')');\t\t\n\t\t\t\t${this.name}.decorate(${this.name}, compiled);\n\t\t\t\tdelete window.RefractCurrentClass;\n\t\t\t\treturn ${this.name};\t\n\t\t\t})();\t\t\n\t\t`}}Refract.htmlDecode=Html.decode,Refract.htmlEncode=Html.encode;export default Refract;export{Watch,delve,fregex,lex,lexHtmlJs};