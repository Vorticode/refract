// Version 2023.1.12.2304
// License: MIT
// https://github.com/vorticode/Refract
var descendIf=(t,e,r=null)=>i=>{if(t instanceof RegExp){let l=i.match(t)||[];if(l.length)return r&&r(l),[l[0],e]}else if(i.startsWith(t))return r&&r(t),[t,e]},ascendIf=t=>e=>{if(t instanceof RegExp){let r=e.match(t)||[];if(r.length)return[r[0],-1]}else if(e.startsWith(t))return[t,-1]};{let t=["indexOf","lastIndexOf","includes"],e=["push","pop","splice","shift","sort","reverse","unshift"],r={get(t,e){if("$"===e[0]){if("$removeProxy"===e)return t;if("$isProxy"===e)return!0;if("$trigger"===e)return e=>{let r=WatchUtil.getRoots(t);for(let i of r)for(let r of WatchUtil.getCallbacks(i))r("set",e||[],t);return r}}let r=t[e];if(e===Symbol.iterator)return r;if("function"==typeof r){let r=t.$removeProxy||t,i=r[e];return i.prototype?i:i.bind(r)}if(r&&"object"==typeof r){r=r.$removeProxy||r;let i=WatchUtil.getRoots(t);for(let l of i){let i=WatchUtil.getPaths(l,t);for(let t of i)WatchUtil.addPath(l,[...t,e],r)}return WatchUtil.getProxy(r)}return r},set(t,e,i){let l=t[e];if(l===(i=removeProxies(i)))return!0;t[e]=i;let s=r.getWatchedPaths(t,e);for(let t of s){let e=WatchUtil.getCallbacks(t[0]);for(let r of e)r("set",t[1],i,l,t[0])}return!0},getWatchedPaths(t,e){let r=WatchUtil.getRoots(t),i=[];for(let l of r){let r=WatchUtil.getPaths(l,t);for(let t of r){let r=[...t,e];i.push([l,r])}}return i},deleteProperty(t,e){Array.isArray(t)?t.splice(e,1):delete t[e];let r=WatchUtil.getRoots(t);for(let i of r){let r=WatchUtil.getPaths(i,t);for(let t of r){let r=[...t,e];for(let t of WatchUtil.getCallbacks(i))t("set",r)}}return!0}};var WatchUtil={proxies:new WeakMap,roots:new WeakMap,callbacks:new WeakMap,paths:new WeakMap,getProxy(i){let l=WatchUtil.proxies.get(i);if(!l&&(WatchUtil.proxies.set(i,l=new Proxy(i,r)),Array.isArray(i))){for(let e of t)Object.defineProperty(l,e,{enumerable:!1,get:()=>t=>Array.prototype[e].call(i,utils.removeProxy(t))});for(let t of e)Object.defineProperty(l,t,{configurable:!0,enumerable:!1,get:()=>(...e)=>WatchUtil.arrayFunction(i,t,e)})}return l},arrayFunction(t,e,r){let i=t.length,l=0;"push"===e?l=i:"pop"===e?l=i-1:"splice"===e&&(l=0>r[0]?i-r[0]:r[0]);let s=Array.prototype[e].apply(t,r);["splice","shift","sort","reverse","unshift"].includes(e)&&WatchUtil.rebuildArray(t,l,null,null);let n=Array.from(WatchUtil.getRoots(t));for(let a of n){let n=WatchUtil.getPaths(a,t);for(let f of WatchUtil.getCallbacks(a))for(let h of n)if("pop"===e)f("remove",[...h,l+""],s,null,a);else if("shift"===e)f("remove",[...h,"0"],s,null,a);else if("unshift"===e)f("insert",[...h,"0"],t[0],null,a);else if("splice"===e){let e=r[1],i=r.length-2,n=Math.min(i,e);for(o=0;n>o;o++)f("set",[...h,l+o+""],t[l+o],null,a);if(i>e)for(o=n;i>o;o++)f("insert",[...h,l+o+""],t[l+o],null,a);else if(e>i)for(o=e-1;o>=n;o--)f("remove",[...h,l+o+""],s[o-n+1],null,a)}else{for(var o=l;t.length>o;o++)f("set",[...h,o+""],t[o],null,a);for(;i>o;o++)f("delete",[...h,o+""],null,a)}}return s},rebuildArray(t,e,r,i){if(r=r||[],void 0===e&&(e=0),!(i=i||new WeakSet).has(t)){if(i.add(t),r.length){let e=WatchUtil.roots.get(t);if(!e)return;for(let i of e){let e=WatchUtil.getPaths(i,t);for(let l in e){let s=e[l],n=s.length-r.length;if(n>=0){let o=s.slice();for(let t=n;s.length>t;t++)o[t]=r[t-n];let a=i;for(let t of o)if(a=a[t],!a)break;a===t&&(e[l]=o)}}}}if(Array.isArray(t))for(let l=e;t.length>l;l++)(Array.isArray(t[l])||isObj(t[l]))&&WatchUtil.rebuildArray(t[l],0,[...r,l+""],i);else if(isObj(t))for(let e in t)(Array.isArray(t[e])||isObj(t[e]))&&WatchUtil.rebuildArray(t[e],0,[...r,e+""],i)}},getRoots(t){return WatchUtil.roots.get(t=t.$removeProxy||t)||[]},addPath(t,e,r){t=t.$removeProxy||t;let i=WatchUtil.roots.get(r=r.$removeProxy||r);i||WatchUtil.roots.set(r,i=new Set),i.add(t);let l=WatchUtil.paths.get(t);l||WatchUtil.paths.set(t,l=new WeakMap);let s=l.get(r);if(s){for(let t of s){let r=t.length;if(r>e.length)continue;let i=!1;for(let l=0;r>l&&!(i=t[l]!==e[l]);l++);if(!i)return}s.push(e)}else l.set(r,[e])},getPaths(t,e){let r=WatchUtil.paths.get(t);return r&&r.get(e.$removeProxy||e)||[]},addCallback(t,e){let r=WatchUtil.callbacks.get(t=t.$removeProxy||t);r||WatchUtil.callbacks.set(t,r=[]),r.push(e)},getCallbacks(t){return WatchUtil.callbacks.get(t=t.$removeProxy||t)||[]}},watchProxy=(t,e)=>(WatchUtil.addPath(t,[],t),WatchUtil.addCallback(t,e),WatchUtil.getProxy(t))}var dontCreateValue={};function delve(t,e,r=dontCreateValue,i=!1){let l=r!==dontCreateValue;if(!t&&!l&&e.length)return;let s=0;for(let n of e){let o=s===e.length-1;if(i&&"object"==typeof(t=t.$removeProxy||t)&&(t.$disableWatch=!0),void 0===t[n]){if(!l)return void delete t.$disableWatch;o||(t[n]=(e[s+1]+"").match(/^\d+$/)?[]:{})}o&&l&&(t[n]=r),i&&delete t.$disableWatch,t=t[n],i&&(t=null!=t?t.$removeProxy||t:null),s++}return t}delve.dontCreateValue=dontCreateValue;class WatchProperties{constructor(t){this.t=t,this.i={},this.l=watchProxy(this.i,this.o.bind(this)),this.h={}}o(t,e,r,i){if("info"===t)return this.h;let l=this.getAllCallbacks(e,t,r,i);for(let[t,e]of l)t.apply(this.t,e)}getAllCallbacks(t,e,r,i){let l=[],s=csv(t),n=t.slice(0,-1);for(;n.length;){let s=csv(n);if(s in this.h)for(let n of this.h[s])l.push([n,[e,t,r,i,this.t]]);n.pop()}if(s in this.h)for(let n of this.h[s])l.push([n,[e,t,r,i,this.t]]);let o=delve(this.t,t,delve.dontCreateValue,!0);for(let t in this.h)if(t.startsWith(s)&&t.length>s.length){let r=t.slice(s.length>0?s.length+1:s.length),n=JSON.parse("["+r+"]"),a=utils.removeProxy(delve(i,n,delve.dontCreateValue,!0)),f=utils.removeProxy(delve(o,n,delve.dontCreateValue,!0));if(a!==f){let r=this.h[t];if(r.length){let i=JSON.parse("["+t+"]");for(let t of r)l.push([t,[e,i,f,a,this.t]])}}}return l}u(t,e){t.startsWith&&(t=[t]);let r=this,i=t[0];i in r.i||(r.i[i]=r.t[i],delete r.t[i],Object.defineProperty(r.t,i,{enumerable:1,configurable:1,get:()=>r.t.$disableWatch?r.i[i]:r.l[i],set(t){r.t.$disableWatch?r.l.$removeProxy[i]=t:r.l[i]=t}}));let l=csv(t);l in r.h||(r.h[l]=[]),r.h[l].push(e)}m(t,e){t.startsWith&&(t=[t]);let r=csv(t);if(r in this.h){if(e){let t=this.h[r].indexOf(e);this.h[r].splice(t,1)}if(!e||!this.h[r].length){delete this.h[r];let e=csv([t[0]]);if(!utils.p(this.h,e)){delete this.t[t[0]],this.t[t[0]]=this.i[t[0]];let e=WatchUtil.roots.get(this.i[t[0]]);e&&(e.delete(this.i),e.size||WatchUtil.roots.delete(this.i[t[0]])),delete this.i[t[0]],Object.keys(this.i).length||(WatchUtil.paths.delete(this.i),WatchUtil.roots.delete(this.i),WatchUtil.roots.delete(this.t[t[0]])),Object.keys(this.t).length||(WatchUtil.paths.delete(this.t),WatchUtil.roots.delete(this.t))}}}}}var Watch={objects:new WeakMap,add(t,e,r){assert(e.length),t=removeProxy(t);var i=Watch.objects.get(t);i||Watch.objects.set(t,i=new WatchProperties(t)),i.u(e,r)},remove(t,e,r){t=removeProxy(t);var i=Watch.objects.get(t);if(i){if(e)i.m(e,r);else for(let t in i.h)i.m(t);Object.keys(i.h).length||Watch.objects.delete(t)}},cleanup(){Watch.objects=new WeakMap}},removeProxy=t=>t&&t.$removeProxy||t,assert=t=>{if(!t)throw Error("Assertion failed")},utils={g(t,e,r){"string"==typeof e&&(e=[e]);var i=e.length;for(let l=r=r||0;t.length>l;l++)for(let r=0;i>r;r++){let i=e[r];if(t.slice(l,l+i.length)===i)return t.slice(l)}return t},removeProxy(t){return t&&t.$removeProxy||t},arrayEq(t,e){if(t.length!==e.length)return!1;for(let r=0;t.length>r;r++)if(t[r]!==e[r])return!1;return!0},v(t,e){for(let r=0;e.length>r;r++)if(t[r]!==e[r])return!1;return!0},p(t,e){for(let r in t)if(r.startsWith(e))return!0;return!1},toString(t){return null==t?"":t+""},unescapeTemplate(t){return t.replace(/\\r/g,"\r").replace(/\\n/g,"\n").replace(/\\t/g,"\t")},k(t,e){let r=t.tagName,i=t.hasAttribute("contenteditable")&&"false"!==t.getAttribute("contenteditable");"TEXTAREA"===r||i||"INPUT"===r&&!["button","color","file","hidden","image","radio","reset","submit"].includes(t.getAttribute("type"))?t.addEventListener("input",(r=>{let l=t.getAttribute("type")||"",s=i?t.innerHTML:t.value;"number"===l||"range"===l?s=parseFloat(s):"datetime-local"===l||"datetime"===l?s=new Date(s):"checkbox"===t.type&&(s=t.checked),e(s,r)}),!0):t.addEventListener("change",(l=>{let s;s="SELECT"===r&&t.hasAttribute("multiple")?Array.from(t.children).filter((t=>t.selected)).map((t=>t.value)):i?t.innerHTML:t.value,e(s,l)}),!0)}},csv=t=>JSON.stringify(t).slice(1,-1),isObj=t=>t&&"object"==typeof t,removeProxies=(t,e)=>{if(null==t)return t;if(t.$isProxy&&(t=t.$removeProxy),"object"==typeof t){if(e){if(e.has(t))return t}else e=new WeakSet;e.add(t);for(let r in Object.keys(t)){let i=t[r],l=removeProxies(i,e);if(l!==i)if(Object.getOwnPropertyDescriptor(t,r).writable)t[r]=l;else{let e=Watch.objects.get(t);(e?e.i:t)[r]=l}}}return t};{let t=null,e=0,r=[],i=0,l=/^[ \t\v\f\xa0]+/,s=/^\r?\n/,n=/^<!?([\w\xA0-\uFFFF:-]+)/i,o=/^<\/[\w\xA0-\uFFFF:-]+\s*>/i,a="&& || ! => <<= >>= &= ^= |= &&= ||= & | ^ ~ >>> << >> === !=== == != >= > <= < = **= += -= *= /= %= ??= ++ -- ** + - * / % , ... . ( ) [ ] ?. ? :".split(/ /g),f={};for(let t of a)f[t[0]]=[...f[t[0]]||[],t];let h=t=>{if("{"===t[1])return lexHtmlJs.allowHashTemplates&&t.startsWith("#{")||t.startsWith("${")?(i>0||(i=1),r.push(e),e=0,[t.slice(0,2),"js"]):void 0},c=t=>{if("`"===t[0])return--i,e=r.pop(),["`",-1]},u={attribute:/^[\-_$\w\xA0-\uFFFF:]+/i,string:t=>descendIf("'","squote")(t)||descendIf('"',"dquote")(t),equals:"=",tagEnd:t=>">"===t[0]?[">",-1]:t.startsWith("/>")?["/>",-1]:void 0,unknown:t=>lexHtmlJs.allowUnknownTagTokens?t.match(/^\w+|\S/)||[]:void 0},m=(e,r,i)=>{let l=i[i.length-1];if("script"===t&&l&&l.tokens&&">"==l.tokens[l.tokens.length-1])return["","js"]},p="await break case catch class constructor const continue debugger default delete do enum else export extends\n\t\t\t\tfinally for function if implements import in instanceof interface let new package private protected public\n\t\t\t\treturn static super switch this throw try typeof var void while with yield".split(/\s+/g),d="{ ( [ . ; , < > <= >= == != === !== + - * % << >> >>> & | ^ ! ~ && || ? : = += -= *= %= <<= >>= >>>= &= |= ^= /=".split(/ /g);var lexHtmlJs={js:{whitespace:l,ln:s,comment:/^\/\/.*(?=\r?\n)|^\/\*[\s\S]*?\*\//,end:t=>t.startsWith("<\/script>")?["",-1]:void 0,regex(t,e,r){if("/"!==t[0])return;if(r.length){let t;for(let e=r.length-1;e>=0;e--)if("ln"!==r[e].type&&"whitespace"!==r[e].type&&"comment"!==r[e].type){t=r[e]+"";break}if(!d.includes(t))return}let i=1;for(;;){if(i=t.indexOf("/",i+1),-1===i)return;try{let e=t.slice(0,i+1);return RegExp(e.slice(1,-1)),[e+t.slice(e.length).match(/^[agimsx]*/)[0]]}catch(t){}}},hex:/^0x[0-9a-f]+/,number:/^\d*\.?\d+(e\d+)?/,identifier(t){let e=(t.match(/^[_$a-z\xA0-\uFFFF][_$\w\xA0-\uFFFF]*/i)||[])[0];if(!p.includes(e))return[e]},template(t){if("`"===t[0])return++i,r.push(e),e=0,["`","template"]},brace1(t){if("{"===t[0])return e++,["{"]},brace2(t){if("}"===t[0])return 0===e&&i?(e=r.pop(),["}",-1]):(e--,["}"])},semicolon:";",keyword:p,operator:a,string:/^"(\\\\|\\"|[^"])*"|^'(\\\\|\\'|[^'])*'/},html:{script:m,comment:descendIf("\x3c!--","htmlComment"),closeTag:o,openTag:descendIf(n,"tag",(e=>t=e[1])),text:/^[\s\S]+?(?=<|$)/},htmlComment:{commentEnd:ascendIf("--\x3e"),commentBody:/^[\s\S]+?(?=-->|$)/},template:{script:m,expr:h,comment:descendIf("\x3c!--","templateComment"),closeTag:o,openTag:descendIf(n,"templateTag",(e=>t=e[1])),templateEnd:c,text(t){let e=t.match(lexHtmlJs.allowHashTemplates?/^(?:\\#{|\\\${|\s|(?!(#{|\${|`|<[\w\xA0-\uFFFF!:/-]|$)).)+/:/^(?:\\\${|\s|(?!(\${|`|<[\w\xA0-\uFFFF!:/-]|$)).)+/);if(e){let t=e[0];return t=utils.unescapeTemplate(t),[t,void 0,e[0].length]}}},templateComment:{expr:h,commentEnd:ascendIf("--\x3e"),commentBody:t=>t.match(lexHtmlJs.allowHashTemplates?/^[\s\S]+?(?=-->|[$#]{|$)/:/^[\s\S]+?(?=-->|\${|$)/)||[]},tag:{whitespace:/^[ \r\n\t\v\f\xa0]+/,...u},templateTag:{whitespace(t){let e=t.match(/^( |\r|\n|\t|\v|\f|\xa0|\\r|\\n|\\t|\\v|\\f|\\xa0)+/);if(e){let t=e[0];return t=utils.unescapeTemplate(t),[t,void 0,e[0].length]}},expr:h,templateEnd:c,...u},squote:{expr:h,quote:ascendIf("'"),text:t=>t.match(lexHtmlJs.allowHashTemplates?/^(?:\\'|(?!'|#{|\${)[\S\s])+/:/^(?:\\'|(?!'|#{)[\S\s])+/)||[]},dquote:{expr:h,quote:ascendIf('"'),text:t=>t.match(lexHtmlJs.allowHashTemplates?/^(?:\\"|(?!"|#{|\${)[\S\s])+/:/^(?:\\"|(?!"|#{)[\S\s])+/)||[]},allowHashTemplates:!1,allowUnknownTagTokens:!1};for(let t in lexHtmlJs)for(let e in lexHtmlJs[t]){let r=lexHtmlJs[t][e];if(Array.isArray(r)){let i={};for(let t of r)i[t[0]]=[...i[t[0]]||[],t];lexHtmlJs[t][e]=t=>{let e=i[t[0]];if(e)for(let r of e)if(t.startsWith(r))return[r]}}else"string"==typeof r?lexHtmlJs[t][e]=t=>[t.startsWith(r)?r:void 0]:r instanceof RegExp&&(lexHtmlJs[t][e]=t=>[(t.match(r)||[])[0]])}function expandFastMatch(t){for(let e in t)if(t[e].length||expandFastMatch(t[e]),e.length>1){let r=e;if(e.includes("a-z")){for(let e of"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ")t[e]=t[r];e=e.replace("a-z","")}if(e.includes("0-9")){for(let e of"0123456789")t[e]=t[r];e=e.replace("0-9","")}if(e.length>1)for(let i of e)t[i]=t[r];delete t[r]}Object.freeze(t)}lexHtmlJs.fastMatch={html:{"<":{"/":[lexHtmlJs.html,"closeTag"],"a-z0-9":[lexHtmlJs.html,"openTag"],"!":[lexHtmlJs.html,"comment"]},"a-z0-9 \t\r\n":[lexHtmlJs.html,"text"]},tag:{"a-z0-9":[lexHtmlJs.tag,"attribute"]," \t\r\n":[lexHtmlJs.tag,"whitespace"],'"':[lexHtmlJs.tag,"string"],"'":[lexHtmlJs.tag,"string"],">":[lexHtmlJs.tag,"tagEnd"],"/":{">":[lexHtmlJs.tag,"tagEnd"]},"=":[lexHtmlJs.tag,"equals"]},dquote:{'"':[lexHtmlJs.dquote,"quote"],"a-z0-9 \t.()[]/":[lexHtmlJs.dquote,"text"],"$#":[lexHtmlJs.dquote,"expr"]},js:{" \t\v\f ":[lexHtmlJs.js,"whitespace"],"=&|^!+-*%,.()[]?!>:":[lexHtmlJs.js,"operator"],"\r\n":[lexHtmlJs.js,"ln"],";":[lexHtmlJs.js,"semicolon"],"/":{"/*":[lexHtmlJs.js,"comment"]},"{":[lexHtmlJs.js,"brace1"],"}":[lexHtmlJs.js,"brace2"],P:[lexHtmlJs.js,"identifier"],"0-9":[lexHtmlJs.js,"number"],"'\"":[lexHtmlJs.js,"string"],"`":[lexHtmlJs.js,"template"]},template:{"`":[lexHtmlJs.template,"templateEnd"],"$#":[lexHtmlJs.template,"expr"],"<":{"a-z":[lexHtmlJs.template,"openTag"],"/":[lexHtmlJs.template,"closeTag"],"!":[lexHtmlJs.template,"comment"]}},templateTag:{$:[lexHtmlJs.templateTag,"expr"]},templateComment:{"-":[lexHtmlJs.templateComment,"commentEnd"],"a-z0-9\t\r\n ":[lexHtmlJs.templateComment,"commentBody"]}},lexHtmlJs.fastMatch.templateTag=lexHtmlJs.fastMatch.tag;for(let t in lexHtmlJs.fastMatch)expandFastMatch(lexHtmlJs.fastMatch[t]);Object.freeze(lexHtmlJs.fastMatch)}function fregex(...t){return t=prepare(t),e=>{let r=0;for(let i of t){let t=i(e.slice(r));if(!1===t)return!1;r+=t}return r}}fregex.or=(...t)=>(t=prepare(t),e=>{for(let r of t){let t=r(e);if(!1!==t)return t}return!1}),fregex.not=(...t)=>{let e=fregex(t);return t=>!1===e(t)&&0},fregex.nor=(...t)=>(t=prepare(t),e=>{for(let r of t)if(r(e)>0)return!1;return 1}),fregex.zeroOrOne=(...t)=>{let e=fregex(t);return t=>{let r=e(t);return!1===r?0:r}},fregex.xOrMore=(t,...e)=>{let r=fregex(e);return e=>{let i=0;for(let l=0;e.length;l++){let s=r(e);if(!1===s)return l>=t&&i;i+=s||1,e=e.slice(s||1)}return i}},fregex.zeroOrMore=(...t)=>fregex.xOrMore(0,...t),fregex.oneOrMore=(...t)=>fregex.xOrMore(1,...t),fregex.matchFirst=(t,e,r=0)=>{let i=fregex.matchAll(t,e,1,r);return i.length?i[0]:null},fregex.matchAll=(t,e,r=1/0,i=0)=>{Array.isArray(t)&&(t=fregex(t));let l=[];for(let s=i;e.length>s&&r>l.length;s++){let r=t(e.slice(s));!1!==r&&l.push(Object.assign(e.slice(s,s+r),{index:s}))}return l},fregex.lookAhead=(...t)=>(t=prepare(t),e=>{for(let r of t)if(!1===r(e))return!1;return 0}),fregex.end=t=>!t.length&&0;var prepare=t=>{Array.isArray(t[0])&&1===t.length&&(t=t[0]);let e=[];for(let r in t){let i=t[r];e[r]="string"==typeof i?t=>t[0]==i:Array.isArray(i)?fregex(i):"object"!=typeof i||i.prototype?t[r]:t=>{for(let e in i)if(t[0][e]!=i[e])return!1;return 1}}return e};function findFastMatch(t,e,r){let i,l=t.fastMatch[e];if(l){let t=0;do{if(l=l[r[t]],l&&l.length){[l,i]=l,l=l[i];break}t++}while(l)}return[l,i]}function valueOf(){return this.text}function toString(){return this.text}class Token{constructor(t,e,r,i,l,s,n){this.text=t,this.type=e,this.mode=r,this.line=i,this.col=l,this.originalLength=s,this.tokens=n}valueOf(){return this.text}toString(){return this.text}}function lex(t,e,r=null,i={},l=1,s=1,n=0){let o;r=r||Object.keys(t)[0];let a="";if(256>(e+="").length){var f=r+"|"+e.slice(0,24);if(o=lexCache[f],o&&o[0]===e)return o[1]}for(o=[];e.length>n;){let f,h,c,u,m,p=e.slice(0,n),d=e.slice(n);if([c,u]=findFastMatch(t,r,d),c&&([f,m,h]=c(d,p,o)||[]),!f){let e=t[r];for(u in e){let t=e[u];if([f,m,h]=t(d,p,o)||[],void 0!==f)break}}if(void 0===f){if(i.failOnUknown){let t=e.slice(Math.max(n-15,0),n),i=d.slice(0,25).replace(/\r/g,"\\r").replace(/\n/g,"\\n");throw Error(`Unknown token within "${r}" at ${l}:${s}\r\n"${t+"⚠️"+i}"`)}a+=e.slice(0,1),e=e.slice(1);continue}a.length&&(f=a,m=!1,a="");let x={text:f,type:u,mode:m&&-1!==m?m:r,line:l,col:s,originalLength:h,valueOf,toString},g=h||f.length;if(-1===m)return[...o,x];if(m){let a=lex(t,e,m,i,l,s+g,n+g);if(!1===a)return o;let h=[x,...a].filter((t=>t.text.length));g=h.reduce(((t,e)=>t+(e.originalLength||e.text.length)),0),x={text:e.slice(n,n+g),type:u,tokens:h,mode:r,line:l,col:s,valueOf,toString},g!==f.length&&(x.originalLength=g)}if(g){if(n+=g,i.callback&&!1===i.callback(x))return o;o.push(x);let t=-1;for(let e=0,r=f.length;r>e;e++)"\n"==f[e]&&(l++,t=e);s=(t>-1?-t:s)+g}}return 256>e.length&&(lexCache[f]=[e,o]),o}var lexCache={};class ParsedFunction{name;type;argsStartIndex;argTokens;bodyStartIndex;bodyTokens;constructor(t,e=!0,r=null){if("function"==typeof t&&(t=""+t),"string"==typeof t){let r;if(!e){let t=0;r=e=>{if("("===e.text?t++:")"===e.text&&t--,0===t&&("{"===e.text||"=>"===e.text))return!1}}t=lex(lexHtmlJs,t,"js",{callback:r})}r=r||(t=>{throw Error(t)});const i=(t,e=0)=>{assert("("===t[e].text);let r=Parse.T(t,e);return null===r?-1:(this.argTokens=t.slice(e+1,r-1),r-1)};if("function"===t[0].text){this.type="function";let e=t.slice(1).findIndex((t=>!["whitespace","ln","comment"].includes(t.type)));if(-1===e)return r("Not enough tokens to be a function.");"identifier"===t[e+1].type&&(this.name=t[e+1].text);let i=t.slice(e+1).findIndex((t=>"("===t.text));if(-1===i)return r("Cannot find opening ( for function arguments.");this.argsStartIndex=e+1+i+1}else if("identifier"===t[0].type){let e=t.findIndex((t=>"operator"===t.type));-1!==e&&"("===t[e]?.text&&(this.type="method",this.name=t[0].text,this.argsStartIndex=e+1)}if(["function","method"].includes(this.type)){let l=i(t,this.argsStartIndex-1);if(-1===l)return r("Cannot find closing ) and end of arguments list.");if(e){let e=t.slice(l).findIndex((t=>"{"===t.text));if(-1===this.bodyStartIndex)return r("Cannot find start of function body.");this.bodyStartIndex=l+e}}if(!this.type){let l,s;if("("===t[0].text){if(this.argsStartIndex=1,s=i(t,0),-1===s)return r("Cannot find ) and end of arguments list.");l="Params"}else s=1,l="Param",this.argTokens=[t[0]];if(e){let e=t.slice(s).findIndex((t=>"=>"===t.text));if(-1===e)return r("Cannot find arrow before function body.");let i=t.slice(s+e+1).findIndex((t=>!["whitespace","ln","comment"].includes(t.type)));if(-1===i)return r("Cannot find function body.");this.bodyStartIndex=s+e+1+i,this.type="{"===t[this.bodyStartIndex]?.text?`arrow${l}Brace`:"arrow"+l}}if(e){let e,i=["arrowParam","arrowParams"].includes(this.type);if(i){const r=["{","(","["],i=["}",")","]"],l=[";",",",...i];let s=!1;for(let n,o=this.bodyStartIndex;n=t[o];o++)if(!["whitespace","comment"].includes(n.type))if(r.includes(n.text))o=Parse.T(t,o,r,i);else{if(l.includes(n.text)){e=o;break}if("operator"===n.type)s=!0;else if(s||"ln"!==n.type)s=!1;else{let r=t.slice(o).find((t=>!["whitespace","ln","comment"].includes(t.type)));if(r){if(l.includes(r)||"operator"!==r.type){e=o;break}}else e=o-1}}}else e=Parse.T(t,this.bodyStartIndex);if(null===e)return r("Cannot find end of function body.");i&&";"===t[e]?.text&&e++,this.bodyTokens=t.slice(this.bodyStartIndex,e)}}*getArgNames(){let t=this.argTokens;if("arrowParam"===this.type)yield t[0].text;else{let e,r,i=[],l=null,s=!0,n=0;for(let o of t){let t=o.text;if("identifier"===o.type&&s?(l=t,e?r&&(r[l]=void 0):e=l):"("==t||"{"==t||"["==t?(n++,s=!0,e||"{"!=t||(e=r={}),l&&(r=r[l]={},i.push(r))):")"==t||"}"==t||"]"==t?(n--,r=i.pop()):","===t?s=!0:":"===t?s=!1:":"!==t&&"="!==t||(s=!1,l=null),0>n)return void(e&&(yield e));","===t&&0===n&&(yield e,e=r=void 0)}e&&(yield e)}}}var Parse={H(t=[]){let e=t.join(",");return varExpressionCache[e]||(varExpressionCache[e]=fregex(fregex.or(fregex("this",Parse.ws,fregex.oneOrMore(property)),...t.map((t=>fregex(t,fregex.zeroOrMore(property))))),terminator))},T(t,e=0,r=["(","{"],i=[")","}"],l=[],s=1){let n=0,o=r.includes(t[e].text);for(let a,f=e;a=t[f];f+=s){let t=a.text||a+"";if(r.includes(t))n+=s;else if(i.includes(t)){if(n-=s,o){if(0===n)return f+1}else if(0>n)return f}else if(!n&&l.includes(t))return f}return null},W(t){let e=[],r=1,i=0;for(let l of t)1!==r||"identifier"!==l.type||i?"("==l||"{"==l||"["==l?i++:")"!=l&&"}"!=l&&"]"!=l||i--:e.push(l+""),i||(r={",":1,"=":-1}[l]||r);return e},J(t,e=0){for(let r,i=e;r=t[i];i++){if("function"==r)return i;if("=>"==r){let e=0;for(let r,l=-1;r=t[i+l];l--)if("whitespace"!==r.type&&"ln"!==r.type&&"comment"!==r.type&&(")"==r?e++:"("==r&&e--,0===e))return i+l}}return null},C(t){let e=t.map((t=>({...t}))),r=this.J(e);for(let t,i=0;t=e[i];i++){if(i===r){let t=new ParsedFunction(e.slice(r));i=r+t.bodyStartIndex+t.bodyTokens.length+1,r=this.J(e,i)}"template"===t.type&&(e[i].text="`"+t.text.slice(1,-1).replace(/\${/g,"\\${").replace(/`/g,"\\`")+"`")}return e},A(t){return t=t.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"").replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*|<!--[\s\S]*?-->$/),t=utils.g(t,"{"),t=utils.g(t,"return"),t=utils.g(t,["`",'"',"'"]),(t=utils.g(t,["<"])).match(/<(\w+-[\w-]+)/)[1]},_(tokens){"string"==typeof tokens&&(tokens=lex(lexHtmlJs,tokens,"js"));let htmlMatch=fregex.matchFirst([fregex.or({type:"template"},{type:"string"}),Parse.ws,fregex.zeroOrOne(";")],tokens);if(!htmlMatch)return null;let template=htmlMatch.filter((t=>t.tokens||"string"===t.type))[0];if(template.tokens)var innerTokens=template.tokens.slice(1,-1);else{let code=eval(template+"");innerTokens=lex(lexHtmlJs,code,"template")}for(;"openTag"!==innerTokens[0].type;)innerTokens=innerTokens.slice(1);return innerTokens},R(t,e,r){let i=[],l=!1;for(let e of t)if(e.tokens){let t=Parse.R(e.tokens,e.mode,r);i.push({text:t.map((t=>t.text)).join(""),type:e.type,tokens:t,mode:e.mode})}else"#{"==e.text&&"expr"==e.type?(i.push(new Token("${"),new Token(r),new Token("."),new Token("htmlEncode"),new Token("(")),l=!0):i.push(e);if(l){let t=[];"squote"===e?t=[new Token(","),new Token('"\'"')]:"dquote"===e&&(t=[new Token(","),new Token("'\"'")]),i.splice(i.length-1,0,...t,new Token(")"))}return i},V(t,e=[]){let r=[Parse.H(e),Parse.ws,".",Parse.ws,"map",Parse.ws,"(",Parse.ws],i=fregex.matchFirst(r,t);if(!i)return[null,null];let l=t.slice(i.length),s=Parse.J(l);if(null===s||0!==s)return[null,null];let n=new ParsedFunction(l.slice(s),!0,(()=>!1));return n&&fregex([Parse.ws,")",Parse.ws,fregex.zeroOrOne(";"),Parse.ws,fregex.end])(t.slice(i.length+n.bodyStartIndex+n.bodyTokens.length))?[[...n.getArgNames()],n.bodyTokens]:[null,null]},j(t,e=[]){},O(t,e=[]){return fregex.matchAll(Parse.H(e),t).filter((e=>"."!=t[e.index-1]&&"?."!=t[e.index-1]))},U(expr){let result=[];for(let piece of expr)"this"==piece||"identifier"===piece.type||"number"===piece.type?result.push(piece+""):"string"!==piece.type&&"template"!==piece.type||result.push(eval(piece+""));return result}};let varExpressionCache={};Parse.ws=fregex.zeroOrMore(fregex.or({type:"whitespace"},{type:"ln"}));let indexType=[{type:"number"},{type:"hex"},{type:"string"},{type:"template"}];Parse.isLValue=fregex.oneOrMore(fregex.or("this",".","[","]",{type:"identifier"},{type:"number"},{type:"hex"},{type:"string"},{type:"template"},{type:"whitespace"},{type:"ln"}));let terminator=fregex.lookAhead([fregex.or(fregex.end,fregex.not(Parse.ws,"("))]),property=fregex(fregex.or(fregex(Parse.ws,fregex.or(".","?."),Parse.ws,{type:"identifier"}),fregex(Parse.ws,fregex.zeroOrOne("?."),"[",Parse.ws,fregex.or(...indexType),Parse.ws,"]")),terminator);Parse.arg=fregex([{type:"identifier"},Parse.ws,fregex.zeroOrOne(["=",Parse.ws,fregex.or([...indexType,{type:"identifier"},{type:"regex"}])])]),Parse.argList=fregex.zeroOrMore([Parse.arg,fregex.zeroOrMore([Parse.ws,",",Parse.ws,Parse.arg])]);var div=document.createElement("div"),decodeCache={},Html={decode(t){return t?t.replace(/&[#A-Z0-9]+;/gi,(t=>decodeCache[t]||(div.innerHTML=t,decodeCache[t]=div.textContent))):""},encode(t,e=""){return t=utils.toString(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\a0/g,"&nbsp;"),e.includes("'")&&(t=t.replace(/'/g,"&apos;")),e.includes('"')&&(t=t.replace(/"/g,"&quot;")),t}};class VText{text="";el=null;refl=null;startIndex=0;constructor(t="",e=null){this.refl=e,null==t?t="":"string"==typeof t||t instanceof String||(t=JSON.stringify(t)),this.text=Html.decode(t)}F(t=null,e=null){if(e)this.el=e;else{let e;if("STYLE"!==t.tagName||this.refl.contains(t.getRootNode()?.host))e=this.text;else{this.refl.dataset.style||(this.refl.constructor.styleId=(this.refl.constructor.styleId||0)+1,this.refl.dataset.style=this.refl.constructor.styleId);let t=this.refl.tagName.toLowerCase();e=VText.styleReplace(this.text,t,this.refl.dataset.style)}this.el?this.el.textContent=e:(this.el=t.ownerDocument.createTextNode(e),(t=t.shadowRoot||t).insertBefore(this.el,t.childNodes[this.startIndex])),Refract.elsCreated&&Refract.elsCreated.push(utils.toString(e))}return 1}clone(){let t=new VText;return t.text=this.text,t.refl=this.refl,t}remove(){this.el.parentNode.removeChild(this.el)}static styleReplace(t,e,r){return t.replace(RegExp(e+"|:host","g"),e+'[data-style="'+r+'"]')}}class VExpression{watchPaths=[];attrName=null;attributes=null;type="simple";isHash=!1;exec=null;loopParamNames=[];loopItemEls=[];refl=null;parent=null;vParent=null;vChildren=[];scope={};scope2={};startIndex=0;childCount=0;watches=[];constructor(t,e){t&&(this.refl=t.refl)}F(t=null,e=null){if(this.parent=t||this.parent,this.attributes){for(let e of this.attributes)t.removeAttribute(e);this.attributes=[];let e=this.evaluate();if(e){let r=lex(lexHtmlJs,e,"tag"),i=null;for(let e of r)"attribute"===e.type?(i&&t.setAttribute(i,""),i=e,this.attributes.push(i)):"string"===e.type&&(t.setAttribute(i,e.tokens[1]),i=null);i&&t.setAttribute(i,"")}return 0}{for(let t of this.vChildren)if(t instanceof HTMLElement)t.parentNode.removeChild(t);else for(let e of t.slice())e.remove();this.vChildren=this.evaluateToVElements();let t=0,e=this.startIndex;for(let r of this.vChildren)if(r instanceof HTMLElement)this.parent.insertBefore(r,this.parent.childNodes[e]),e++;else for(let i of r){i.startIndex=e;let r=i.F(this.parent,null);e+=r,t+=r}return t}}clone(t=null,e=null,r=null){let i=new VExpression;return i.watchPaths=this.watchPaths,i.attrName=this.attrName,i.attributes=this.attributes,i.type=this.type,i.exec=this.exec,i.loopParamNames=this.loopParamNames,i.loopItemEls=this.loopItemEls,i.refl=t||this.refl,i.parent=r||this.parent,i.vParent=e||this.vParent,i.startIndex=this.startIndex,i.childCount=this.childCount,i.scope={...this.scope},i.scope2={...this.scope2},i.isHash=this.isHash,i.code=this.code,i}evaluate(){return this.exec.apply(this.refl,Object.values(this.scope))}evaluateToVElements(){for(let t of this.watches)Watch.remove(...t);this.watches=[],this.receiveNotificationBindThis||(this.receiveNotificationBindThis=this.S.bind(this)),this.watch(this.receiveNotificationBindThis);let t=[];if("loop"!==this.type){let e=[this.evaluate()].flat().map((t=>void 0===t?"":t));if(this.isHash)t=[e.map((t=>new VText(t,this.refl)))];else{let r=Object.keys(this.scope);for(let i of e)if(i instanceof HTMLElement)t.push(i);else if(i+="",i.length){let e=VElement.fromHtml(i,r,this,this.refl.constructor).flat();t.push(e)}}}else{let e=this.evaluate();if(!e)throw Error(`${this.watchPaths[0].join(".")} is not iterable in ${this.code}`);let r=0;for(let i of e){let i=[],l=[e[r],r,e];for(let t of this.loopItemEls){let e=t.clone(this.refl,this);e.scope={...this.scope},e.scope2={...this.scope2};let s=this.loopParamNames.length;for(let t=0;s>t;t++){e.scope[this.loopParamNames[t]]=l[t];let i=[...this.watchPaths[0],r+""],s=this.getFullPath(i);e.scope2[this.loopParamNames[t]]=[l[t],s]}i.push(e)}t.push(i),r++}}return t}getFullPath(t){if("this"===t[0])return t;for(;t[0]in this.scope2;)t=[...this.scope2[t[0]][1],...t.slice(1)];return t}S(t,e,r,i,l){if(this.vParent&&(Refract.currentVElement=this,"loop"!==this.type||!utils.v(e.slice(0,-2),this.watchPaths[0].slice(1))))if(this.refl.__autoRender||!this.refl.virtualElement){if(this.childCount=this.getAllChildrenLength(),"complex"!==this.type&&e[e.length-1].match(/^\d+$/)){let r=e.slice(0,-1),i=delve(l,r);if(Array.isArray(i)&&utils.arrayEq(this.watchPaths[0].slice(1),r)){let r=parseInt(e[e.length-1]);if("remove"===t){for(let t of this.vChildren[r])t.remove();this.vChildren.splice(r,1)}else{if("set"===t&&this.vChildren[r])for(let t of this.vChildren[r])t.remove();"insert"===t&&this.vChildren.splice(r,0,[]),this.vChildren[r]="simple"===this.type?[new VText(i[r],this.refl)]:this.loopItemEls.map((t=>t.clone(this.refl,this)));let e=0,l=this.I(r);for(let t of this.vChildren[r]){t.startIndex=l+e,t.scope={...this.scope},t.scope2={...this.scope2},t.parent=this.parent;let s=[i[r],r,i];for(let r in this.loopParamNames){t.scope[this.loopParamNames[r]]=s[r];let i=[...this.watchPaths[0],e+""];t.scope2[this.loopParamNames[r]]=[s[r],this.getFullPath(i)]}t.F(this.parent,null),e++}}return void this.M()}}this.F(),this.M(),Refract.currentVElement=null}else this.refl.__toRender.set(this,arguments)}remove(){for(let t of this.watches)Watch.remove(...t);this.watches=[];for(let t of this.vChildren)if(t instanceof HTMLElement)t.parentNode.removeChild(t);else for(let e of t)e.remove();if(this.vChildren=[],this.vParent instanceof VElement){let t=this.vParent.vChildren.indexOf(this);this.vParent.vChildren.splice(t,1)}else for(let t of this.vParent.vChildren){let e=t.indexOf(this);if(e>=0){t.splice(e,1);break}}this.vParent=null}getAllChildrenLength(){let t=0;for(let e of this.vChildren)if(e instanceof HTMLElement)t++;else for(let r of e)r.S?t+=r.getAllChildrenLength():t++;return t}I(t){let e=this.startIndex;for(let r of this.vChildren.slice(0,t))for(let t of r)t instanceof VExpression?e+=t.getAllChildrenLength():e++;return e}N(){let t=this.vParent.vChildren.flat(),e=t.indexOf(this);for(let r of t.slice(e+1))if(r instanceof VExpression)return r;return this.vParent.parent===this.parent&&this.vParent instanceof VExpression?this.vParent.N():null}M(){let t=this.getAllChildrenLength()-this.childCount,e=this;for(;e=e.N();)e.startIndex+=t}watch(t){for(let e of this.watchPaths){let r=this.refl;if("this"===e[0])e=e.slice(1);else if(e.length&&e[0]in this.scope&&e[0]in this.scope)if(e.length>1)r=this.scope[e[0]],e=e.slice(1);else if(e[0]in this.scope2){let t=this.scope2[e[0]][1];r=delve(this.refl,t.slice(1,-1)),e=t.slice(-1)}("object"==typeof r||Array.isArray(r))&&e.length&&(this.watches.push([r,e,t]),Watch.add(r,e,t))}}static fromTokens(t,e,r,i,l){let s=new VExpression;s.vParent=r,r&&(s.refl=r.refl,s.scope={...r.scope},s.scope2={...r.scope2}),s.attrName=l,e=(e||[]).slice();let n="#{"==t[0].text;"${"!=t[0].text&&!n||"}"!=t[t.length-1].text||(s.isHash=n,t=t.slice(1,-1)),s.code=t.map((t=>t.text)).join("").trim();let o=Parse.O(t,e),[a,f]=Parse.V(t,e);if(f){s.type="loop",s.loopParamNames=a;for(let t of a)e.push(t);s.exec=i.createFunction(...e,"return "+o[0].join(""));let t=f.filter((t=>"whitespace"!==t.type&&"ln"!==t.type));s.loopItemEls=1===t.length&&"template"===t[0].type?VElement.fromTokens(t[0].tokens.slice(1,-1),e,r,i):[VExpression.fromTokens(f,e,r,i)]}else{Parse.H(e)(t)!==t.length&&(s.type=Parse.isLValue(t)===t.length?"simple":"complex"),t=Parse.R(t,null,i.name);let r=(t=Parse.C(t)).map((t=>t.text)).join("");"{"!=t[0].text&&(r="return ("+r.trim()+")"),s.exec=i.createFunction(...e,r)}for(let t of o)s.watchPaths.push(Parse.U(t));return s}}lexHtmlJs.allowHashTemplates=!0;class VElement{tagName="";attributes={};attributeExpressions=[];refl=null;el=null;vParent=null;vChildren=[];scope={};startIndex=0;constructor(t=null,e=null){this.tagName=t||"",this.attributes=e||{}}F(t=null,e=null){t=t||this.parent;let r=this.tagName;"svg"===r&&(inSvg=!0);var i=this.el;if(e)this.el=e,e.querySelector("slot")||(this.refl.slotHtml=e.innerHTML),e.innerHTML="";else{var l;if(Refract.currentVElement=this,r.includes("-")&&customElements.get(r)){let t=customElements.get(r),e=[];t.constructorArgs?e=t.constructorArgs.map((t=>this.getAttrib(t))):t.prototype.init&&(e=Refract.compiler.populateArgsFromAttribs(this,t.getInitArgs()));let i=2,n=r;for(;n.toUpperCase()in Refract.constructing;){n=r+"_"+i;var s=customElements.get(n);if(s){t=s;break}t=class extends t{},customElements.define(n,t),i++}l=new t(...e)}else l=inSvg?document.createElementNS("http://www.w3.org/2000/svg",r):document.createElement(r);if(i)i.parentNode.insertBefore(l,i),i.remove();else if(!i){let e=t.shadowRoot||t;e!==this.refl&&e.tagName&&e.tagName.includes("-")&&"SLOT"!==l.tagName&&(e=e.querySelector("slot")||e),e.insertBefore(l,e.childNodes[this.startIndex])}Refract.virtualElements.set(l,this),this.el=l,Refract.currentVElement=null,Refract.elsCreated&&Refract.elsCreated.push("<"+r+">")}!this.el.shadowRoot&&"shadow"in this.attributes&&this.el.attachShadow({mode:this.el.getAttribute("shadow")||"open"});let n=0;if("slot"===r){let t=VElement.fromHtml(this.refl.slotHtml,Object.keys(this.scope),this,this.refl.constructor);for(let e of t)e.scope={...this.scope},e.startIndex=n,n+=e.F(this.el)}let o="TEXTAREA"===this.el.tagName||this.attributes.contenteditable&&this.attributes.contenteditable+""!="false";for(let t of this.vChildren){if(o&&t instanceof VExpression)throw Error("textarea and contenteditable can't have templates as children. Use value=${this.variable} instead.");t.scope={...this.scope},t.refl=this.refl,t.startIndex=n,n+=t.F(this.el)}for(let t in this.attributes){let e=this.attributes[t];for(let r of e)if(r instanceof VExpression){let i=r;i.parent=this.el,i.scope=this.scope,i.watch((()=>{if("value"===t)setInputValue(this.refl,this.el,e,this.scope);else{let r=VElement.evalVAttributeAsString(this.refl,e,this.scope);this.el.setAttribute(t,r)}}))}let r=VElement.evalVAttributeAsString(this.refl,e,this.scope);if(this.el.setAttribute(t,r),"id"===t||"data-id"===t){let e=this.el.getAttribute(t).split(".");delve(this.refl,e,this.el)}else if(t.startsWith("on")&&t in div){let e=(this.refl&&this.refl.constructor||window.RefractCurrentClass).createFunction,r=this.el.getAttribute(t);this.el.removeAttribute(t),this.el[t]=t=>{let i=["event","el",...Object.keys(this.scope)];e(...i,r).bind(this.refl)(t,this.el,...Object.values(this.scope))}}}for(let t of this.attributeExpressions)t.scope=this.scope,t.F(this.el),t.watch((()=>{t.F(this.el)}));let a="value"in this.attributes&&"option"!==r;if(a){let t=this.attributes.value;if(1===t.length&&t[0]instanceof VExpression&&"simple"===t[0].type){let e=(0,(this.refl&&this.refl.constructor||window.RefractCurrentClass).createFunction)(...Object.keys(this.scope),"val",t[0].code+"=val;").bind(this.refl);utils.k(this.el,((t,r)=>{Refract.currentEvent=r,e(...Object.values(this.scope),t),Refract.currentEvent=null}))}}return a&&setInputValue(this.refl,this.el,this.attributes.value,this.scope),"svg"===r&&(inSvg=!1),1}clone(t,e=null){let r=new VElement(this.tagName);r.refl=t||this.refl,r.vParent=e;for(let t in this.attributes){r.attributes[t]=[];for(let e of this.attributes[t])r.attributes[t].push(e instanceof VExpression?e.clone(r.refl,this):e)}for(let t of this.attributeExpressions)r.attributeExpressions.push(t.clone(r.refl,this));for(let t of this.vChildren)r.vChildren.push(t.clone(r.refl,r));return r}getAttrib(name){let lname=name.toLowerCase(),val=name in this.attributes?this.attributes[name]:this.attributes[lname];if(null==val)return val;if(val&&1===val.length&&val[0]instanceof VExpression)return val[0].exec.apply(this.refl,Object.values(this.scope));if(Array.isArray(val)&&!val.length)return!0;let result=VElement.evalVAttributeAsString(this.refl,val||[],this.scope);try{result=JSON.parse(result)}catch(e){if(result.startsWith("${")&&result.endsWith("}"))try{result=eval(result.slice(2,-1))}catch(t){}}return result}remove(){for(let t of this.vChildren)t.remove();this.el.parentNode.removeChild(this.el),this.vParent=null}static evalVAttribute(t,e,r={}){let i=e.map((e=>e instanceof VExpression?e.exec.apply(t,Object.values(r)):e));return 1===i.length?i[0]:i.flat().map(utils.toString).join("")}static evalVAttributeAsString(t,e,r={}){let i=[];for(let l of e)if(l instanceof VExpression){let e=l.exec.apply(t,Object.values(r));Array.isArray(e)||e instanceof Set?e=Array.from(e).join(" "):e&&"object"==typeof e&&(e=e.constructor===Object?Object.entries(e).map((([t,r])=>`${t}: ${e[t]}; `)).join(""):""),i.push(e)}else i.push(Html.decode(l));return i.map(utils.toString).join("")}static fromHtml(t,e=[],r=null,i){let l=lex(lexHtmlJs,[t].flat().join(""),"template");return VElement.fromTokens(l,e,r,i)}static fromTokens(t,e=[],r=null,i,l=!1,s=0){if(!t.length)return[];let n=[];do{let o=t[s];if("text"===o.type)n.push(new VText(o.text,r?.refl));else if("expr"===o.type)n.push(VExpression.fromTokens(o.tokens,e,r,i));else if("openTag"===o.type){let l=new VElement;l.vParent=r,l.refl=r?.refl,r&&(l.scope={...r.scope});let a="",f=o.tokens.filter((t=>"whitespace"!==t.type));for(let t,s=0;t=f[s];s++)if(0===s)l.tagName=t.text.slice(1);else if("attribute"===t.type)a=t.text,l.attributes[a]=[];else if(a&&"="==f[s-1]){let s=[];if("string"===t.type)for(let l of t.tokens.slice(1,-1))s.push("expr"===l.type?VExpression.fromTokens(l.tokens,e,r,i,a):l.text);else"expr"===t.type&&s.push(VExpression.fromTokens(t.tokens,e,r,i,a));l.attributes[a]=s,a=void 0}else if("expr"===t.type){let s=VExpression.fromTokens(t.tokens,e,r,i);s.attributes=[],l.attributeExpressions.push(s)}"/>"==f[f.length-1].text||l.tagName.toLowerCase()in selfClosingTags||(s++,l.vChildren=VElement.fromTokens(t,e,l,i,!1,s),s=l.vChildren.index),n.push(l)}else if("closeTag"===o.type)break;if(n.length===l)break;s++}while(t.length>s);return n.index=s,n}}var selfClosingTags={area:1,base:1,br:1,col:1,embed:1,hr:1,img:1,input:1,link:1,meta:1,param:1,source:1,track:1,wbr:1,command:1,keygen:1,menuitem:1},inSvg=!1;function setInputValue(t,e,r,i){if(Refract.currentEvent&&e===Refract.currentEvent.target)return;let l="TEXTAREA"===e.tagName||e.hasAttribute("contenteditable")&&"false"!==e.getAttribute("contenteditable");if(l||"INPUT"===e.tagName){let s=VElement.evalVAttributeAsString(t,r,i);l?e.innerHTML=s:"checkbox"===e.type?e.checked=["1","true"].includes((s+"").toLowerCase()):e.value=s}else{let l=VElement.evalVAttribute(t,r,i);if("SELECT"===e.tagName)for(let t of e.children)t.selected=Array.isArray(l)?l.includes(t.value):l===t.value;else e.value=l}}let cache=new Map,divCache=new WeakMap,templateCache=new WeakMap;function createEl(t,e=!0,r=document){if(e&&(t=t.trim()),t.match(/^<\S+-\S+/)){let e=divCache.get(r);return e||divCache.set(r,e=r.createElement("div")),e.innerHTML=t,e.removeChild(e.firstChild)}let i=cache.get(t);if(i)return i.cloneNode(!0);let l=templateCache.get(r);return l||templateCache.set(r,l=r.createElement("template")),l.innerHTML=t,l.content.querySelector("slot")||cache.set(t,l.content.firstChild.cloneNode(!0)),l.content.removeChild(l.content.firstChild)}class Compiler{static createModifiedClass(self){let result={};result.originalClass=self;let preInitCode="\n\t\t\t__preInit = (() => {\n\t\t\t\n\t\t\t\tif ('autoRender' in this)\n\t\t\t\t\tthis.__autoRender = this.autoRender;\n\t\t\t\telse if (!('__autoRender' in this))\n\t\t\t\t\tthis.__autoRender = true;\n\t\t\t\t\n\t\t\t\tif (Object.getOwnPropertyDescriptor(this, 'autoRender')?.configurable !== false)\n\t\t\t\t\tObject.defineProperty(this, 'autoRender', {\n\t\t\t\t\t\tget() {\n\t\t\t\t\t\t\treturn this.__autoRender\n\t\t\t\t\t\t},\n\t\t\t\t\t\tset(val) {\n\t\t\t\t\t\t\tthis.__autoRender = val;\n\t\t\t\t\t\t\tif (val)\n\t\t\t\t\t\t\t\tthis.render();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\n\t\t\t\tif (this.__autoRender)\n\t\t\t\t\tthis.render();\n\t\t\t\t\n\t\t\t\tif (this.init) {\n\t\t\t\t\tlet args = this.parentElement\n\t\t\t\t\t\t? Refract.compiler.populateArgsFromAttribs(this, this.constructor.getInitArgs())\n\t\t\t\t\t\t: this.constructorArgs2;\n\t\t\t\t\tthis.init(...args);\n\t\t\t\t}\n\t\t\t})();";if(self.prototype.html)result.tagName=Parse.A(""+self.prototype.html),result.code=(""+self).slice(0,-1)+preInitCode+"}";else{function removeComments(t){let e=[];for(let r of t)"comment"!==r.type&&e.push(r),r.tokens&&(r.tokens=removeComments(r.tokens));return e}let code=""+self,tokens=[...lex(lexHtmlJs,code)];tokens=removeComments(tokens);let htmlIdx=0,constructorIdx=0;{let t=fregex.matchFirst(["constructor",Parse.ws,"("],tokens,constructorIdx);if(t){let e=tokens.slice(t.index+t.length,Parse.T(tokens,t.index+t.length));result.constructorArgs=Parse.W(e);let r=fregex.matchFirst(["super",Parse.ws,"("],tokens,t.index+t.length+e.length),i=Parse.T(tokens,r.index+r.length)+1,l=fregex(Parse.ws,";")(tokens.slice(i));i+=l;let s=r.index;if(r=tokens.slice(r.index,i),r.index=s,!r)throw Error(`Class ${self.name} constructor() { ... } is missing call to super().`);let n=r.index+r.length,o=tokens[n],a=[","==o?",":";","(()=>{",...result.constructorArgs.map((t=>[`\t${t} = this.getAttrib('${t}', ${t});`])),"})()"],f="\r\n\t\t"+["//Begin Refract injected code.",...a,"//End Refract injected code."].join("\r\n\t\t")+"\r\n";tokens.splice(n,0,f)}}{let braceDepth=0,i=0;for(let t of tokens){if("{"===t.text||"("===t.text?braceDepth++:"}"===t.text||")"===t.text?braceDepth--:1===braceDepth&&(htmlIdx||"html"!=t.text?constructorIdx||"constructor"!=t.text||(constructorIdx=i):htmlIdx=i),htmlIdx&&constructorIdx)break;i++}let htmlMatch=fregex.matchFirst(["html",Parse.ws,"=",Parse.ws,fregex.or({type:"template"},{type:"string"}),Parse.ws,fregex.zeroOrOne(";")],tokens,htmlIdx);if(!htmlMatch&&!self.prototype.html)throw Error(`Class ${self.name} is missing an html property with a template value.`);let htmlAssign=tokens.splice(htmlMatch.index,htmlMatch.length),template=htmlAssign.filter((t=>t.tokens||"string"===t.type))[0];if(template.tokens)var innerTokens=template.tokens.slice(1,-1);else{let code=eval(template+"");innerTokens=lex(lexHtmlJs,code,"template")}"text"!==innerTokens[0].type||utils.unescapeTemplate(innerTokens[0].text).trim().length||(innerTokens=innerTokens.slice(1)),result.htmlTokens=innerTokens;for(let t of innerTokens)if("openTag"===t.type){result.tagName=t.tokens[0].text.slice(1);break}}let lastBrace=null;for(let t=tokens.length-1;;t--)if("}"===tokens[t].text){lastBrace=t;break}tokens.splice(lastBrace,0,preInitCode),result.code=tokens.join("")}return result}static decorateAndRegister(t,e){t.tagName=e.tagName,t.constructorArgs=e.constructorArgs,t.htmlTokens=e.htmlTokens;for(let r of Object.getOwnPropertyNames(e.originalClass.prototype))"constructor"!==r&&(t.prototype[r]=e.originalClass.prototype[r]);for(let r of Object.getOwnPropertyNames(e.originalClass))r in Refract||(t[r]=e.originalClass[r]);customElements.define(e.tagName,t)}static populateArgsFromAttribs(t,e){const r=e=>{for(let i in e)e[i]?r(e[i]):e[i]=t.getAttrib(i);return e};let i=[];for(let l of e)i.push("string"==typeof l?t.getAttrib(l):r(l));return i}}lexHtmlJs.allowHashTemplates=!0;class Refract extends HTMLElement{static compiler=Compiler;static tagName;static constructing={};static htmlTokens=null;static virtualElement;static currentVElement=null;static constructorArgs=null;static initArgs=null;static virtualElements=new WeakMap;static elsCreated=!1;static currentEvent;slotHtml="";__autoRender=!0;__toRender=new Map;virtualElement=null;__connected=!1;__connectedCallbacks=[];__firstConnectedCallbacks=[];__disconnectedCallbacks=[];constructor(t=!0){super(),!1===t&&(this.__autoRender=!1),this.constructorArgs2=arguments}render(){if(this.__autoRender=!0,!this.virtualElement){if(!this.constructor.virtualElement){if(this.html&&"function"==typeof this.html&&(this.constructor.htmlTokens=Parse._(""+this.html),!this.constructor.htmlTokens))throw Error("Class is missing an html function with a template value.");this.constructor.virtualElement=VElement.fromTokens(this.constructor.htmlTokens,[],null,this.constructor,1)[0],this.constructor.htmlTokens=null}Refract.constructing[this.tagName]=!0,this.virtualElement=this.constructor.virtualElement.clone(this),this.virtualElement.F(null,this),delete Refract.constructing[this.tagName]}if(this.__toRender.size){for(let t of this.__toRender.keys()){let e=t;for(;e=e.vParent;)if(this.__toRender.has(e)){this.__toRender.delete(t);break}}for(let[t,e]of this.__toRender.entries())t.S(...e);this.__toRender=new Map}}getAttrib(name,alt){let velement=Refract.currentVElement;if(velement)return velement.getAttrib(name);{let hval=this.getAttribute(name);if(null===hval)return alt;let val=Html.decode(hval);try{return JSON.parse(val)}catch{}if(val.startsWith("${")&&val.endsWith("}"))try{return eval("("+val.slice(2,-1)+")")}catch{}return val}}static getInitArgs(){if(!this.initArgs&&this.prototype.init){let t=new ParsedFunction(this.prototype.init,!1);this.initArgs=[...t.getArgNames()]}return this.initArgs||[]}static onMount(t,e){new MutationObserver((r=>{(r[0].addedNodes[0]===t||document.body.contains(t))&&e()})).observe(document.body,{childList:!0,subtree:!0})}static onFirstMount(t,e,r=document){function i(t,e){for(;e=e.parentNode||e.host;)if(e===t)return!0;return!1}if(i(r,t))e();else{let l=new MutationObserver((s=>{(s[0].addedNodes[0]===t||i(r,t))&&(l.disconnect(),e())}));l.observe(r,{childList:!0,subtree:!0})}}onConnect(t){this.__connected&&t(),this.__connectedCallbacks.push(t)}onFirstConnect(t){this.__connected?t():this.__firstConnectedCallbacks.push(t)}onDisconnect(t){this.__connected&&t(),this.__disconnectedCallbacks.push(t)}connectedCallback(){this.__connected=!0;for(let t of this.__connectedCallbacks)t();for(let t of this.__firstConnectedCallbacks)t();this.__firstConnectedCallbacks=[]}disconnectedCallback(){this.__connected=!1;for(let t of this.__disconnectedCallbacks)t()}static compile(){return`\n\t\t\t(() => {\n\t\t\t\t${this.name}.createFunction = (...args) => {\n\t\t\t\t\tlet params = args.slice(0, -1).join(',');\n\t\t\t\t\tlet code = args[args.length-1];\n\t\t\t\t\treturn eval(\`(function(\${params}) {\${code}})\`);\n\t\t\t\t};\n\t\t\t\tlet modified = ${this.name}.compiler.createModifiedClass(${this.name});\n\t\t\t\t${this.name} = eval('('+modified.code+')');\t\t\n\t\t\t\t${this.name}.compiler.decorateAndRegister(${this.name}, modified);\n\t\t\t\treturn ${this.name};\t\n\t\t\t})();\t\t\n\t\t`}}Refract.constructing={},Refract.htmlDecode=Html.decode,Refract.htmlEncode=Html.encode;var h=(t,e="\"'")=>Html.encode(t,e);export default Refract;export{utils as Utils,Watch,delve,fregex,h,lex,lexHtmlJs};