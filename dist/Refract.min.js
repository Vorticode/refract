// Version 2023.7.26.2219
// License: MIT
// https://github.com/vorticode/Refract
var descendIf=(t,e,i=null)=>r=>{if(t instanceof RegExp){let l=r.match(t)||[];if(l.length)return i&&i(l),[l[0],e]}else if(r.startsWith(t))return i&&i(t),[t,e]},ascendIf=t=>e=>{if(t instanceof RegExp){let i=e.match(t)||[];if(i.length)return[i[0],-1]}else if(e.startsWith(t))return[t,-1]},functionize=t=>{for(let e in t)for(let i in t[e]){let r=t[e][i];if(Array.isArray(r)){let l={};for(let t of r)l[t[0]]=[...l[t[0]]||[],t];t[e][i]=t=>{let e=l[t[0]];if(e)for(let i of e)if(t.startsWith(i))return[i]}}else"string"==typeof r?t[e][i]=t=>[t.startsWith(r)?r:void 0]:r instanceof RegExp&&(t[e][i]=t=>[(t.match(r)||[])[0]])}};{let t=["push","pop","splice","shift","sort","reverse","unshift"],e={get(t,e){if("$"===e[0]){if("$removeProxy"===e)return t;if("$isProxy"===e)return!0;if("$trigger"===e)return e=>{let i=WatchUtil.getRoots(t);for(let r of i)for(let i of WatchUtil.getCallbacks(r))i("set",e||[],t);return i}}let i=t[e];if(e===Symbol.iterator)return i;if("function"==typeof i){let i=t.$removeProxy||t,r=i[e];return r.prototype?r:r.bind(i)}if(i&&"object"==typeof i){i=i.$removeProxy||i;let r=WatchUtil.getRoots(t);for(let l of r){let r=WatchUtil.getPaths(l,t);for(let t of r)WatchUtil.addPath(l,[...t,e],i)}return WatchUtil.getProxy(i)}return i},set(t,i,r){let l=t[i];if(l===(r=Utils.removeProxies(r)))return!0;t[i]=r;let s=e.getWatchedPaths(t,i);for(let t of s){let e=WatchUtil.getCallbacks(t[0]);for(let i of e)i("set",t[1],r,l,t[0])}return!0},getWatchedPaths(t,e){let i=WatchUtil.getRoots(t),r=[];for(let l of i){let i=WatchUtil.getPaths(l,t);for(let t of i){let i=[...t,e];r.push([l,i])}}return r},deleteProperty(t,e){Array.isArray(t)?t.splice(e,1):delete t[e];let i=WatchUtil.getRoots(t);for(let r of i){let i=WatchUtil.getPaths(r,t);for(let t of i){let i=[...t,e];for(let t of WatchUtil.getCallbacks(r))t("set",i)}}return!0}};var WatchUtil={proxies:new WeakMap,roots:new WeakMap,callbacks:new WeakMap,paths:new WeakMap,getProxy(i){let r=WatchUtil.proxies.get(i);if(!r&&(WatchUtil.proxies.set(i,r=new Proxy(i,e)),Array.isArray(i))){Object.defineProperty(r,"indexOf",{enumerable:!1,get:()=>t=>i.findIndex((e=>Utils.removeProxy(e)===Utils.removeProxy(t)))}),Object.defineProperty(r,"lastIndexOf",{enumerable:!1,get:()=>t=>i.findLastIndex((e=>Utils.removeProxy(e)===Utils.removeProxy(t)))}),Object.defineProperty(r,"includes",{enumerable:!1,get:()=>t=>-1!==i.findIndex((e=>Utils.removeProxy(e)===Utils.removeProxy(t)))});for(let e of t)Object.defineProperty(r,e,{configurable:!0,enumerable:!1,get:()=>(...t)=>WatchUtil.arrayFunction(i,e,t)})}return r},arrayFunction(t,e,i){let r=t.length,l=0;if("push"===e)l=r;else if("pop"===e)l=r-1;else if("splice"===e&&(l=0>i[0]?r-i[0]:i[0],0>l||l+i[1]>t.length))throw Error("Invalid index "+l);let s=Array.prototype[e].apply(t,i);["splice","shift","sort","reverse","unshift"].includes(e)&&WatchUtil.t(t,l,null,null);let n=Array.from(WatchUtil.getRoots(t));for(let f of n){let n=WatchUtil.getPaths(f,t);for(let a of WatchUtil.getCallbacks(f))for(let h of n)if("pop"===e)a("remove",[...h,l+""],s,null,f);else if("shift"===e)a("remove",[...h,"0"],s,null,f);else if("unshift"===e)a("insert",[...h,"0"],t[0],null,f);else if("splice"===e){let e=i[1],r=i.length-2,n=Math.min(r,e);for(o=0;n>o;o++)a("set",[...h,l+o+""],t[l+o],null,f);if(r>e)for(o=n;r>o;o++)a("insert",[...h,l+o+""],t[l+o],null,f);else if(e>r)for(o=e-1;o>=n;o--)a("remove",[...h,l+o+""],s[o-n+1],null,f)}else{for(var o=l;t.length>o;o++)a("set",[...h,o+""],t[o],null,f);for(;r>o;o++)a("delete",[...h,o+""],null,f)}}return s},t(t,e,i,r){if(i=i||[],void 0===e&&(e=0),!(r=r||new WeakSet).has(t)){if(r.add(t),i.length){let e=WatchUtil.roots.get(t);if(!e)return;for(let r of e){let e=WatchUtil.getPaths(r,t);for(let l in e){let s=e[l],n=s.length-i.length;if(n>=0){let o=s.slice();for(let t=n;s.length>t;t++)o[t]=i[t-n];let f=r;for(let t of o)if(f=f[t],!f)break;f===t&&(e[l]=o)}}}}if(Array.isArray(t))for(let l=e;t.length>l;l++)(Array.isArray(t[l])||isObj(t[l]))&&WatchUtil.t(t[l],0,[...i,l+""],r);else if(isObj(t))for(let e in t)(Array.isArray(t[e])||isObj(t[e]))&&WatchUtil.t(t[e],0,[...i,e+""],r)}},getRoots(t){return WatchUtil.roots.get(t=t.$removeProxy||t)||[]},addPath(t,e,i){t=t.$removeProxy||t;let r=WatchUtil.roots.get(i=i.$removeProxy||i);r||WatchUtil.roots.set(i,r=new Set),r.add(t);let l=WatchUtil.paths.get(t);l||WatchUtil.paths.set(t,l=new WeakMap);let s=l.get(i);if(s){for(let t of s){let i=t.length;if(i>e.length)continue;let r=!1;for(let l=0;i>l&&!(r=t[l]!==e[l]);l++);if(!r)return}s.push(e)}else l.set(i,[e])},getPaths(t,e){let i=WatchUtil.paths.get(t);return i&&i.get(e.$removeProxy||e)||[]},addCallback(t,e){let i=WatchUtil.callbacks.get(t=t.$removeProxy||t);i||WatchUtil.callbacks.set(t,i=[]),i.push(e)},getCallbacks(t){return WatchUtil.callbacks.get(t=t.$removeProxy||t)||[]}},watchProxy=(t,e)=>(WatchUtil.addPath(t,[],t),WatchUtil.addCallback(t,e),WatchUtil.getProxy(t))}var ObjectUtil={combine(t,e){let i={};for(let r=0;t.length>r;r++)i[t[r]]=e[r];return i},delve(t,e,i=ObjectUtil.delveDontCreate,r=!1){let l=i!==ObjectUtil.delveDontCreate;if(!t&&!l&&e.length)return;let s=0;for(let n of e){let o=s===e.length-1;if(r&&"object"==typeof(t=t.$removeProxy||t)&&(t.$disableWatch=!0),void 0===t[n]){if(!l)return void delete t.$disableWatch;o||(t[n]=(e[s+1]+"").match(/^\d+$/)?[]:{})}o&&l&&(t[n]=i),r&&delete t.$disableWatch,t=t[n],r&&(t=null!=t?t.$removeProxy||t:null),s++}return t},delveDontCreate:{},equalsOld(t,e){for(var i in t)if(!(i in e)||t[i]!==e[i])return!1;for(i in e)if(!(i in t)||t[i]!==e[i])return!1;return!0},equals(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;for(var i in t)if(t.hasOwnProperty(i)){if(!e.hasOwnProperty(i))return!1;if(t[i]!==e[i]){if("object"!=typeof t[i])return!1;if(!ObjectUtil.equals(t[i],e[i]))return!1}}for(i in e)if(e.hasOwnProperty(i)&&!t.hasOwnProperty(i))return!1;return!0},findRows(t,e,i="AND"){function r(t,e){const i=e.replace(/([.+?^=!:${}()|[\]/\\])/g,"\\$1").replace(/%/g,".*").replace(/_/g,".");return RegExp(`^${i}$`,"i").test(t)}function l(t,e,i="AND"){if(!e||Array.isArray(e)&&!e.length)return!0;if(Array.isArray(e)||(e=["id","=",e]),Array.isArray(e[0])){const r="AND"==(i="AND"===i.toUpperCase()?"AND":"OR")?"OR":"AND";if("AND"===i){for(let i of e)if(!l(t,i,r))return!1;return!0}for(let i of e)if(l(t,i,r))return!0;return!1}{const[i,l,s]=e;let n=t[i];if(!["=","!=","<","<=",">",">=","LIKE","NOT LIKE","IS","IS NOT","IN","NOT IN","REGEXP","NOT REGEXP"].includes(l.toUpperCase()))throw Error("Unsupported op "+l);switch(l){case"IS":case"=":return n==s;case"IS NOT":case"!=":return n!=s;case"<":return s>n;case"<=":return s>=n;case">":return n>s;case">=":return n>=s;case"LIKE":return r(n,s);case"NOT LIKE":return!r(n,s);case"IN":return s.includes(n);case"NOT IN":return!s.includes(n);case"REGEXP":return s.match(n);case"NOT REGEXP":return!s.match(n)}}}return t.filter((t=>l(t,e,i)))},invert(t){var e={};for(var i in t)e[t[i]]=i;return e},isSimpleObject(t){return!("object"!=typeof t||t.prototype||t instanceof Node||Array.isArray(t))},isSubset(t,e){for(var i in t)if(!(i in e)||e[i]!==t[i])return!1;return!0},merge(t,e){const i=t=>t&&"object"==typeof t&&!Array.isArray(t);var r=Object.assign({},t);for(var l in e)void 0===e[l]?delete r[l]:r[l]=i(t[l])&&i(e[l])?this.merge(t[l],e[l]):e[l];return r},sortByKey(t){var e=Object.keys(t);e.sort();var i={};for(let r of e)i[r]=t[r];return i}};class WatchProperties{constructor(t){this.i=t,this.l={},this.o=watchProxy(this.l,this.h.bind(this)),this.u={}}h(t,e,i,r){if("info"===t)return this.u;let l=this.getAllCallbacks(e,t,i,r);for(let[t,e]of l)t.apply(this.i,e)}getAllCallbacks(t,e,i,r){let l=[],s=csv(t),n=t.slice(0,-1);for(;n.length;){let s=csv(n);if(s in this.u)for(let n of this.u[s])l.push([n,[e,t,i,r,this.i]]);n.pop()}if(s in this.u)for(let n of this.u[s])l.push([n,[e,t,i,r,this.i]]);let o=ObjectUtil.delve(this.i,t,ObjectUtil.delveDontCreate,!0);for(let t in this.u)if(t.startsWith(s)&&t.length>s.length){let i=t.slice(s.length>0?s.length+1:s.length),n=JSON.parse("["+i+"]"),f=Utils.removeProxy(ObjectUtil.delve(r,n,ObjectUtil.delveDontCreate,!0)),a=Utils.removeProxy(ObjectUtil.delve(o,n,ObjectUtil.delveDontCreate,!0));if(f!==a){let i=this.u[t];if(i.length){let r=JSON.parse("["+t+"]");for(let t of i)l.push([t,[e,r,a,f,this.i]])}}}return l}p(t,e){t.startsWith&&(t=[t]);let i=this,r=t[0];r in i.l||(i.l[r]=i.i[r],delete i.i[r],Object.defineProperty(i.i,r,{enumerable:1,configurable:1,get:()=>i.i.$disableWatch?i.l[r]:i.o[r],set(t){i.i.$disableWatch?i.o.$removeProxy[r]=t:i.o[r]=t}}));let l=csv(t);l in i.u||(i.u[l]=[]),i.u[l].push(e)}m(t,e){t.startsWith&&(t=[t]);let i=csv(t);if(i in this.u){if(e){let t=this.u[i].indexOf(e);this.u[i].splice(t,1)}if(!e||!this.u[i].length){delete this.u[i];let e=csv([t[0]]);if(!Utils.g(this.u,e)){t[0]in this.i&&(delete this.i[t[0]],this.i[t[0]]=this.l[t[0]]);let e=WatchUtil.roots.get(this.l[t[0]]);e&&(e.delete(this.l),e.size||WatchUtil.roots.delete(this.l[t[0]])),delete this.l[t[0]],Object.keys(this.l).length||(WatchUtil.paths.delete(this.l),WatchUtil.roots.delete(this.l),WatchUtil.roots.delete(this.i[t[0]])),Object.keys(this.i).length||(WatchUtil.paths.delete(this.i),WatchUtil.roots.delete(this.i))}}}}}var Watch={objects:new WeakMap,add(t,e,i){t=Utils.removeProxy(t);var r=Watch.objects.get(t);r||Watch.objects.set(t,r=new WatchProperties(t)),r.p(e,i)},remove(t,e,i){t=Utils.removeProxy(t);var r=Watch.objects.get(t);if(r){if(e)r.m(e,i);else for(let t in r.u)r.m(t);Object.keys(r.u).length||Watch.objects.delete(t)}}},Utils={v(t,e,i){"string"==typeof e&&(e=[e]);var r=e.length;for(let l=i=i||0;t.length>l;l++)for(let i=0;r>i;i++){let r=e[i];if(t.slice(l,l+r.length)===r)return t.slice(l)}return t},removeProxy(t){return t&&t.$removeProxy||t},removeProxies(t,e){if(null==t)return t;if(t.$isProxy&&(t=t.$removeProxy),"object"==typeof t){if(e){if(e.has(t))return t}else e=new WeakSet;e.add(t);for(let i in Object.keys(t)){let r=t[i],l=this.removeProxies(r,e);if(l!==r)if(Object.getOwnPropertyDescriptor(t,i).writable)t[i]=l;else{let e=Watch.objects.get(t);(e?e.l:t)[i]=l}}}return t},_(t,e){if(t.length!==e.length)return!1;for(let i=0;t.length>i;i++)if(t[i]!==e[i])return!1;return!0},U(t,e){for(let i=0;e.length>i;i++)if(t[i]!==e[i])return!1;return!0},g(t,e){for(let i in t)if(i.startsWith(e))return!0;return!1},toString(t){return null==t?"":t+""},H(t){return t.replace(/\\r/g,"\r").replace(/\\n/g,"\n").replace(/\\t/g,"\t")},T(t,e){let i=t.tagName,r=t.hasAttribute("contenteditable")&&"false"!==t.getAttribute("contenteditable");"TEXTAREA"===i||r||"INPUT"===i&&!["button","color","file","hidden","image","radio","reset","submit"].includes(t.getAttribute("type"))?t.addEventListener("input",(i=>{let l=t.getAttribute("type")||"",s=r?t.innerHTML:t.value;"number"===l||"range"===l?s=parseFloat(s):"datetime-local"===l||"datetime"===l?s=new Date(s):"checkbox"===t.type&&(s=t.checked),e(s,i)}),!0):t.addEventListener("change",(l=>{let s;s="SELECT"===i&&t.hasAttribute("multiple")?Array.from(t.children).filter((t=>t.selected)).map((t=>t.value)):r?t.innerHTML:t.value,e(s,l)}),!0)}},csv=t=>JSON.stringify(t).slice(1,-1),isObj=t=>t&&"object"==typeof t;{let t=null,e=0,i=[],r=0,l=/^[ \t\v\f\xa0]+/,s=/^\r?\n/,n=/^<!?([\w\xA0-\uFFFF:-]+)/i,o=/^<\/[\w\xA0-\uFFFF:-]+\s*>/i,f="&& || => <<= >>= &= ^= |= &&= ||= & | ^ ~ >>> << >> === !=== == != >= > <= < = **= += -= *= /= %= ??= ++ -- ** + - * / % , ... . ( ) [ ] ?. ? : !".split(/ /g),a={};for(let t of f)a[t[0]]=[...a[t[0]]||[],t];let h=t=>{if("{"===t[1])return lexHtmlJs.allowHashTemplates&&t.startsWith("#{")||t.startsWith("${")?(r>0||(r=1),i.push(e),e=0,[t.slice(0,2),"js"]):void 0},c=t=>{if("`"===t[0])return--r,e=i.pop(),["`",-1]},u={attribute:/^[\-_$\w\xA0-\uFFFF:]+/i,string:t=>descendIf("'","squote")(t)||descendIf('"',"dquote")(t),equals:"=",tagEnd:t=>">"===t[0]?[">",-1]:t.startsWith("/>")?["/>",-1]:void 0},p=(e,i,r)=>{let l=r[r.length-1];if("script"===t&&l&&l.tokens&&">"==l.tokens[l.tokens.length-1])return["","js"]},m="await break case catch class constructor const continue debugger default delete do enum else export extends\n\t\t\t\tfinally for function if implements import in instanceof interface let new package private protected public\n\t\t\t\treturn static super switch this throw try typeof var void while with yield".split(/\s+/g),d="{ ( [ . ; , < > <= >= == != === !== + - * % << >> >>> & | ^ ! ~ && || ? : = += -= *= %= <<= >>= >>>= &= |= ^= /=".split(/ /g);var lexHtmlJs={js:{whitespace:l,ln:s,comment:/^\/\/.*?(?=(\r?\n|$))|^\/\*[\s\S]*?\*\//,end:t=>t.startsWith("<\/script>")?["",-1]:void 0,regex(t,e,i){if("/"!==t[0])return;if(i.length){let t;for(let e=i.length-1;e>=0;e--)if("ln"!==i[e].type&&"whitespace"!==i[e].type&&"comment"!==i[e].type){t=i[e]+"";break}if(!d.includes(t))return}let r=1;for(;;){if(r=t.indexOf("/",r+1),-1===r)return;try{let e=t.slice(0,r+1);return RegExp(e.slice(1,-1)),[e+t.slice(e.length).match(/^[agimsx]*/)[0]]}catch(t){}}},hex:/^0x[0-9a-f]+/,number:/^-?\d*\.?\d+(e\d+)?/,identifier(t){let e=(t.match(/^[_$a-z\xA0-\uFFFF][_$\w\xA0-\uFFFF]*/i)||[])[0];if(!m.includes(e))return[e]},template(t){if("`"===t[0])return++r,i.push(e),e=0,["`","template"]},brace1(t){if("{"===t[0])return e++,["{"]},brace2(t){if("}"===t[0])return 0===e&&r?(e=i.pop(),["}",-1]):(e--,["}"])},semicolon:";",keyword:m,operator:f,string:/^"(\\\\|\\"|[^"])*"|^'(\\\\|\\'|[^'])*'/},html:{script:p,comment:descendIf("\x3c!--","htmlComment"),closeTag:o,openTag:descendIf(n,"tag",(e=>t=e[1])),text:/^[\s\S]+?(?=<|$)/},htmlComment:{commentEnd:ascendIf("--\x3e"),commentBody:/^[\s\S]+?(?=-->|$)/},template:{script:p,expr:h,comment:descendIf("\x3c!--","templateComment"),closeTag:o,openTag:descendIf(n,"templateTag",(e=>t=e[1])),templateEnd:c,text(t){let e=t.match(lexHtmlJs.allowHashTemplates?/^(?:\\#{|\\\${|\s|(?!(#{|\${|`|<[\w\xA0-\uFFFF!:/-]|$)).)+/:/^(?:\\\${|\s|(?!(\${|`|<[\w\xA0-\uFFFF!:/-]|$)).)+/);if(e){let t=e[0];return t=Utils.H(t),[t,void 0,e[0].length]}}},templateComment:{expr:h,commentEnd:ascendIf("--\x3e"),commentBody:t=>t.match(lexHtmlJs.allowHashTemplates?/^[\s\S]+?(?=-->|[$#]{|$)/:/^[\s\S]+?(?=-->|\${|$)/)||[]},tag:{whitespace:/^[ \r\n\t\v\f\xa0]+/,...u},templateTag:{whitespace(t){let e=t.match(/^( |\r|\n|\t|\v|\f|\xa0|\\r|\\n|\\t|\\v|\\f|\\xa0)+/);if(e){let t=e[0];return t=Utils.H(t),[t,void 0,e[0].length]}},expr:h,templateEnd:c,...u},squote:{expr:h,quote:ascendIf("'"),text:t=>t.match(lexHtmlJs.allowHashTemplates?/^(?:\\'|(?!'|#{|\${)[\S\s])+/:/^(?:\\'|(?!'|\${)[\S\s])+/)||[]},dquote:{expr:h,quote:ascendIf('"'),text:t=>t.match(lexHtmlJs.allowHashTemplates?/^(?:\\"|(?!"|#{|\${)[\S\s])+/:/^(?:\\"|(?!"|\${)[\S\s])+/)||[]},allowHashTemplates:!1};function expandFastMatch_(t){for(let e in t)if(t[e].length||expandFastMatch_(t[e]),e.length>1){let i=e;if(e.includes("a-z")){for(let e of"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ")t[e]=t[i];e=e.replace("a-z","")}if(e.includes("0-9")){for(let e of"0123456789")t[e]=t[i];e=e.replace("0-9","")}if(e.length>1)for(let r of e)t[r]=t[i];delete t[i]}Object.freeze(t)}functionize(lexHtmlJs),lexHtmlJs.fastMatch={html:{"<":{"/":[lexHtmlJs.html,"closeTag"],"a-z0-9":[lexHtmlJs.html,"openTag"],"!":[lexHtmlJs.html,"comment"]},"a-z0-9 \t\r\n":[lexHtmlJs.html,"text"]},tag:{"a-z0-9":[lexHtmlJs.tag,"attribute"]," \t\r\n":[lexHtmlJs.tag,"whitespace"],'"':[lexHtmlJs.tag,"string"],"'":[lexHtmlJs.tag,"string"],">":[lexHtmlJs.tag,"tagEnd"],"/":{">":[lexHtmlJs.tag,"tagEnd"]},"=":[lexHtmlJs.tag,"equals"]},dquote:{'"':[lexHtmlJs.dquote,"quote"],"a-z0-9 \t.()[]/":[lexHtmlJs.dquote,"text"],"$#":[lexHtmlJs.dquote,"expr"]},js:{" \t\v\f ":[lexHtmlJs.js,"whitespace"],"=&|^!+-*%,.()[]?!>:":[lexHtmlJs.js,"operator"],"\r\n":[lexHtmlJs.js,"ln"],";":[lexHtmlJs.js,"semicolon"],"/":{"/*":[lexHtmlJs.js,"comment"]},"{":[lexHtmlJs.js,"brace1"],"}":[lexHtmlJs.js,"brace2"],O:[lexHtmlJs.js,"identifier"],"0-9":[lexHtmlJs.js,"number"],"'\"":[lexHtmlJs.js,"string"],"`":[lexHtmlJs.js,"template"]},template:{"`":[lexHtmlJs.template,"templateEnd"],"$#":[lexHtmlJs.template,"expr"],"<":{"a-z":[lexHtmlJs.template,"openTag"],"/":[lexHtmlJs.template,"closeTag"],"!":[lexHtmlJs.template,"comment"]}},templateTag:{$:[lexHtmlJs.templateTag,"expr"]},templateComment:{"-":[lexHtmlJs.templateComment,"commentEnd"],"a-z0-9\t\r\n ":[lexHtmlJs.templateComment,"commentBody"]}},lexHtmlJs.fastMatch.templateTag=lexHtmlJs.fastMatch.tag;for(let t in lexHtmlJs.fastMatch)expandFastMatch_(lexHtmlJs.fastMatch[t]);Object.freeze(lexHtmlJs.fastMatch)}function fregex(...t){return t=prepare(t),(e,i=[],r=0)=>{let l=0;for(let s of t){let t=s(e.slice(l),i,r+l);if(!1===t)return!1;l+=t}return l}}fregex.capture=(...t)=>{let e=null;return t=t.filter((t=>!(t instanceof CaptureName&&(e=t.name,1)))),t=prepare(t),(i,r=[],l=0)=>{let s=0;for(let e of t){let t=e(i.slice(s),r,l+s);if(!1===t)return!1;s+=t}let n={index:l,match:i.slice(0,s)};return e&&(n.name=e),r.push(n),s}},fregex.captureName=t=>new CaptureName(t),fregex.or=(...t)=>(t=prepare(t),(e,i=[],r=0)=>{for(let l of t){let t=l(e,i,r);if(!1!==t)return t}return!1}),fregex.not=(...t)=>{let e=fregex(t);return(t,i=[],r=0)=>!1===e(t,i,r)&&0},fregex.zeroOrOne=(...t)=>{let e=fregex(t);return(t,i=[],r=0)=>{let l=e(t,i,r);return!1===l?0:l}},fregex.xOrMore=(t,...e)=>{let i=fregex(e);return(e,r=[],l=0)=>{let s=0;for(let n=0;e.length;n++){let o=i(e,r,l+s);if(!1===o)return n>=t&&s;s+=o||1,e=e.slice(o||1)}return s}},fregex.zeroOrMore=(...t)=>fregex.xOrMore(0,...t),fregex.oneOrMore=(...t)=>fregex.xOrMore(1,...t),fregex.matchFirst=(t,e,i=0,r=[])=>{let l=fregex.matchAll(t,e,1,i);return l.length?l[0]:null},fregex.matchAll=(t,e,i=1/0,r=0)=>{Array.isArray(t)&&(t=fregex(t));let l=[];for(let s=r;e.length>s&&i>l.length;s++){let i=[],r=t(e.slice(s),i);!1!==r&&l.push(Object.assign(e.slice(s,s+r),{index:s,capture:i}))}return l},fregex.munch=(t,e)=>(t=prepareRule(t),e=prepareRule(e),(i,r=[],l=0)=>{let s=0;for(let r=0;i.length>r;r++){let l=i.slice(r),n=0;if(n=t(l))s++;else if((n=e(l))&&(s--,0===s))return r+n;if(!1!==n&&(r+=n-1),0===s)return r}return 0}),fregex.lookAhead=(...t)=>(t=prepare(t),(e,i=[])=>{for(let r of t)if(!1===r(e,i))return!1;return 0}),fregex.end=t=>!t.length&&0;var prepare=t=>{Array.isArray(t[0])&&1===t.length&&(t=t[0]);let e=[];for(let i in t)e[i]=prepareRule(t[i]);return e},prepareRule=t=>"string"==typeof t?e=>e[0]==t:Array.isArray(t)?fregex(t):"object"!=typeof t||t.prototype?t:e=>{for(let i in t)if(!e[0]||e[0][i]!=t[i])return!1;return 1};class CaptureName{constructor(t){this.name=t}}function fastLex(t,e,i){let r;if(!t.fastMatch)return[!1,!1];let l=t.fastMatch[e];if(l){let t=0;do{if(l=l[i[t]],l&&l.length){[l,r]=l,l=l[r];break}t++}while(l)}return[l,r]}function valueOf(){return this.text}function toString(){return this.text}class Token{constructor(t,e,i,r,l,s,n){this.text=t,this.type=e,this.mode=i,this.line=r,this.col=l,this.originalLength=s,this.tokens=n}valueOf(){return this.text}toString(){return this.text}}function lex(t,e,i=null,r={},l=1,s=1,n=0){let o;i=i||Object.keys(t)[0];let f="";if(256>(e+="").length){var a=i+"|"+e.slice(0,24);if(o=cache[a],o&&o[0]===e)return o[1]}for(o=[];e.length>n;){let a,h,c,u,p,m=e.slice(0,n),d=e.slice(n);if([c,u]=fastLex(t,i,d),c&&([a,p,h]=c(d,m,o)||[]),!a){let e=t[i];for(u in e){let t=e[u];if([a,p,h]=t(d,m,o)||[],void 0!==a)break}}if(void 0===a){if(r.failOnUnknown){let t=e.slice(Math.max(n-15,0),n),r=d.slice(0,25).replace(/\r/g,"\\r").replace(/\n/g,"\\n");throw Error(`Unknown token within "${i}" at ${l}:${s}\r\n"${t+"⚠️"+r}"`)}f+=e.slice(0,1),e=e.slice(1);continue}f.length&&(a=f,p=!1,f="");let x={text:a,type:u,mode:p&&-1!==p?p:i,line:l,col:s,originalLength:h,valueOf,toString},g=h||a.length;if(-1===p)return[...o,x];if(p){let f=lex(t,e,p,r,l,s+g,n+g);if(!1===f)return o;let h=[x,...f].filter((t=>t.text.length));g=h.reduce(((t,e)=>t+(e.originalLength||e.text.length)),0),x={text:e.slice(n,n+g),type:u,tokens:h,mode:i,line:l,col:s,valueOf,toString},g!==a.length&&(x.originalLength=g)}if(g){if(n+=g,r.callback&&!1===r.callback(x))return o;o.push(x);let t=-1;for(let e=0,i=a.length;i>e;e++)"\n"==a[e]&&(l++,t=e);s=(t>-1?-t:s)+g}}return 256>e.length&&(cache[a]=[e,o]),o}var cache={};class ParsedFunction{name;type;P;k;j;W;constructor(t,e=!0,i=null){if("function"==typeof t&&(t=""+t),"string"==typeof t){let i;if(!e){let t=0;i=e=>{if("("===e.text?t++:")"===e.text&&t--,0===t&&("{"===e.text||"=>"===e.text))return!1}}t=lex(lexHtmlJs,t,"js",{callback:i})}i=i||(t=>{throw Error(t)});const r=(t,e=0)=>{let i=Parse.A(t,e);return null===i?-1:(this.k=t.slice(e+1,i-1),i-1)};if("function"===t[0].text){this.type="function";let e=t.slice(1).findIndex((t=>!["whitespace","ln","comment"].includes(t.type)));if(-1===e)return i("Not enough tokens to be a function.");"identifier"===t[e+1].type&&(this.name=t[e+1].text);let r=t.slice(e+1).findIndex((t=>"("===t.text));if(-1===r)return i("Cannot find opening ( for function arguments.");this.P=e+1+r+1}else if("identifier"===t[0].type){let e=t.findIndex((t=>"operator"===t.type));-1!==e&&"("===t[e]?.text&&(this.type="method",this.name=t[0].text,this.P=e+1)}if(["function","method"].includes(this.type)){let l=r(t,this.P-1);if(-1===l)return i("Cannot find closing ) and end of arguments list.");if(e){let e=t.slice(l).findIndex((t=>"{"===t.text));if(-1===this.j)return i("Cannot find start of function body.");this.j=l+e}}if(!this.type){let l,s;if("("===t[0].text){if(this.P=1,s=r(t,0),-1===s)return i("Cannot find ) and end of arguments list.");l="Params"}else s=1,l="Param",this.k=[t[0]];if(e){let e=t.slice(s).findIndex((t=>"=>"===t.text));if(-1===e)return i("Cannot find arrow before function body.");let r=t.slice(s+e+1).findIndex((t=>!["whitespace","ln","comment"].includes(t.type)));if(-1===r)return i("Cannot find function body.");this.j=s+e+1+r,this.type="{"===t[this.j]?.text?`arrow${l}Brace`:"arrow"+l}}if(e){let e,r=["arrowParam","arrowParams"].includes(this.type);if(r){const i=["{","(","["],r=["}",")","]"],l=[";",",",...r];let s=!1;for(let n,o=this.j;n=t[o];o++)if(!["whitespace","comment"].includes(n.type))if(i.includes(n.text))o=Parse.A(t,o,i,r);else{if(l.includes(n.text)){e=o;break}if("operator"===n.type)s=!0;else if(s||"ln"!==n.type)s=!1;else{let i=t.slice(o).find((t=>!["whitespace","ln","comment"].includes(t.type)));if(i){if(l.includes(i)||"operator"!==i.type){e=o;break}}else e=o-1}}}else e=Parse.A(t,this.j);if(null===e)return i("Cannot find end of function body.");r&&";"===t[e]?.text&&e++,this.W=t.slice(this.j,e)}}*getArgNames(){let t=this.k;if("arrowParam"===this.type)yield t[0].text;else{let e,i,r=[],l=null,s=!0,n=0;for(let o of t){let t=o.text;if("identifier"===o.type&&s?(l=t,e?i&&(i[l]=void 0):e=l):"("==t||"{"==t||"["==t?(n++,s=!0,e||"{"!=t||(e=i={}),l&&(i=i[l]={},r.push(i))):")"==t||"}"==t||"]"==t?(n--,i=r.pop()):","===t?s=!0:":"===t?s=!1:":"!==t&&"="!==t||(s=!1,l=null),0>n)return void(e&&(yield e));","===t&&0===n&&(yield e,e=i=void 0)}e&&(yield e)}}}var Parse={S(t=[]){let e=t.join(",");return varExprCache[e]||(varExprCache[e]=fregex(fregex.or(fregex("this",Parse.ws,fregex.oneOrMore(property)),...t.map((t=>fregex(t,fregex.zeroOrMore(property))))),terminator))},A(t,e=0,i=["(","{"],r=[")","}"],l=[],s=1){let n=0,o=i.includes(t[e].text);for(let f,a=e;f=t[a];a+=s){let t=f.text||f+"";if(i.includes(t))n+=s;else if(r.includes(t)){if(n-=s,o){if(0===n)return a+1}else if(0>n)return a}else if(!n&&l.includes(t))return a}return null},J(t){let e=[],i=1,r=0;for(let l of t)1!==i||"identifier"!==l.type||r?"("==l||"{"==l||"["==l?r++:")"!=l&&"}"!=l&&"]"!=l||r--:e.push(l+""),r||(i={",":1,"=":-1}[l]||i);return e},C(t,e=0){for(let i,r=e;i=t[r];r++){if("function"==i)return r;if("=>"==i){let e=0;for(let i,l=-1;i=t[r+l];l--)if("whitespace"!==i.type&&"ln"!==i.type&&"comment"!==i.type&&(")"==i?e++:"("==i&&e--,0===e))return r+l}}return null},V(t){let e=t.map((t=>({...t}))),i=this.C(e);for(let t,r=0;t=e[r];r++){if(r===i){let t=new ParsedFunction(e.slice(i));r=i+t.j+t.W.length+1,i=this.C(e,r)}"template"===t.type&&(e[r].text="`"+t.text.slice(1,-1).replace(/\${/g,"\\${").replace(/`/g,"\\`")+"`")}return e},I(t){return t=t.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"").replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*|<!--[\s\S]*?-->$/),t=Utils.v(t,"{"),t=Utils.v(t,"return"),t=Utils.v(t,["`",'"',"'"]),(t=Utils.v(t,["<"])).match(/<(\w+-[\w-]+)/)[1]},F(tokens){"string"==typeof tokens&&(tokens=lex(lexHtmlJs,tokens,"js"));let htmlMatch=fregex.matchFirst([fregex.or({type:"template"},{type:"string"}),Parse.ws,fregex.zeroOrOne(";")],tokens);if(!htmlMatch)return null;let template=htmlMatch.filter((t=>t.tokens||"string"===t.type))[0],innerTokens;if(template.tokens)innerTokens=template.tokens.slice(1,-1);else{let code=eval(template+"");innerTokens=lex(lexHtmlJs,code,"template")}for(;"openTag"!==innerTokens[0].type;)innerTokens=innerTokens.slice(1);return innerTokens},N(t,e){let i=[],r=!1;for(let e of t)if(e.tokens){let t=Parse.N(e.tokens,e.mode);i.push({text:t.map((t=>t.text)).join(""),type:e.type,tokens:t,mode:e.mode})}else"#{"==e.text&&"expr"==e.type?(i.push(new Token("${"),new Token("refractHtmlEncode"),new Token("(")),r=!0):i.push(e);if(r){let t=[];"squote"===e?t=[new Token(","),new Token('"\'"')]:"dquote"===e&&(t=[new Token(","),new Token("'\"'")]),i.splice(i.length-1,0,...t,new Token(")"))}return i},R(t,e=[]){let i=[Parse.S(e),Parse.ws,".",Parse.ws,"map",Parse.ws,"(",Parse.ws],r=fregex.matchFirst(i,t);if(!r)return[null,null];let l=t.slice(r.length),s=Parse.C(l);if(null===s||0!==s)return[null,null];let n=new ParsedFunction(l.slice(s),!0,(()=>!1));return n&&fregex([Parse.ws,")",Parse.ws,fregex.zeroOrOne(";"),Parse.ws,fregex.end])(t.slice(r.length+n.j+n.W.length))?[[...n.getArgNames()],n.W]:[null,null]},M(t,e=[]){},L(t,e=[]){return fregex.matchAll(Parse.S(e),t).filter((e=>"."!=t[e.index-1]&&"?."!=t[e.index-1]))},G(expr){let result=[];for(let piece of expr)"this"==piece||"identifier"===piece.type||"number"===piece.type?result.push(piece+""):"string"!==piece.type&&"template"!==piece.type||result.push(eval(piece+""));return result}};let varExprCache={};Parse.ws=fregex.zeroOrMore(fregex.or({type:"whitespace"},{type:"ln"}));let indexType=[{type:"number"},{type:"hex"},{type:"string"},{type:"template"}];Parse.q=fregex.oneOrMore(fregex.or("this",".","[","]",{type:"identifier"},{type:"number"},{type:"hex"},{type:"string"},{type:"template"},{type:"whitespace"},{type:"ln"}));let terminator=fregex.lookAhead([fregex.or(fregex.end,fregex.not(Parse.ws,"("))]),property=fregex(fregex.or(fregex(Parse.ws,fregex.or(".","?."),Parse.ws,{type:"identifier"}),fregex(Parse.ws,fregex.zeroOrOne("?."),"[",Parse.ws,fregex.or(...indexType),Parse.ws,"]")),terminator);var div=document.createElement("div"),decodeCache_={},Html={decode(t){return t?t.replace(/&[#A-Z0-9]+;/gi,(t=>decodeCache_[t]||(div.innerHTML=t,decodeCache_[t]=div.textContent))):""},encode(t,e='"'){return t=(null==t?"":t+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\a0/g,"&nbsp;"),e.includes("'")&&(t=t.replace(/'/g,"&apos;")),e.includes('"')&&(t=t.replace(/"/g,"&quot;")),t}};class VText{text="";el=null;D=null;X=0;constructor(t="",e=null){this.D=e,null==t?t="":"string"==typeof t||t instanceof String||(t=JSON.stringify(t)),this.text=Html.decode(t)}B(t=null,e=null){if(e)this.el=e;else{let e;if("STYLE"!==t.tagName||this.D.contains(t.getRootNode()?.host))e=this.text;else{this.D.dataset.style||(this.D.constructor.styleId=(this.D.constructor.styleId||0)+1,this.D.dataset.style=this.D.constructor.styleId);let t=this.D.tagName.toLowerCase();e=VText.K(this.text,t,this.D.dataset.style)}this.el?this.el.textContent=e:(this.el=t.ownerDocument.createTextNode(e),(t=t.shadowRoot||t).insertBefore(this.el,t.childNodes[this.X])),Refract.elsCreated&&Refract.elsCreated.push(Utils.toString(e))}return 1}Y(){let t=new VText;return t.text=this.text,t.D=this.D,t}Z(){this.el.parentNode.removeChild(this.el)}static K(t,e,i){return t.replace(/:host(?=[^a-z0-9_])/gi,e+'[data-style="'+i+'"]')}}class ScopeItem{path;value;constructor(t,e){this.path=t,this.value=e}Y(){return new ScopeItem(this.path.slice(),this.value)}}class Scope extends Map{Y(){let t=new Scope;for(let[e,i]of this)t.set(e,i.Y());return t}tt(t){if("this"===t[0])return t;let e;for(;e=this.get(t[0]);)t=[...e.path,...t.slice(1)];return t}getValues(){return[...this.values()].map((t=>t.value))}}class VExpression{et=[];it=null;rt=null;type="simple";isHash=!1;lt=null;st=[];nt=[];D=null;ot=null;ft=null;ht=[];ct={};ct=new Scope;X=0;ut=0;dt=[];constructor(t=null,e=null,i=null,r=null){if(this.ft=e,e&&(this.D=e.D,this.ct=e.ct.Y()),t){let r="#{"==t[0].text;"${"!=t[0].text&&!r||"}"!=t[t.length-1].text||(this.isHash=r,t=t.slice(1,-1)),this.code=t.map((t=>t.text)).join("").trim(),i=(i||[]).slice();let l=Parse.L(t,i),[s,n]=Parse.R(t,i);if(n){this.type="loop",this.st=s;for(let t of s)i.push(t);this.lt=this.D.constructor.createFunction(...i,"return "+l[0].join(""));let t=n.filter((t=>"whitespace"!==t.type&&"ln"!==t.type));this.nt=1===t.length&&"template"===t[0].type?VElement.xt(t[0].tokens.slice(1,-1),i,e,this.D):[new VExpression(n,this,i)]}else{Parse.S(i)(t)!==t.length&&(this.type=Parse.q(t)===t.length?"simple":"complex"),t=Parse.N(t,null,this.D.constructor.name),t=Parse.V(t);let e=Html.decode(t.map((t=>t.text)).join(""));"{"===t[0].text&&"}"===t[t.length-1].text||(e="return ("+e.trim()+")"),this.lt=this.D.constructor.createFunction(...i,e)}for(let t of l)this.et.push(Parse.G(t))}}B(t=null,e=null){if(this.ot=t||this.ot,this.rt){for(let e of this.rt)t.removeAttribute(e);this.rt=[];let e=this.gt();if(e){let i=lex(lexHtmlJs,e,"tag"),r=null;for(let e of i)"attribute"===e.type?(r&&t.setAttribute(r,""),r=e,this.rt.push(r)):"string"===e.type&&(t.setAttribute(r,e.tokens[1]),r=null);r&&t.setAttribute(r,"")}return 0}{for(let t of this.ht)if(t instanceof HTMLElement)t.parentNode.removeChild(t);else for(let e of t.slice())e.Z();this.ht=this.bt();let t=0,e=this.X;for(let i of this.ht)if(i instanceof HTMLElement)this.ot.insertBefore(i,this.ot.childNodes[e]),e++;else for(let r of i){r.X=e;let i=r.B(this.ot,null);e+=i,t+=i}return t}}Y(t=null,e=null,i=null){let r=new VExpression;return r.et=this.et,r.it=this.it,r.rt=this.rt,r.type=this.type,r.lt=this.lt,r.st=this.st,r.nt=this.nt,r.D=t||this.D,r.ot=i||this.ot,r.ft=e||this.ft,r.X=this.X,r.ut=this.ut,r.ct=this.ct.Y(),r.isHash=this.isHash,r.code=this.code,r}gt(){return this.lt.apply(this.D,this.ct.getValues())}bt(){for(let t of this.dt)Watch.remove(...t);this.dt=[],this.vt||(this.vt=this.yt.bind(this)),this._t(this.vt);let t=[];if("loop"!==this.type){let e=[this.gt()].flat().map((t=>void 0===t?"":t));if(this.isHash)t=[e.map((t=>new VText(t,this.D)))];else{let i=[...this.ct.keys()];for(let r of e)if(r instanceof HTMLElement)t.push(r);else if(r+="",r.length){let e=VElement.wt(r,i,this,this.D).flat();t.push(e)}}}else{let e=this.gt();if(!e)throw Error(`${this.et[0].join(".")} is not iterable in ${this.code}`);let i=0;for(let r of e){let r=[],l=[e[i],i,e];for(let t of this.nt){let e=t.Y(this.D,this);this.Et(e,l,i),r.push(e)}t.push(r),i++}}return t}Et(t,e,i){t.ct=this.ct.Y();for(let r in this.st){let l=[...this.et[0],i+""],s=this.ct.tt(l);t.ct.set(this.st[r],new ScopeItem(s,e[r]))}}yt(t,e,i,r,l){if(this.ft&&("loop"!==this.type||2>=e.length||!Utils.U(e.slice(0,-2),this.et[0].slice(1))))if(this.D.__autoRender||!this.D.virtualElement){if(Globals.Ut=this,this.ut=this.Ht(),"complex"!==this.type&&e[e.length-1].match(/^\d+$/)){let i=e.slice(0,-1),r=ObjectUtil.delve(l,i);if(Array.isArray(r)&&Utils._(this.et[0].slice(1),i)){let i=parseInt(e[e.length-1]);if("remove"===t){for(let t of this.ht[i])t.Z();this.ht.splice(i,1)}else{if("set"===t&&this.ht[i])for(let t of this.ht[i])t.Z();"insert"===t&&this.ht.splice(i,0,[]),this.ht[i]="simple"===this.type?[new VText(r[i],this.D)]:this.nt.map((t=>t.Y(this.D,this)));let e=0,l=this.Tt(i),s=[r[i],i,r];for(let t of this.ht[i])t.X=l+e,t.ot=this.ot,this.Et(t,s,e+i),t.B(this.ot,null),e++}return this.Ot(),void(Globals.Ut=null)}}this.B(),this.Ot(),Globals.Ut=null}else this.D.__toRender.set(this,arguments)}Z(){for(let t of this.dt)Watch.remove(...t);this.dt=[];for(let t of this.ht)if(t instanceof HTMLElement)t.parentNode.removeChild(t);else for(let e of t)e.Z();if(this.ht=[],this.ft instanceof VElement){let t=this.ft.ht.indexOf(this);this.ft.ht.splice(t,1)}else for(let t of this.ft.ht){let e=t.indexOf(this);if(e>=0){t.splice(e,1);break}}this.ft=null}Ht(){let t=0;for(let e of this.ht)if(e instanceof HTMLElement)t++;else for(let i of e)i.yt?t+=i.Ht():t++;return t}Tt(t){let e=this.X;for(let i of this.ht.slice(0,t))for(let t of i)t instanceof VExpression?e+=t.Ht():e++;return e}Pt(){let t=this.ft.ht.flat(),e=t.indexOf(this);for(let i of t.slice(e+1))if(i instanceof VExpression)return i;return this.ft.ot===this.ot&&this.ft instanceof VExpression?this.ft.Pt():null}Ot(){let t=this.Ht()-this.ut,e=this;for(;e=e.Pt();)e.X+=t}_t(t){for(let e of this.et){let i,r=this.D;if("this"===e[0])e=e.slice(1);else if(e.length>1&&this.ct.has(e[0]))r=this.ct.get(e[0]).value,e=e.slice(1);else if(i=this.ct.get(e[0])){let t=ObjectUtil.delve(r,i.path.slice(1),ObjectUtil.delveDontCreate,!0);if("object"!=typeof t&&!Array.isArray(t))continue;r=ObjectUtil.delve(this.D,i.path.slice(1,-1),ObjectUtil.delveDontCreate,!0),e=i.path.slice(-1)}e.length&&("object"==typeof r||Array.isArray(r))&&(this.dt.push([r,e,t]),Watch.add(r,e,t))}}}class Compiler{static evalStringAttrib(string){try{return JSON.parse(string)}catch(e){if(string.startsWith("${")&&string.endsWith("}"))try{return eval("("+string.slice(2,-1)+")")}catch(t){}}return string}static createModifiedClass(t){let e={};e.kt=t;let i=`\n\t\t\t__preInit = (${""+(()=>{if("autoRender"in this?this.__autoRender=this.autoRender:"__autoRender"in this||(this.__autoRender=!0),!1!==Object.getOwnPropertyDescriptor(this,"autoRender")?.configurable&&Object.defineProperty(this,"autoRender",{get(){return this.__autoRender},set(t){this.__autoRender=t,t&&this.render()}}),this.__autoRender&&this.render(),this.init&&"%tagName%"===this.tagName){let t=this.parentElement?this.constructor.compiler.populateArgsFromAttribs(this,this.constructor.jt()):this.Wt;this.init(...t)}})})()`;return t.prototype.html&&(e.tagName=Parse.I(""+t.prototype.html),i=i.replace("%tagName%",e.tagName.toUpperCase()),e.code=(""+t).slice(0,-1)+i+"}"),e}static decorateAndRegister(t,e){t.tagName=e.tagName,t.constructorArgs=e.constructorArgs,t.htmlTokens=e.htmlTokens;for(let i of Object.getOwnPropertyNames(e.kt.prototype))"constructor"!==i&&(t.prototype[i]=e.kt.prototype[i]);for(let i of Object.getOwnPropertyNames(e.kt))i in Refract||(t[i]=e.kt[i]);customElements.define(e.tagName,t)}static populateArgsFromAttribs(t,e){const i=(e,r=5)=>{if(r&&e&&(Array.isArray(e)||"object"==typeof e)&&!(e instanceof HTMLElement))for(let l in e)e[l]?i(e[l],r-1):e[l]=t.At(l);return e};let r=[];for(let l of e)r.push("string"==typeof l?t.At(l):i(l));return r}}lexHtmlJs.allowHashTemplates=!0;class VElement{tagName="";rt={};$t=[];D=null;el=null;ft=null;ht=[];ct=new Scope;X=0;constructor(t=null,e=null,i=null){if(e instanceof HTMLElement?this.D=e:e&&(this.ft=e,this.D=e.D,this.ct=e.ct.Y()),t){let e="",r=t.filter((t=>"whitespace"!==t.type));for(let t,l=0;t=r[l];l++)if(0===l)this.tagName=t.text.slice(1);else if("attribute"===t.type)e=t.text,this.rt[e]=null;else if(e&&"="==r[l-1]){let r=[];if("string"===t.type)for(let l of t.tokens.slice(1,-1))r.push("expr"===l.type?new VExpression(l.tokens,this,i,e):l.text);else"expr"===t.type&&r.push(new VExpression(t.tokens,this,i,e));this.rt[e]=r,e=void 0}else if("expr"===t.type){let e=new VExpression(t.tokens,this,i);e.rt=[],this.$t.push(e)}else if(">"===t.text||"/>"===t.text)break}}B(t=null,e=null){let i=this.tagName;"svg"===i&&(inSvg=!0);var r=this.el;if(e)this.el=e,e.querySelector("slot")||(this.D.slotHtml=e.innerHTML),e.innerHTML="";else{var l;if(Globals.Ut=this,i.includes("-")&&customElements.get(i)){let t=customElements.get(i),e=[];t.prototype.init&&(e=Refract.compiler.populateArgsFromAttribs(this,t.jt()));let r=2,n=i;for(;n.toUpperCase()in Globals.St;){n=i+"_"+r;var s=customElements.get(n);if(s){t=s;break}t=class extends t{},customElements.define(n,t),r++}l=new t(...e)}else l=inSvg?document.createElementNS("http://www.w3.org/2000/svg",i):document.createElement(i);if(r)r.parentNode.insertBefore(l,r),r.remove();else if(!r){let e=t.shadowRoot||t;e!==this.D&&e.tagName&&e.tagName.includes("-")&&"SLOT"!==l.tagName&&(e=this.rt.slot?e.querySelector(`slot[name="${this.rt.slot[0]}"]`)||e.querySelector("slot")||e:e.querySelector("slot")||e),e.insertBefore(l,e.childNodes[this.X])}this.el=l,Globals.Ut=null,Refract.elsCreated&&Refract.elsCreated.push("<"+i+">")}!this.el.shadowRoot&&"shadow"in this.rt&&this.el.attachShadow({mode:this.el.getAttribute("shadow")||"open"});let n=0;if("slot"===i){let t=VElement.wt(this.D.slotHtml,[...this.ct.keys()],this,this.D);for(let e of t)e.ct=this.ct.Y(),e.X=n,n+=e.B(this.el)}let o="TEXTAREA"===this.el.tagName||"contenteditable"in this.rt&&this.rt.contenteditable+""!="false";for(let t of this.ht){if(o&&t instanceof VExpression)throw Error("textarea and contenteditable can't have templates as children. Use value=${this.variable} instead.");t.ct=this.ct.Y(),t.D=this.D,t.X=n,n+=t.B(this.el)}for(let t in this.rt){let e=this.rt[t];for(let i of e||[])if(i instanceof VExpression){let r=i;r.ot=this.el,r.ct=this.ct.Y(),r._t((()=>{if("value"===t)setInputValue_(this.D,this.el,e,this.ct);else{let i=VElement.Jt(this.D,e,this.ct);this.el.setAttribute(t,i)}}))}let i=VElement.Jt(this.D,e,this.ct);if(this.el.setAttribute(t,i),"id"===t||"data-id"===t){let e=this.el.getAttribute(t).split(".");ObjectUtil.delve(this.D,e,this.el)}else if(t.startsWith("on")&&t in div){let e=(this.D&&this.D.constructor||window.RefractCurrentClass).createFunction,i=this.el.getAttribute(t);this.el.removeAttribute(t),this.el.addEventListener(t.slice(2),(t=>{let r=["event","el",...this.ct.keys()];e(...r,i).bind(this.D)(t,this.el,...this.ct.getValues())}))}}for(let t of this.$t)t.ct=this.ct.Y(),t.B(this.el),t._t((()=>{t.B(this.el)}));let f="value"in this.rt&&"option"!==i;if(f){let t=this.rt.value;if(1===t.length&&t[0]instanceof VExpression&&"simple"===t[0].type){let e=(0,(this.D&&this.D.constructor||window.RefractCurrentClass).createFunction)(...this.ct.keys(),"val",t[0].code+"=val;").bind(this.D);Utils.T(this.el,((t,i)=>{Globals.Ct=i,e(...this.ct.getValues(),t),Globals.Ct=null}))}}return f&&setInputValue_(this.D,this.el,this.rt.value,this.ct),"svg"===i&&(inSvg=!1),1}Y(t,e=null){let i=new VElement;i.tagName=this.tagName,i.D=t||this.D,i.ft=e;for(let t in this.rt)if(null===this.rt[t])i.rt[t]=null;else{i.rt[t]=[];for(let e of this.rt[t])i.rt[t].push(e instanceof VExpression?e.Y(i.D,this):e)}for(let t of this.$t)i.$t.push(t.Y(i.D,this));for(let t of this.ht)i.ht.push(t.Y(i.D,i));return i}At(t){let e=t.toLowerCase(),i=t in this.rt?this.rt[t]:this.rt[e];if(void 0===i)return i;if(i&&1===i.length&&i[0]instanceof VExpression)return i[0].lt.apply(this.D,this.ct.getValues());if(Array.isArray(i)&&!i.length)return"";if(null===i)return"";let r=VElement.Jt(this.D,i||[],this.ct);return Compiler.evalStringAttrib(r)}Z(){for(let t of this.ht)t.Z();this.el.parentNode.removeChild(this.el),this.ft=null}static Vt(t,e,i={}){if(1===e.length&&e[0]instanceof VExpression)return e[0].lt.apply(t,i.getValues());let r=e.map((e=>e instanceof VExpression?e.lt.apply(t,i.getValues()):e));return Html.decode(r.flat().map(Utils.toString).join(""))}static Jt(t,e,i=null){let r=[];for(let l of e||[])if(l instanceof VExpression){let e=l.lt.apply(t,i?i.getValues():[]);Array.isArray(e)||e instanceof Set?e=Array.from(e).join(" "):e&&"object"==typeof e&&(e=e.constructor===Object?Object.entries(e).map((([t,i])=>`${t}: ${e[t]}; `)).join(""):""),r.push(e)}else r.push(Html.decode(l));return r.map(Utils.toString).join("")}static wt(t,e=[],i=null,r){let l=lex(lexHtmlJs,[t].flat().join(""),"template");return VElement.xt(l,e,i,r)}static xt(t,e=[],i=null,r,l=!1,s=0){if(!t.length)return[];let n=[];do{let o=t[s];if("text"===o.type)n.push(new VText(o.text,i?.D));else if("expr"===o.type)n.push(new VExpression(o.tokens,i,e));else if("openTag"===o.type){let l=new VElement(o.tokens,i||r,e);n.push(l),"/>"==o.tokens[o.tokens.length-1].text||l.tagName.toLowerCase()in selfClosingTags_||(s++,l.ht=VElement.xt(t,e,l,r,!1,s),s=l.ht.index)}else if("closeTag"===o.type)break;if(n.length===l)break;s++}while(t.length>s);return n.index=s,n}}var selfClosingTags_={area:1,base:1,br:1,col:1,embed:1,hr:1,img:1,input:1,link:1,meta:1,param:1,source:1,track:1,wbr:1,command:1,keygen:1,menuitem:1},inSvg=!1;function setInputValue_(t,e,i,r){if(Globals.Ct&&e===Globals.Ct.target)return;let l="TEXTAREA"===e.tagName||e.hasAttribute("contenteditable")&&"false"!==e.getAttribute("contenteditable");if(l||"INPUT"===e.tagName){let s=VElement.Jt(t,i,r);l?e.innerHTML=s:"checkbox"===e.type?e.checked=["1","true"].includes((s+"").toLowerCase()):e.value=s}else{let l=VElement.Vt(t,i,r);if("SELECT"===e.tagName)for(let t of e.children)t.selected=Array.isArray(l)?l.includes(t.value):l===t.value;else e.value=l}}lexHtmlJs.allowHashTemplates=!0;var Globals={Ct:null,Ut:null,St:{}};class Refract extends HTMLElement{static compiler=Compiler;static tagName;static htmlTokens=null;static virtualElement;static constructorArgs=null;static initArgs=null;static elsCreated=!1;slotHtml="";__autoRender=!0;__toRender=new Map;virtualElement=null;__connected=!1;__connectedBefore=!1;__connectedCallbacks=[];__firstConnectedCallbacks=[];__disconnectedCallbacks=[];constructor(t=!0){super(),!1===t&&(this.__autoRender=!1),this.Wt=arguments}render(){if(this.__autoRender=!0,!this.virtualElement){if(!this.constructor.virtualElement){if(this.html&&"function"==typeof this.html&&(this.constructor.htmlTokens=Parse.F(""+this.html),!this.constructor.htmlTokens))throw Error("Class is missing an html function with a template value.");this.constructor.virtualElement=VElement.xt(this.constructor.htmlTokens,[],null,this,1)[0],this.constructor.htmlTokens=null}Globals.St[this.tagName]=!0,this.virtualElement=this.constructor.virtualElement.Y(this),this.virtualElement.B(null,this),delete Globals.St[this.tagName]}if(this.__toRender.size){for(let t of this.__toRender.keys()){let e=t;for(;e=e.ft;)if(this.__toRender.has(e)){this.__toRender.delete(t);break}}for(let[t,e]of this.__toRender.entries())t.yt(...e);this.__toRender=new Map}}At(t,e){let i=Refract.Ut;if(i)return i.getAttrib(t);{let i=this.getAttribute(t);if(null===i)return e;let r=Html.decode(i);return Compiler.evalStringAttrib(r)}}static jt(){if(!this.initArgs&&this.prototype.init){let t=new ParsedFunction(this.prototype.init,!1);this.initArgs=[...t.getArgNames()]}return this.initArgs?structuredClone(this.initArgs):[]}onConnect(t){this.__connected&&t(),this.__connectedCallbacks.push(t)}onFirstConnect(t){this.__connected?t():this.__firstConnectedCallbacks.push(t)}onDisconnect(t){!this.__connected&&this.__connectedBefore&&t(),this.__disconnectedCallbacks.push(t)}connectedCallback(){this.__connected=this.__connectedBefore=!0;for(let t of this.__connectedCallbacks)t();for(let t of this.__firstConnectedCallbacks)t();this.__firstConnectedCallbacks=[]}disconnectedCallback(){this.__connected=!1;for(let t of this.__disconnectedCallbacks)t()}static compile(){return`\n\t\t\t(() => {\n\t\t\t\t${this.name}.createFunction = (...args) => {\n\t\t\t\t\tlet params = args.slice(0, -1).join(',');\n\t\t\t\t\tlet code = args[args.length-1];\n\t\t\t\t\treturn eval(\`(function(\${params}) {\${code}})\`);\n\t\t\t\t};\n\t\t\t\tlet modified = ${this.name}.compiler.createModifiedClass(${this.name});\n\t\t\t\t${this.name} = eval('('+modified.code+')');\t\t\n\t\t\t\t${this.name}.compiler.decorateAndRegister(${this.name}, modified);\n\t\t\t\treturn ${this.name};\t\n\t\t\t})();\t\t\n\t\t`}}Refract.htmlDecode=Html.decode,Refract.htmlEncode=Html.encode,window.refractHtmlEncode=Html.encode;var h=(t,e="\"'")=>Html.encode(t,e);export default Refract;export{Globals,Utils,Watch,fregex,h,lex,lexHtmlJs};