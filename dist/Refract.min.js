// Version 2023.1.16.2301
// License: MIT
// https://github.com/vorticode/Refract
var descendIf=(t,e,i=null)=>l=>{if(t instanceof RegExp){let r=l.match(t)||[];if(r.length)return i&&i(r),[r[0],e]}else if(l.startsWith(t))return i&&i(t),[t,e]},ascendIf=t=>e=>{if(t instanceof RegExp){let i=e.match(t)||[];if(i.length)return[i[0],-1]}else if(e.startsWith(t))return[t,-1]};{let t=["indexOf","lastIndexOf","includes"],e=["push","pop","splice","shift","sort","reverse","unshift"],i={get(t,e){if("$"===e[0]){if("$removeProxy"===e)return t;if("$isProxy"===e)return!0;if("$trigger"===e)return e=>{let i=WatchUtil.getRoots(t);for(let l of i)for(let i of WatchUtil.getCallbacks(l))i("set",e||[],t);return i}}let i=t[e];if(e===Symbol.iterator)return i;if("function"==typeof i){let i=t.$removeProxy||t,l=i[e];return l.prototype?l:l.bind(i)}if(i&&"object"==typeof i){i=i.$removeProxy||i;let l=WatchUtil.getRoots(t);for(let r of l){let l=WatchUtil.getPaths(r,t);for(let t of l)WatchUtil.addPath(r,[...t,e],i)}return WatchUtil.getProxy(i)}return i},set(t,e,l){let r=t[e];if(r===(l=removeProxies(l)))return!0;t[e]=l;let s=i.getWatchedPaths(t,e);for(let t of s){let e=WatchUtil.getCallbacks(t[0]);for(let i of e)i("set",t[1],l,r,t[0])}return!0},getWatchedPaths(t,e){let i=WatchUtil.getRoots(t),l=[];for(let r of i){let i=WatchUtil.getPaths(r,t);for(let t of i){let i=[...t,e];l.push([r,i])}}return l},deleteProperty(t,e){Array.isArray(t)?t.splice(e,1):delete t[e];let i=WatchUtil.getRoots(t);for(let l of i){let i=WatchUtil.getPaths(l,t);for(let t of i){let i=[...t,e];for(let t of WatchUtil.getCallbacks(l))t("set",i)}}return!0}};var WatchUtil={proxies:new WeakMap,roots:new WeakMap,callbacks:new WeakMap,paths:new WeakMap,getProxy(l){let r=WatchUtil.proxies.get(l);if(!r&&(WatchUtil.proxies.set(l,r=new Proxy(l,i)),Array.isArray(l))){for(let e of t)Object.defineProperty(r,e,{enumerable:!1,get:()=>t=>Array.prototype[e].call(l,utils.removeProxy(t))});for(let t of e)Object.defineProperty(r,t,{configurable:!0,enumerable:!1,get:()=>(...e)=>WatchUtil.arrayFunction(l,t,e)})}return r},arrayFunction(t,e,i){let l=t.length,r=0;"push"===e?r=l:"pop"===e?r=l-1:"splice"===e&&(r=0>i[0]?l-i[0]:i[0]);let s=Array.prototype[e].apply(t,i);["splice","shift","sort","reverse","unshift"].includes(e)&&WatchUtil.t(t,r,null,null);let n=Array.from(WatchUtil.getRoots(t));for(let a of n){let n=WatchUtil.getPaths(a,t);for(let f of WatchUtil.getCallbacks(a))for(let h of n)if("pop"===e)f("remove",[...h,r+""],s,null,a);else if("shift"===e)f("remove",[...h,"0"],s,null,a);else if("unshift"===e)f("insert",[...h,"0"],t[0],null,a);else if("splice"===e){let e=i[1],l=i.length-2,n=Math.min(l,e);for(o=0;n>o;o++)f("set",[...h,r+o+""],t[r+o],null,a);if(l>e)for(o=n;l>o;o++)f("insert",[...h,r+o+""],t[r+o],null,a);else if(e>l)for(o=e-1;o>=n;o--)f("remove",[...h,r+o+""],s[o-n+1],null,a)}else{for(var o=r;t.length>o;o++)f("set",[...h,o+""],t[o],null,a);for(;l>o;o++)f("delete",[...h,o+""],null,a)}}return s},t(t,e,i,l){if(i=i||[],void 0===e&&(e=0),!(l=l||new WeakSet).has(t)){if(l.add(t),i.length){let e=WatchUtil.roots.get(t);if(!e)return;for(let l of e){let e=WatchUtil.getPaths(l,t);for(let r in e){let s=e[r],n=s.length-i.length;if(n>=0){let o=s.slice();for(let t=n;s.length>t;t++)o[t]=i[t-n];let a=l;for(let t of o)if(a=a[t],!a)break;a===t&&(e[r]=o)}}}}if(Array.isArray(t))for(let r=e;t.length>r;r++)(Array.isArray(t[r])||isObj(t[r]))&&WatchUtil.t(t[r],0,[...i,r+""],l);else if(isObj(t))for(let e in t)(Array.isArray(t[e])||isObj(t[e]))&&WatchUtil.t(t[e],0,[...i,e+""],l)}},getRoots(t){return WatchUtil.roots.get(t=t.$removeProxy||t)||[]},addPath(t,e,i){t=t.$removeProxy||t;let l=WatchUtil.roots.get(i=i.$removeProxy||i);l||WatchUtil.roots.set(i,l=new Set),l.add(t);let r=WatchUtil.paths.get(t);r||WatchUtil.paths.set(t,r=new WeakMap);let s=r.get(i);if(s){for(let t of s){let i=t.length;if(i>e.length)continue;let l=!1;for(let r=0;i>r&&!(l=t[r]!==e[r]);r++);if(!l)return}s.push(e)}else r.set(i,[e])},getPaths(t,e){let i=WatchUtil.paths.get(t);return i&&i.get(e.$removeProxy||e)||[]},addCallback(t,e){let i=WatchUtil.callbacks.get(t=t.$removeProxy||t);i||WatchUtil.callbacks.set(t,i=[]),i.push(e)},getCallbacks(t){return WatchUtil.callbacks.get(t=t.$removeProxy||t)||[]}},watchProxy=(t,e)=>(WatchUtil.addPath(t,[],t),WatchUtil.addCallback(t,e),WatchUtil.getProxy(t))}var dontCreateValue_={};function delve(t,e,i=dontCreateValue_,l=!1){let r=i!==dontCreateValue_;if(!t&&!r&&e.length)return;let s=0;for(let n of e){let o=s===e.length-1;if(l&&"object"==typeof(t=t.$removeProxy||t)&&(t.$disableWatch=!0),void 0===t[n]){if(!r)return void delete t.$disableWatch;o||(t[n]=(e[s+1]+"").match(/^\d+$/)?[]:{})}o&&r&&(t[n]=i),l&&delete t.$disableWatch,t=t[n],l&&(t=null!=t?t.$removeProxy||t:null),s++}return t}delve.dontCreateValue=dontCreateValue_;class WatchProperties{constructor(t){this.i=t,this.l={},this.o=watchProxy(this.l,this.h.bind(this)),this.u={}}h(t,e,i,l){if("info"===t)return this.u;let r=this.getAllCallbacks(e,t,i,l);for(let[t,e]of r)t.apply(this.i,e)}getAllCallbacks(t,e,i,l){let r=[],s=csv(t),n=t.slice(0,-1);for(;n.length;){let s=csv(n);if(s in this.u)for(let n of this.u[s])r.push([n,[e,t,i,l,this.i]]);n.pop()}if(s in this.u)for(let n of this.u[s])r.push([n,[e,t,i,l,this.i]]);let o=delve(this.i,t,delve.dontCreateValue,!0);for(let t in this.u)if(t.startsWith(s)&&t.length>s.length){let i=t.slice(s.length>0?s.length+1:s.length),n=JSON.parse("["+i+"]"),a=utils.removeProxy(delve(l,n,delve.dontCreateValue,!0)),f=utils.removeProxy(delve(o,n,delve.dontCreateValue,!0));if(a!==f){let i=this.u[t];if(i.length){let l=JSON.parse("["+t+"]");for(let t of i)r.push([t,[e,l,f,a,this.i]])}}}return r}m(t,e){t.startsWith&&(t=[t]);let i=this,l=t[0];l in i.l||(i.l[l]=i.i[l],delete i.i[l],Object.defineProperty(i.i,l,{enumerable:1,configurable:1,get:()=>i.i.$disableWatch?i.l[l]:i.o[l],set(t){i.i.$disableWatch?i.o.$removeProxy[l]=t:i.o[l]=t}}));let r=csv(t);r in i.u||(i.u[r]=[]),i.u[r].push(e)}p(t,e){t.startsWith&&(t=[t]);let i=csv(t);if(i in this.u){if(e){let t=this.u[i].indexOf(e);this.u[i].splice(t,1)}if(!e||!this.u[i].length){delete this.u[i];let e=csv([t[0]]);if(!utils.g(this.u,e)){delete this.i[t[0]],this.i[t[0]]=this.l[t[0]];let e=WatchUtil.roots.get(this.l[t[0]]);e&&(e.delete(this.l),e.size||WatchUtil.roots.delete(this.l[t[0]])),delete this.l[t[0]],Object.keys(this.l).length||(WatchUtil.paths.delete(this.l),WatchUtil.roots.delete(this.l),WatchUtil.roots.delete(this.i[t[0]])),Object.keys(this.i).length||(WatchUtil.paths.delete(this.i),WatchUtil.roots.delete(this.i))}}}}}var Watch={objects:new WeakMap,add(t,e,i){assert(e.length),t=removeProxy(t);var l=Watch.objects.get(t);l||Watch.objects.set(t,l=new WatchProperties(t)),l.m(e,i)},remove(t,e,i){t=removeProxy(t);var l=Watch.objects.get(t);if(l){if(e)l.p(e,i);else for(let t in l.u)l.p(t);Object.keys(l.u).length||Watch.objects.delete(t)}},cleanup(){Watch.objects=new WeakMap}},removeProxy=t=>t&&t.$removeProxy||t,assert=t=>{if(!t)throw Error("Assertion failed")},utils={v(t,e,i){"string"==typeof e&&(e=[e]);var l=e.length;for(let r=i=i||0;t.length>r;r++)for(let i=0;l>i;i++){let l=e[i];if(t.slice(r,r+l.length)===l)return t.slice(r)}return t},removeProxy(t){return t&&t.$removeProxy||t},arrayEq(t,e){if(t.length!==e.length)return!1;for(let i=0;t.length>i;i++)if(t[i]!==e[i])return!1;return!0},_(t,e){for(let i=0;e.length>i;i++)if(t[i]!==e[i])return!1;return!0},g(t,e){for(let i in t)if(i.startsWith(e))return!0;return!1},toString(t){return null==t?"":t+""},unescapeTemplate(t){return t.replace(/\\r/g,"\r").replace(/\\n/g,"\n").replace(/\\t/g,"\t")},H(t,e){let i=t.tagName,l=t.hasAttribute("contenteditable")&&"false"!==t.getAttribute("contenteditable");"TEXTAREA"===i||l||"INPUT"===i&&!["button","color","file","hidden","image","radio","reset","submit"].includes(t.getAttribute("type"))?t.addEventListener("input",(i=>{let r=t.getAttribute("type")||"",s=l?t.innerHTML:t.value;"number"===r||"range"===r?s=parseFloat(s):"datetime-local"===r||"datetime"===r?s=new Date(s):"checkbox"===t.type&&(s=t.checked),e(s,i)}),!0):t.addEventListener("change",(r=>{let s;s="SELECT"===i&&t.hasAttribute("multiple")?Array.from(t.children).filter((t=>t.selected)).map((t=>t.value)):l?t.innerHTML:t.value,e(s,r)}),!0)}},csv=t=>JSON.stringify(t).slice(1,-1),isObj=t=>t&&"object"==typeof t,removeProxies=(t,e)=>{if(null==t)return t;if(t.$isProxy&&(t=t.$removeProxy),"object"==typeof t){if(e){if(e.has(t))return t}else e=new WeakSet;e.add(t);for(let i in Object.keys(t)){let l=t[i],r=removeProxies(l,e);if(r!==l)if(Object.getOwnPropertyDescriptor(t,i).writable)t[i]=r;else{let e=Watch.objects.get(t);(e?e.l:t)[i]=r}}}return t};{let t=null,e=0,i=[],l=0,r=/^[ \t\v\f\xa0]+/,s=/^\r?\n/,n=/^<!?([\w\xA0-\uFFFF:-]+)/i,o=/^<\/[\w\xA0-\uFFFF:-]+\s*>/i,a="&& || ! => <<= >>= &= ^= |= &&= ||= & | ^ ~ >>> << >> === !=== == != >= > <= < = **= += -= *= /= %= ??= ++ -- ** + - * / % , ... . ( ) [ ] ?. ? :".split(/ /g),f={};for(let t of a)f[t[0]]=[...f[t[0]]||[],t];let h=t=>{if("{"===t[1])return lexHtmlJs.allowHashTemplates&&t.startsWith("#{")||t.startsWith("${")?(l>0||(l=1),i.push(e),e=0,[t.slice(0,2),"js"]):void 0},c=t=>{if("`"===t[0])return--l,e=i.pop(),["`",-1]},u={attribute:/^[\-_$\w\xA0-\uFFFF:]+/i,string:t=>descendIf("'","squote")(t)||descendIf('"',"dquote")(t),equals:"=",tagEnd:t=>">"===t[0]?[">",-1]:t.startsWith("/>")?["/>",-1]:void 0,unknown:t=>lexHtmlJs.allowUnknownTagTokens?t.match(/^\w+|\S/)||[]:void 0},m=(e,i,l)=>{let r=l[l.length-1];if("script"===t&&r&&r.tokens&&">"==r.tokens[r.tokens.length-1])return["","js"]},p="await break case catch class constructor const continue debugger default delete do enum else export extends\n\t\t\t\tfinally for function if implements import in instanceof interface let new package private protected public\n\t\t\t\treturn static super switch this throw try typeof var void while with yield".split(/\s+/g),d="{ ( [ . ; , < > <= >= == != === !== + - * % << >> >>> & | ^ ! ~ && || ? : = += -= *= %= <<= >>= >>>= &= |= ^= /=".split(/ /g);var lexHtmlJs={js:{whitespace:r,ln:s,comment:/^\/\/.*(?=\r?\n)|^\/\*[\s\S]*?\*\//,end:t=>t.startsWith("<\/script>")?["",-1]:void 0,regex(t,e,i){if("/"!==t[0])return;if(i.length){let t;for(let e=i.length-1;e>=0;e--)if("ln"!==i[e].type&&"whitespace"!==i[e].type&&"comment"!==i[e].type){t=i[e]+"";break}if(!d.includes(t))return}let l=1;for(;;){if(l=t.indexOf("/",l+1),-1===l)return;try{let e=t.slice(0,l+1);return RegExp(e.slice(1,-1)),[e+t.slice(e.length).match(/^[agimsx]*/)[0]]}catch(t){}}},hex:/^0x[0-9a-f]+/,number:/^\d*\.?\d+(e\d+)?/,identifier(t){let e=(t.match(/^[_$a-z\xA0-\uFFFF][_$\w\xA0-\uFFFF]*/i)||[])[0];if(!p.includes(e))return[e]},template(t){if("`"===t[0])return++l,i.push(e),e=0,["`","template"]},brace1(t){if("{"===t[0])return e++,["{"]},brace2(t){if("}"===t[0])return 0===e&&l?(e=i.pop(),["}",-1]):(e--,["}"])},semicolon:";",keyword:p,operator:a,string:/^"(\\\\|\\"|[^"])*"|^'(\\\\|\\'|[^'])*'/},html:{script:m,comment:descendIf("\x3c!--","htmlComment"),closeTag:o,openTag:descendIf(n,"tag",(e=>t=e[1])),text:/^[\s\S]+?(?=<|$)/},htmlComment:{commentEnd:ascendIf("--\x3e"),commentBody:/^[\s\S]+?(?=-->|$)/},template:{script:m,expr:h,comment:descendIf("\x3c!--","templateComment"),closeTag:o,openTag:descendIf(n,"templateTag",(e=>t=e[1])),templateEnd:c,text(t){let e=t.match(lexHtmlJs.allowHashTemplates?/^(?:\\#{|\\\${|\s|(?!(#{|\${|`|<[\w\xA0-\uFFFF!:/-]|$)).)+/:/^(?:\\\${|\s|(?!(\${|`|<[\w\xA0-\uFFFF!:/-]|$)).)+/);if(e){let t=e[0];return t=utils.unescapeTemplate(t),[t,void 0,e[0].length]}}},templateComment:{expr:h,commentEnd:ascendIf("--\x3e"),commentBody:t=>t.match(lexHtmlJs.allowHashTemplates?/^[\s\S]+?(?=-->|[$#]{|$)/:/^[\s\S]+?(?=-->|\${|$)/)||[]},tag:{whitespace:/^[ \r\n\t\v\f\xa0]+/,...u},templateTag:{whitespace(t){let e=t.match(/^( |\r|\n|\t|\v|\f|\xa0|\\r|\\n|\\t|\\v|\\f|\\xa0)+/);if(e){let t=e[0];return t=utils.unescapeTemplate(t),[t,void 0,e[0].length]}},expr:h,templateEnd:c,...u},squote:{expr:h,quote:ascendIf("'"),text:t=>t.match(lexHtmlJs.allowHashTemplates?/^(?:\\'|(?!'|#{|\${)[\S\s])+/:/^(?:\\'|(?!'|#{)[\S\s])+/)||[]},dquote:{expr:h,quote:ascendIf('"'),text:t=>t.match(lexHtmlJs.allowHashTemplates?/^(?:\\"|(?!"|#{|\${)[\S\s])+/:/^(?:\\"|(?!"|#{)[\S\s])+/)||[]},allowHashTemplates:!1,allowUnknownTagTokens:!1};for(let t in lexHtmlJs)for(let e in lexHtmlJs[t]){let i=lexHtmlJs[t][e];if(Array.isArray(i)){let l={};for(let t of i)l[t[0]]=[...l[t[0]]||[],t];lexHtmlJs[t][e]=t=>{let e=l[t[0]];if(e)for(let i of e)if(t.startsWith(i))return[i]}}else"string"==typeof i?lexHtmlJs[t][e]=t=>[t.startsWith(i)?i:void 0]:i instanceof RegExp&&(lexHtmlJs[t][e]=t=>[(t.match(i)||[])[0]])}function expandFastMatch_(t){for(let e in t)if(t[e].length||expandFastMatch_(t[e]),e.length>1){let i=e;if(e.includes("a-z")){for(let e of"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ")t[e]=t[i];e=e.replace("a-z","")}if(e.includes("0-9")){for(let e of"0123456789")t[e]=t[i];e=e.replace("0-9","")}if(e.length>1)for(let l of e)t[l]=t[i];delete t[i]}Object.freeze(t)}lexHtmlJs.fastMatch={html:{"<":{"/":[lexHtmlJs.html,"closeTag"],"a-z0-9":[lexHtmlJs.html,"openTag"],"!":[lexHtmlJs.html,"comment"]},"a-z0-9 \t\r\n":[lexHtmlJs.html,"text"]},tag:{"a-z0-9":[lexHtmlJs.tag,"attribute"]," \t\r\n":[lexHtmlJs.tag,"whitespace"],'"':[lexHtmlJs.tag,"string"],"'":[lexHtmlJs.tag,"string"],">":[lexHtmlJs.tag,"tagEnd"],"/":{">":[lexHtmlJs.tag,"tagEnd"]},"=":[lexHtmlJs.tag,"equals"]},dquote:{'"':[lexHtmlJs.dquote,"quote"],"a-z0-9 \t.()[]/":[lexHtmlJs.dquote,"text"],"$#":[lexHtmlJs.dquote,"expr"]},js:{" \t\v\f ":[lexHtmlJs.js,"whitespace"],"=&|^!+-*%,.()[]?!>:":[lexHtmlJs.js,"operator"],"\r\n":[lexHtmlJs.js,"ln"],";":[lexHtmlJs.js,"semicolon"],"/":{"/*":[lexHtmlJs.js,"comment"]},"{":[lexHtmlJs.js,"brace1"],"}":[lexHtmlJs.js,"brace2"],k:[lexHtmlJs.js,"identifier"],"0-9":[lexHtmlJs.js,"number"],"'\"":[lexHtmlJs.js,"string"],"`":[lexHtmlJs.js,"template"]},template:{"`":[lexHtmlJs.template,"templateEnd"],"$#":[lexHtmlJs.template,"expr"],"<":{"a-z":[lexHtmlJs.template,"openTag"],"/":[lexHtmlJs.template,"closeTag"],"!":[lexHtmlJs.template,"comment"]}},templateTag:{$:[lexHtmlJs.templateTag,"expr"]},templateComment:{"-":[lexHtmlJs.templateComment,"commentEnd"],"a-z0-9\t\r\n ":[lexHtmlJs.templateComment,"commentBody"]}},lexHtmlJs.fastMatch.templateTag=lexHtmlJs.fastMatch.tag;for(let t in lexHtmlJs.fastMatch)expandFastMatch_(lexHtmlJs.fastMatch[t]);Object.freeze(lexHtmlJs.fastMatch)}function fregex(...t){return t=prepare(t),e=>{let i=0;for(let l of t){let t=l(e.slice(i));if(!1===t)return!1;i+=t}return i}}fregex.or=(...t)=>(t=prepare(t),e=>{for(let i of t){let t=i(e);if(!1!==t)return t}return!1}),fregex.not=(...t)=>{let e=fregex(t);return t=>!1===e(t)&&0},fregex.nor=(...t)=>(t=prepare(t),e=>{for(let i of t)if(i(e)>0)return!1;return 1}),fregex.zeroOrOne=(...t)=>{let e=fregex(t);return t=>{let i=e(t);return!1===i?0:i}},fregex.xOrMore=(t,...e)=>{let i=fregex(e);return e=>{let l=0;for(let r=0;e.length;r++){let s=i(e);if(!1===s)return r>=t&&l;l+=s||1,e=e.slice(s||1)}return l}},fregex.zeroOrMore=(...t)=>fregex.xOrMore(0,...t),fregex.oneOrMore=(...t)=>fregex.xOrMore(1,...t),fregex.matchFirst=(t,e,i=0)=>{let l=fregex.matchAll(t,e,1,i);return l.length?l[0]:null},fregex.matchAll=(t,e,i=1/0,l=0)=>{Array.isArray(t)&&(t=fregex(t));let r=[];for(let s=l;e.length>s&&i>r.length;s++){let i=t(e.slice(s));!1!==i&&r.push(Object.assign(e.slice(s,s+i),{index:s}))}return r},fregex.lookAhead=(...t)=>(t=prepare(t),e=>{for(let i of t)if(!1===i(e))return!1;return 0}),fregex.end=t=>!t.length&&0;var prepare=t=>{Array.isArray(t[0])&&1===t.length&&(t=t[0]);let e=[];for(let i in t){let l=t[i];e[i]="string"==typeof l?t=>t[0]==l:Array.isArray(l)?fregex(l):"object"!=typeof l||l.prototype?t[i]:t=>{for(let e in l)if(t[0][e]!=l[e])return!1;return 1}}return e};function findFastMatch(t,e,i){let l,r=t.fastMatch[e];if(r){let t=0;do{if(r=r[i[t]],r&&r.length){[r,l]=r,r=r[l];break}t++}while(r)}return[r,l]}function valueOf(){return this.text}function toString(){return this.text}class Token{constructor(t,e,i,l,r,s,n){this.text=t,this.type=e,this.mode=i,this.line=l,this.col=r,this.originalLength=s,this.tokens=n}valueOf(){return this.text}toString(){return this.text}}function lex(t,e,i=null,l={},r=1,s=1,n=0){let o;i=i||Object.keys(t)[0];let a="";if(256>(e+="").length){var f=i+"|"+e.slice(0,24);if(o=lexCache[f],o&&o[0]===e)return o[1]}for(o=[];e.length>n;){let f,h,c,u,m,p=e.slice(0,n),d=e.slice(n);if([c,u]=findFastMatch(t,i,d),c&&([f,m,h]=c(d,p,o)||[]),!f){let e=t[i];for(u in e){let t=e[u];if([f,m,h]=t(d,p,o)||[],void 0!==f)break}}if(void 0===f){if(l.failOnUknown){let t=e.slice(Math.max(n-15,0),n),l=d.slice(0,25).replace(/\r/g,"\\r").replace(/\n/g,"\\n");throw Error(`Unknown token within "${i}" at ${r}:${s}\r\n"${t+"⚠️"+l}"`)}a+=e.slice(0,1),e=e.slice(1);continue}a.length&&(f=a,m=!1,a="");let x={text:f,type:u,mode:m&&-1!==m?m:i,line:r,col:s,originalLength:h,valueOf,toString},g=h||f.length;if(-1===m)return[...o,x];if(m){let a=lex(t,e,m,l,r,s+g,n+g);if(!1===a)return o;let h=[x,...a].filter((t=>t.text.length));g=h.reduce(((t,e)=>t+(e.originalLength||e.text.length)),0),x={text:e.slice(n,n+g),type:u,tokens:h,mode:i,line:r,col:s,valueOf,toString},g!==f.length&&(x.originalLength=g)}if(g){if(n+=g,l.callback&&!1===l.callback(x))return o;o.push(x);let t=-1;for(let e=0,i=f.length;i>e;e++)"\n"==f[e]&&(r++,t=e);s=(t>-1?-t:s)+g}}return 256>e.length&&(lexCache[f]=[e,o]),o}var lexCache={};class ParsedFunction{name;type;T;W;P;J;constructor(t,e=!0,i=null){if("function"==typeof t&&(t=""+t),"string"==typeof t){let i;if(!e){let t=0;i=e=>{if("("===e.text?t++:")"===e.text&&t--,0===t&&("{"===e.text||"=>"===e.text))return!1}}t=lex(lexHtmlJs,t,"js",{callback:i})}i=i||(t=>{throw Error(t)});const l=(t,e=0)=>{assert("("===t[e].text);let i=Parse.C(t,e);return null===i?-1:(this.W=t.slice(e+1,i-1),i-1)};if("function"===t[0].text){this.type="function";let e=t.slice(1).findIndex((t=>!["whitespace","ln","comment"].includes(t.type)));if(-1===e)return i("Not enough tokens to be a function.");"identifier"===t[e+1].type&&(this.name=t[e+1].text);let l=t.slice(e+1).findIndex((t=>"("===t.text));if(-1===l)return i("Cannot find opening ( for function arguments.");this.T=e+1+l+1}else if("identifier"===t[0].type){let e=t.findIndex((t=>"operator"===t.type));-1!==e&&"("===t[e]?.text&&(this.type="method",this.name=t[0].text,this.T=e+1)}if(["function","method"].includes(this.type)){let r=l(t,this.T-1);if(-1===r)return i("Cannot find closing ) and end of arguments list.");if(e){let e=t.slice(r).findIndex((t=>"{"===t.text));if(-1===this.P)return i("Cannot find start of function body.");this.P=r+e}}if(!this.type){let r,s;if("("===t[0].text){if(this.T=1,s=l(t,0),-1===s)return i("Cannot find ) and end of arguments list.");r="Params"}else s=1,r="Param",this.W=[t[0]];if(e){let e=t.slice(s).findIndex((t=>"=>"===t.text));if(-1===e)return i("Cannot find arrow before function body.");let l=t.slice(s+e+1).findIndex((t=>!["whitespace","ln","comment"].includes(t.type)));if(-1===l)return i("Cannot find function body.");this.P=s+e+1+l,this.type="{"===t[this.P]?.text?`arrow${r}Brace`:"arrow"+r}}if(e){let e,l=["arrowParam","arrowParams"].includes(this.type);if(l){const i=["{","(","["],l=["}",")","]"],r=[";",",",...l];let s=!1;for(let n,o=this.P;n=t[o];o++)if(!["whitespace","comment"].includes(n.type))if(i.includes(n.text))o=Parse.C(t,o,i,l);else{if(r.includes(n.text)){e=o;break}if("operator"===n.type)s=!0;else if(s||"ln"!==n.type)s=!1;else{let i=t.slice(o).find((t=>!["whitespace","ln","comment"].includes(t.type)));if(i){if(r.includes(i)||"operator"!==i.type){e=o;break}}else e=o-1}}}else e=Parse.C(t,this.P);if(null===e)return i("Cannot find end of function body.");l&&";"===t[e]?.text&&e++,this.J=t.slice(this.P,e)}}*S(){let t=this.W;if("arrowParam"===this.type)yield t[0].text;else{let e,i,l=[],r=null,s=!0,n=0;for(let o of t){let t=o.text;if("identifier"===o.type&&s?(r=t,e?i&&(i[r]=void 0):e=r):"("==t||"{"==t||"["==t?(n++,s=!0,e||"{"!=t||(e=i={}),r&&(i=i[r]={},l.push(i))):")"==t||"}"==t||"]"==t?(n--,i=l.pop()):","===t?s=!0:":"===t?s=!1:":"!==t&&"="!==t||(s=!1,r=null),0>n)return void(e&&(yield e));","===t&&0===n&&(yield e,e=i=void 0)}e&&(yield e)}}}var Parse={A(t=[]){let e=t.join(",");return varExpressionCache_[e]||(varExpressionCache_[e]=fregex(fregex.or(fregex("this",Parse.ws,fregex.oneOrMore(property_)),...t.map((t=>fregex(t,fregex.zeroOrMore(property_))))),terminator_))},C(t,e=0,i=["(","{"],l=[")","}"],r=[],s=1){let n=0,o=i.includes(t[e].text);for(let a,f=e;a=t[f];f+=s){let t=a.text||a+"";if(i.includes(t))n+=s;else if(l.includes(t)){if(n-=s,o){if(0===n)return f+1}else if(0>n)return f}else if(!n&&r.includes(t))return f}return null},V(t){let e=[],i=1,l=0;for(let r of t)1!==i||"identifier"!==r.type||l?"("==r||"{"==r||"["==r?l++:")"!=r&&"}"!=r&&"]"!=r||l--:e.push(r+""),l||(i={",":1,"=":-1}[r]||i);return e},U(t,e=0){for(let i,l=e;i=t[l];l++){if("function"==i)return l;if("=>"==i){let e=0;for(let i,r=-1;i=t[l+r];r--)if("whitespace"!==i.type&&"ln"!==i.type&&"comment"!==i.type&&(")"==i?e++:"("==i&&e--,0===e))return l+r}}return null},j(t){let e=t.map((t=>({...t}))),i=this.U(e);for(let t,l=0;t=e[l];l++){if(l===i){let t=new ParsedFunction(e.slice(i));l=i+t.P+t.J.length+1,i=this.U(e,l)}"template"===t.type&&(e[l].text="`"+t.text.slice(1,-1).replace(/\${/g,"\\${").replace(/`/g,"\\`")+"`")}return e},F(t){return t=t.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"").replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*|<!--[\s\S]*?-->$/),t=utils.v(t,"{"),t=utils.v(t,"return"),t=utils.v(t,["`",'"',"'"]),(t=utils.v(t,["<"])).match(/<(\w+-[\w-]+)/)[1]},O(tokens){"string"==typeof tokens&&(tokens=lex(lexHtmlJs,tokens,"js"));let htmlMatch=fregex.matchFirst([fregex.or({type:"template"},{type:"string"}),Parse.ws,fregex.zeroOrOne(";")],tokens);if(!htmlMatch)return null;let template=htmlMatch.filter((t=>t.tokens||"string"===t.type))[0],innerTokens;if(template.tokens)innerTokens=template.tokens.slice(1,-1);else{let code=eval(template+"");innerTokens=lex(lexHtmlJs,code,"template")}for(;"openTag"!==innerTokens[0].type;)innerTokens=innerTokens.slice(1);return innerTokens},R(t,e,i){let l=[],r=!1;for(let e of t)if(e.tokens){let t=Parse.R(e.tokens,e.mode,i);l.push({text:t.map((t=>t.text)).join(""),type:e.type,tokens:t,mode:e.mode})}else"#{"==e.text&&"expr"==e.type?(l.push(new Token("${"),new Token(i),new Token("."),new Token("htmlEncode"),new Token("(")),r=!0):l.push(e);if(r){let t=[];"squote"===e?t=[new Token(","),new Token('"\'"')]:"dquote"===e&&(t=[new Token(","),new Token("'\"'")]),l.splice(l.length-1,0,...t,new Token(")"))}return l},M(t,e=[]){let i=[Parse.A(e),Parse.ws,".",Parse.ws,"map",Parse.ws,"(",Parse.ws],l=fregex.matchFirst(i,t);if(!l)return[null,null];let r=t.slice(l.length),s=Parse.U(r);if(null===s||0!==s)return[null,null];let n=new ParsedFunction(r.slice(s),!0,(()=>!1));return n&&fregex([Parse.ws,")",Parse.ws,fregex.zeroOrOne(";"),Parse.ws,fregex.end])(t.slice(l.length+n.P+n.J.length))?[[...n.S()],n.J]:[null,null]},I(t,e=[]){},N(t,e=[]){return fregex.matchAll(Parse.A(e),t).filter((e=>"."!=t[e.index-1]&&"?."!=t[e.index-1]))},q(expr){let result=[];for(let piece of expr)"this"==piece||"identifier"===piece.type||"number"===piece.type?result.push(piece+""):"string"!==piece.type&&"template"!==piece.type||result.push(eval(piece+""));return result}};let varExpressionCache_={};Parse.ws=fregex.zeroOrMore(fregex.or({type:"whitespace"},{type:"ln"}));let indexType_=[{type:"number"},{type:"hex"},{type:"string"},{type:"template"}];Parse.L=fregex.oneOrMore(fregex.or("this",".","[","]",{type:"identifier"},{type:"number"},{type:"hex"},{type:"string"},{type:"template"},{type:"whitespace"},{type:"ln"}));let terminator_=fregex.lookAhead([fregex.or(fregex.end,fregex.not(Parse.ws,"("))]),property_=fregex(fregex.or(fregex(Parse.ws,fregex.or(".","?."),Parse.ws,{type:"identifier"}),fregex(Parse.ws,fregex.zeroOrOne("?."),"[",Parse.ws,fregex.or(...indexType_),Parse.ws,"]")),terminator_);var div=document.createElement("div"),decodeCache_={},Html={decode(t){return t?t.replace(/&[#A-Z0-9]+;/gi,(t=>decodeCache_[t]||(div.innerHTML=t,decodeCache_[t]=div.textContent))):""},encode(t,e=""){return t=utils.toString(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\a0/g,"&nbsp;"),e.includes("'")&&(t=t.replace(/'/g,"&apos;")),e.includes('"')&&(t=t.replace(/"/g,"&quot;")),t}};class VText{text="";el=null;B=null;X=0;constructor(t="",e=null){this.B=e,null==t?t="":"string"==typeof t||t instanceof String||(t=JSON.stringify(t)),this.text=Html.decode(t)}D(t=null,e=null){if(e)this.el=e;else{let e;if("STYLE"!==t.tagName||this.B.contains(t.getRootNode()?.host))e=this.text;else{this.B.dataset.style||(this.B.constructor.styleId=(this.B.constructor.styleId||0)+1,this.B.dataset.style=this.B.constructor.styleId);let t=this.B.tagName.toLowerCase();e=VText.G(this.text,t,this.B.dataset.style)}this.el?this.el.textContent=e:(this.el=t.ownerDocument.createTextNode(e),(t=t.shadowRoot||t).insertBefore(this.el,t.childNodes[this.X])),Refract.elsCreated&&Refract.elsCreated.push(utils.toString(e))}return 1}K(){let t=new VText;return t.text=this.text,t.B=this.B,t}Y(){this.el.parentNode.removeChild(this.el)}static G(t,e,i){return t.replace(RegExp(e+"|:host","g"),e+'[data-style="'+i+'"]')}}class ScopeItem{path;value;constructor(t,e){this.path=t,this.value=e}K(){return new ScopeItem(this.path.slice(),this.value)}}class Scope extends Map{K(){let t=new Scope;for(let[e,i]of this)t.set(e,i.K());return t}Z(t){if("this"===t[0])return t;for(;t[0]in this;)t=[...this.get(t[0]).path,...t.slice(1)];return t}}class VExpression{tt=[];et=null;it=null;type="simple";isHash=!1;lt=null;rt=[];st=[];B=null;nt=null;ot=null;at=[];ft={};ht=new Scope;X=0;ct=0;ut=[];constructor(t=null,e=null,i=null,l=null){if(this.ot=e,e&&(this.B=e.B,this.ft={...e.ft},this.ht=e.ht.K()),t){let l="#{"==t[0].text;"${"!=t[0].text&&!l||"}"!=t[t.length-1].text||(this.isHash=l,t=t.slice(1,-1)),this.code=t.map((t=>t.text)).join("").trim();let r=Parse.N(t,i),[s,n]=Parse.M(t,i);if(n){this.type="loop",this.rt=s;for(let t of s)i.push(t);this.lt=this.B.constructor.createFunction(...i,"return "+r[0].join(""));let t=n.filter((t=>"whitespace"!==t.type&&"ln"!==t.type));this.st=1===t.length&&"template"===t[0].type?VElement.dt(t[0].tokens.slice(1,-1),i,e,this.B):[new VExpression(n,this,i)]}else{Parse.A(i)(t)!==t.length&&(this.type=Parse.L(t)===t.length?"simple":"complex"),t=Parse.R(t,null,this.B.constructor.name);let e=(t=Parse.j(t)).map((t=>t.text)).join("");"{"!=t[0].text&&(e="return ("+e.trim()+")"),this.lt=this.B.constructor.createFunction(...i,e)}for(let t of r)this.tt.push(Parse.q(t))}}D(t=null,e=null){if(this.nt=t||this.nt,this.it){for(let e of this.it)t.removeAttribute(e);this.it=[];let e=this.xt();if(e){let i=lex(lexHtmlJs,e,"tag"),l=null;for(let e of i)"attribute"===e.type?(l&&t.setAttribute(l,""),l=e,this.it.push(l)):"string"===e.type&&(t.setAttribute(l,e.tokens[1]),l=null);l&&t.setAttribute(l,"")}return 0}{for(let t of this.at)if(t instanceof HTMLElement)t.parentNode.removeChild(t);else for(let e of t.slice())e.Y();this.at=this.gt();let t=0,e=this.X;for(let i of this.at)if(i instanceof HTMLElement)this.nt.insertBefore(i,this.nt.childNodes[e]),e++;else for(let l of i){l.X=e;let i=l.D(this.nt,null);e+=i,t+=i}return t}}K(t=null,e=null,i=null){let l=new VExpression;return l.tt=this.tt,l.et=this.et,l.it=this.it,l.type=this.type,l.lt=this.lt,l.rt=this.rt,l.st=this.st,l.B=t||this.B,l.nt=i||this.nt,l.ot=e||this.ot,l.X=this.X,l.ct=this.ct,l.ft={...this.ft},l.ht=this.ht.K(),l.isHash=this.isHash,l.code=this.code,l}xt(){return this.lt.apply(this.B,Object.values(this.ft))}gt(){for(let t of this.ut)Watch.remove(...t);this.ut=[],this.vt||(this.vt=this._t.bind(this)),this.bt(this.vt);let t=[];if("loop"!==this.type){let e=[this.xt()].flat().map((t=>void 0===t?"":t));if(this.isHash)t=[e.map((t=>new VText(t,this.B)))];else{let i=Object.keys(this.ft);for(let l of e)if(l instanceof HTMLElement)t.push(l);else if(l+="",l.length){let e=VElement.wt(l,i,this,this.B).flat();t.push(e)}}}else{let e=this.xt();if(!e)throw Error(`${this.tt[0].join(".")} is not iterable in ${this.code}`);let i=0;for(let l of e){let l=[],r=[e[i],i,e];for(let t of this.st){let e=t.K(this.B,this);this.yt(e,r,i),l.push(e)}t.push(l),i++}}return t}yt(t,e,i){t.ft={...this.ft},t.ht=this.ht.K();for(let l in this.rt){t.ft[this.rt[l]]=e[l];let r=[...this.tt[0],i+""],s=this.ht.Z(r);t.ht.set(this.rt[l],new ScopeItem(s,[e[l]]))}}_t(t,e,i,l,r){if(this.ot&&(Refract.Et=this,"loop"!==this.type||2>=e.length||!utils._(e.slice(0,-2),this.tt[0].slice(1))))if(this.B.__autoRender||!this.B.virtualElement){if(this.ct=this.Ht(),"complex"!==this.type&&e[e.length-1].match(/^\d+$/)){let i=e.slice(0,-1),l=delve(r,i);if(Array.isArray(l)&&utils.arrayEq(this.tt[0].slice(1),i)){let i=parseInt(e[e.length-1]);if("remove"===t){for(let t of this.at[i])t.Y();this.at.splice(i,1)}else{if("set"===t&&this.at[i])for(let t of this.at[i])t.Y();"insert"===t&&this.at.splice(i,0,[]),this.at[i]="simple"===this.type?[new VText(l[i],this.B)]:this.st.map((t=>t.K(this.B,this)));let e=0,r=this.kt(i),s=[l[i],i,l];for(let t of this.at[i])t.X=r+e,t.nt=this.nt,this.yt(t,s,e+i),t.D(this.nt,null),e++}return void this.Tt()}}this.D(),this.Tt(),Refract.Et=null}else this.B.__toRender.set(this,arguments)}Y(){for(let t of this.ut)Watch.remove(...t);this.ut=[];for(let t of this.at)if(t instanceof HTMLElement)t.parentNode.removeChild(t);else for(let e of t)e.Y();if(this.at=[],this.ot instanceof VElement){let t=this.ot.at.indexOf(this);this.ot.at.splice(t,1)}else for(let t of this.ot.at){let e=t.indexOf(this);if(e>=0){t.splice(e,1);break}}this.ot=null}Ht(){let t=0;for(let e of this.at)if(e instanceof HTMLElement)t++;else for(let i of e)i._t?t+=i.Ht():t++;return t}kt(t){let e=this.X;for(let i of this.at.slice(0,t))for(let t of i)t instanceof VExpression?e+=t.Ht():e++;return e}Wt(){let t=this.ot.at.flat(),e=t.indexOf(this);for(let i of t.slice(e+1))if(i instanceof VExpression)return i;return this.ot.nt===this.nt&&this.ot instanceof VExpression?this.ot.Wt():null}Tt(){let t=this.Ht()-this.ct,e=this;for(;e=e.Wt();)e.X+=t}bt(t){for(let e of this.tt){let i,l=this.B;if("this"===e[0])e=e.slice(1);else if(e[0]in this.ft&&e.length>1)l=this.ft[e[0]],e=e.slice(1);else if(i=this.ht.get(e[0])){let t=delve(l,i.path.slice(1));if("object"!=typeof t&&!Array.isArray(t))continue;l=delve(this.B,i.path.slice(1,-1)),e=i.path.slice(-1)}e.length&&("object"==typeof l||Array.isArray(l))&&(this.ut.push([l,e,t]),Watch.add(l,e,t))}}}lexHtmlJs.allowHashTemplates=!0;class VElement{tagName="";it={};Pt=[];B=null;el=null;ot=null;at=[];ft={};ht=new Scope;X=0;constructor(t=null,e=null,i=null){if(e instanceof HTMLElement?this.B=e:e&&(this.ot=e,this.B=e.B,this.ft={...e.ft},this.ht=e.ht.K()),t){let e="",l=t.filter((t=>"whitespace"!==t.type));for(let t,r=0;t=l[r];r++)if(0===r)this.tagName=t.text.slice(1);else if("attribute"===t.type)e=t.text,this.it[e]=[];else if(e&&"="==l[r-1]){let l=[];if("string"===t.type)for(let r of t.tokens.slice(1,-1))l.push("expr"===r.type?new VExpression(r.tokens,this,i,e):r.text);else"expr"===t.type&&l.push(new VExpression(t.tokens,this,i,e));this.it[e]=l,e=void 0}else if("expr"===t.type){let e=new VExpression(t.tokens,this,i);e.it=[],this.Pt.push(e)}else if(">"===t.text||"/>"===t.text)break}}D(t=null,e=null){t=t||this.parent;let i=this.tagName;"svg"===i&&(inSvg=!0);var l=this.el;if(e)this.el=e,e.querySelector("slot")||(this.B.Jt=e.innerHTML),e.innerHTML="";else{var r;if(Refract.Et=this,i.includes("-")&&customElements.get(i)){let t=customElements.get(i),e=[];t.prototype.init&&(e=Refract.compiler.populateArgsFromAttribs(this,t.Ct()));let l=2,n=i;for(;n.toUpperCase()in Refract.St;){n=i+"_"+l;var s=customElements.get(n);if(s){t=s;break}t=class extends t{},customElements.define(n,t),l++}r=new t(...e)}else r=inSvg?document.createElementNS("http://www.w3.org/2000/svg",i):document.createElement(i);if(l)l.parentNode.insertBefore(r,l),l.remove();else if(!l){let e=t.shadowRoot||t;e!==this.B&&e.tagName&&e.tagName.includes("-")&&"SLOT"!==r.tagName&&(e=e.querySelector("slot")||e),e.insertBefore(r,e.childNodes[this.X])}Refract.virtualElements.set(r,this),this.el=r,Refract.Et=null,Refract.elsCreated&&Refract.elsCreated.push("<"+i+">")}!this.el.shadowRoot&&"shadow"in this.it&&this.el.attachShadow({mode:this.el.getAttribute("shadow")||"open"});let n=0;if("slot"===i){let t=VElement.wt(this.B.Jt,Object.keys(this.ft),this,this.B);for(let e of t)e.ft={...this.ft},e.ht=this.ht.K(),e.X=n,n+=e.D(this.el)}let o="TEXTAREA"===this.el.tagName||this.it.contenteditable&&this.it.contenteditable+""!="false";for(let t of this.at){if(o&&t instanceof VExpression)throw Error("textarea and contenteditable can't have templates as children. Use value=${this.variable} instead.");t.ft={...this.ft},t.ht=this.ht.K(),t.B=this.B,t.X=n,n+=t.D(this.el)}for(let t in this.it){let e=this.it[t];for(let i of e)if(i instanceof VExpression){let l=i;l.nt=this.el,l.ft=this.ft,l.ht=this.ht.K(),l.bt((()=>{if("value"===t)setInputValue_(this.B,this.el,e,this.ft);else{let i=VElement.$t(this.B,e,this.ft);this.el.setAttribute(t,i)}}))}let i=VElement.$t(this.B,e,this.ft);if(this.el.setAttribute(t,i),"id"===t||"data-id"===t){let e=this.el.getAttribute(t).split(".");delve(this.B,e,this.el)}else if(t.startsWith("on")&&t in div){let e=(this.B&&this.B.constructor||window.RefractCurrentClass).createFunction,i=this.el.getAttribute(t);this.el.removeAttribute(t),this.el[t]=t=>{let l=["event","el",...Object.keys(this.ft)];e(...l,i).bind(this.B)(t,this.el,...Object.values(this.ft))}}}for(let t of this.Pt)t.ft=this.ft,t.ht=this.ht.K(),t.D(this.el),t.bt((()=>{t.D(this.el)}));let a="value"in this.it&&"option"!==i;if(a){let t=this.it.value;if(1===t.length&&t[0]instanceof VExpression&&"simple"===t[0].type){let e=(0,(this.B&&this.B.constructor||window.RefractCurrentClass).createFunction)(...Object.keys(this.ft),"val",t[0].code+"=val;").bind(this.B);utils.H(this.el,((t,i)=>{Refract.At=i,e(...Object.values(this.ft),t),Refract.At=null}))}}return a&&setInputValue_(this.B,this.el,this.it.value,this.ft),"svg"===i&&(inSvg=!1),1}K(t,e=null){let i=new VElement;i.tagName=this.tagName,i.B=t||this.B,i.ot=e;for(let t in this.it){i.it[t]=[];for(let e of this.it[t])i.it[t].push(e instanceof VExpression?e.K(i.B,this):e)}for(let t of this.Pt)i.Pt.push(t.K(i.B,this));for(let t of this.at)i.at.push(t.K(i.B,i));return i}Vt(name){let lname=name.toLowerCase(),val=name in this.it?this.it[name]:this.it[lname];if(null==val)return val;if(val&&1===val.length&&val[0]instanceof VExpression)return val[0].lt.apply(this.B,Object.values(this.ft));if(Array.isArray(val)&&!val.length)return!0;let result=VElement.$t(this.B,val||[],this.ft);try{result=JSON.parse(result)}catch(e){if(result.startsWith("${")&&result.endsWith("}"))try{result=eval(result.slice(2,-1))}catch(t){}}return result}Y(){for(let t of this.at)t.Y();this.el.parentNode.removeChild(this.el),this.ot=null}static Ut(t,e,i={}){let l=e.map((e=>e instanceof VExpression?e.lt.apply(t,Object.values(i)):e));return 1===l.length?l[0]:l.flat().map(utils.toString).join("")}static $t(t,e,i={}){let l=[];for(let r of e)if(r instanceof VExpression){let e=r.lt.apply(t,Object.values(i));Array.isArray(e)||e instanceof Set?e=Array.from(e).join(" "):e&&"object"==typeof e&&(e=e.constructor===Object?Object.entries(e).map((([t,i])=>`${t}: ${e[t]}; `)).join(""):""),l.push(e)}else l.push(Html.decode(r));return l.map(utils.toString).join("")}static wt(t,e=[],i=null,l){let r=lex(lexHtmlJs,[t].flat().join(""),"template");return VElement.dt(r,e,i,l)}static dt(t,e=[],i=null,l,r=!1,s=0){if(!t.length)return[];let n=[];do{let o=t[s];if("text"===o.type)n.push(new VText(o.text,i?.B));else if("expr"===o.type)n.push(new VExpression(o.tokens,i,e));else if("openTag"===o.type){let r=new VElement(o.tokens,i||l,e);n.push(r),"/>"==o.tokens[o.tokens.length-1].text||r.tagName.toLowerCase()in selfClosingTags_||(s++,r.at=VElement.dt(t,e,r,l,!1,s),s=r.at.index)}else if("closeTag"===o.type)break;if(n.length===r)break;s++}while(t.length>s);return n.index=s,n}}var selfClosingTags_={area:1,base:1,br:1,col:1,embed:1,hr:1,img:1,input:1,link:1,meta:1,param:1,source:1,track:1,wbr:1,command:1,keygen:1,menuitem:1},inSvg=!1;function setInputValue_(t,e,i,l){if(Refract.At&&e===Refract.At.target)return;let r="TEXTAREA"===e.tagName||e.hasAttribute("contenteditable")&&"false"!==e.getAttribute("contenteditable");if(r||"INPUT"===e.tagName){let s=VElement.$t(t,i,l);r?e.innerHTML=s:"checkbox"===e.type?e.checked=["1","true"].includes((s+"").toLowerCase()):e.value=s}else{let r=VElement.Ut(t,i,l);if("SELECT"===e.tagName)for(let t of e.children)t.selected=Array.isArray(r)?r.includes(t.value):r===t.value;else e.value=r}}let cache_=new Map,divCache_=new WeakMap,templateCache_=new WeakMap;function createEl(t,e=!0,i=document){if(e&&(t=t.trim()),t.match(/^<\S+-\S+/)){let e=divCache_.get(i);return e||divCache_.set(i,e=i.createElement("div")),e.innerHTML=t,e.removeChild(e.firstChild)}let l=cache_.get(t);if(l)return l.cloneNode(!0);let r=templateCache_.get(i);return r||templateCache_.set(i,r=i.createElement("template")),r.innerHTML=t,r.content.querySelector("slot")||cache_.set(t,r.content.firstChild.cloneNode(!0)),r.content.removeChild(r.content.firstChild)}class Compiler{static createModifiedClass(t){let e={};e.jt=t;let i=`\n\t\t\t__preInit = (${""+(()=>{if("autoRender"in this?this.__autoRender=this.autoRender:"__autoRender"in this||(this.__autoRender=!0),!1!==Object.getOwnPropertyDescriptor(this,"autoRender")?.configurable&&Object.defineProperty(this,"autoRender",{get(){return this.__autoRender},set(t){this.__autoRender=t,t&&this.render()}}),this.__autoRender&&this.render(),this.init){let t=this.parentElement?Refract.compiler.populateArgsFromAttribs(this,this.constructor.Ct()):this.Ft;this.init(...t)}})})()`;return t.prototype.html&&(e.tagName=Parse.F(""+t.prototype.html),e.code=(""+t).slice(0,-1)+i+"}"),e}static decorateAndRegister(t,e){t.tagName=e.tagName,t.constructorArgs=e.constructorArgs,t.htmlTokens=e.htmlTokens;for(let i of Object.getOwnPropertyNames(e.jt.prototype))"constructor"!==i&&(t.prototype[i]=e.jt.prototype[i]);for(let i of Object.getOwnPropertyNames(e.jt))i in Refract||(t[i]=e.jt[i]);customElements.define(e.tagName,t)}static populateArgsFromAttribs(t,e){const i=e=>{for(let l in e)e[l]?i(e[l]):e[l]=t.Vt(l);return e};let l=[];for(let r of e)l.push("string"==typeof r?t.Vt(r):i(r));return l}}lexHtmlJs.allowHashTemplates=!0;class Refract extends HTMLElement{static compiler=Compiler;static tagName;static St={};static htmlTokens=null;static virtualElement;static Et=null;static constructorArgs=null;static initArgs=null;static virtualElements=new WeakMap;static elsCreated=!1;static At;Jt="";__autoRender=!0;__toRender=new Map;virtualElement=null;__connected=!1;__connectedCallbacks=[];__firstConnectedCallbacks=[];__disconnectedCallbacks=[];constructor(t=!0){super(),!1===t&&(this.__autoRender=!1),this.Ft=arguments}render(){if(this.__autoRender=!0,!this.virtualElement){if(!this.constructor.virtualElement){if(this.html&&"function"==typeof this.html&&(this.constructor.htmlTokens=Parse.O(""+this.html),!this.constructor.htmlTokens))throw Error("Class is missing an html function with a template value.");this.constructor.virtualElement=VElement.dt(this.constructor.htmlTokens,[],null,this,1)[0],this.constructor.htmlTokens=null}Refract.St[this.tagName]=!0,this.virtualElement=this.constructor.virtualElement.K(this),this.virtualElement.D(null,this),delete Refract.St[this.tagName]}if(this.__toRender.size){for(let t of this.__toRender.keys()){let e=t;for(;e=e.ot;)if(this.__toRender.has(e)){this.__toRender.delete(t);break}}for(let[t,e]of this.__toRender.entries())t._t(...e);this.__toRender=new Map}}Vt(name,alt){let velement=Refract.Et;if(velement)return velement.getAttrib(name);{let hval=this.getAttribute(name);if(null===hval)return alt;let val=Html.decode(hval);try{return JSON.parse(val)}catch{}if(val.startsWith("${")&&val.endsWith("}"))try{return eval("("+val.slice(2,-1)+")")}catch{}return val}}static Ct(){if(!this.initArgs&&this.prototype.init){let t=new ParsedFunction(this.prototype.init,!1);this.initArgs=[...t.S()]}return this.initArgs||[]}onConnect(t){this.__connected&&t(),this.__connectedCallbacks.push(t)}onFirstConnect(t){this.__connected?t():this.__firstConnectedCallbacks.push(t)}onDisconnect(t){this.__connected&&t(),this.__disconnectedCallbacks.push(t)}connectedCallback(){this.__connected=!0;for(let t of this.__connectedCallbacks)t();for(let t of this.__firstConnectedCallbacks)t();this.__firstConnectedCallbacks=[]}disconnectedCallback(){this.__connected=!1;for(let t of this.__disconnectedCallbacks)t()}static compile(){return`\n\t\t\t(() => {\n\t\t\t\t${this.name}.createFunction = (...args) => {\n\t\t\t\t\tlet params = args.slice(0, -1).join(',');\n\t\t\t\t\tlet code = args[args.length-1];\n\t\t\t\t\treturn eval(\`(function(\${params}) {\${code}})\`);\n\t\t\t\t};\n\t\t\t\tlet modified = ${this.name}.compiler.createModifiedClass(${this.name});\n\t\t\t\t${this.name} = eval('('+modified.code+')');\t\t\n\t\t\t\t${this.name}.compiler.decorateAndRegister(${this.name}, modified);\n\t\t\t\treturn ${this.name};\t\n\t\t\t})();\t\t\n\t\t`}}Refract.St={},Refract.htmlDecode=Html.decode,Refract.htmlEncode=Html.encode;var h=(t,e="\"'")=>Html.encode(t,e);export default Refract;export{utils as Utils,Watch,delve,fregex,h,lex,lexHtmlJs};