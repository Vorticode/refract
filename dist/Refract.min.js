// Version 2023.2.8.1621
// License: MIT
// https://github.com/vorticode/Refract
var descendIf=(t,e,i=null)=>l=>{if(t instanceof RegExp){let s=l.match(t)||[];if(s.length)return i&&i(s),[s[0],e]}else if(l.startsWith(t))return i&&i(t),[t,e]},ascendIf=t=>e=>{if(t instanceof RegExp){let i=e.match(t)||[];if(i.length)return[i[0],-1]}else if(e.startsWith(t))return[t,-1]},functionize=t=>{for(let e in t)for(let i in t[e]){let l=t[e][i];if(Array.isArray(l)){let s={};for(let t of l)s[t[0]]=[...s[t[0]]||[],t];t[e][i]=t=>{let e=s[t[0]];if(e)for(let i of e)if(t.startsWith(i))return[i]}}else"string"==typeof l?t[e][i]=t=>[t.startsWith(l)?l:void 0]:l instanceof RegExp&&(t[e][i]=t=>[(t.match(l)||[])[0]])}};{let t=["push","pop","splice","shift","sort","reverse","unshift"],e={get(t,e){if("$"===e[0]){if("$removeProxy"===e)return t;if("$isProxy"===e)return!0;if("$trigger"===e)return e=>{let i=WatchUtil.getRoots(t);for(let l of i)for(let i of WatchUtil.getCallbacks(l))i("set",e||[],t);return i}}let i=t[e];if(e===Symbol.iterator)return i;if("function"==typeof i){let i=t.$removeProxy||t,l=i[e];return l.prototype?l:l.bind(i)}if(i&&"object"==typeof i){i=i.$removeProxy||i;let l=WatchUtil.getRoots(t);for(let s of l){let l=WatchUtil.getPaths(s,t);for(let t of l)WatchUtil.addPath(s,[...t,e],i)}return WatchUtil.getProxy(i)}return i},set(t,i,l){let s=t[i];if(s===(l=utils.removeProxies(l)))return!0;t[i]=l;let r=e.getWatchedPaths(t,i);for(let t of r){let e=WatchUtil.getCallbacks(t[0]);for(let i of e)i("set",t[1],l,s,t[0])}return!0},getWatchedPaths(t,e){let i=WatchUtil.getRoots(t),l=[];for(let s of i){let i=WatchUtil.getPaths(s,t);for(let t of i){let i=[...t,e];l.push([s,i])}}return l},deleteProperty(t,e){Array.isArray(t)?t.splice(e,1):delete t[e];let i=WatchUtil.getRoots(t);for(let l of i){let i=WatchUtil.getPaths(l,t);for(let t of i){let i=[...t,e];for(let t of WatchUtil.getCallbacks(l))t("set",i)}}return!0}};var WatchUtil={proxies:new WeakMap,roots:new WeakMap,callbacks:new WeakMap,paths:new WeakMap,getProxy(i){let l=WatchUtil.proxies.get(i);if(!l&&(WatchUtil.proxies.set(i,l=new Proxy(i,e)),Array.isArray(i))){Object.defineProperty(l,"indexOf",{enumerable:!1,get:()=>t=>i.findIndex((e=>utils.removeProxy(e)===utils.removeProxy(t)))}),Object.defineProperty(l,"lastIndexOf",{enumerable:!1,get:()=>t=>i.findLastIndex((e=>utils.removeProxy(e)===utils.removeProxy(t)))}),Object.defineProperty(l,"includes",{enumerable:!1,get:()=>t=>-1!==i.findIndex((e=>utils.removeProxy(e)===utils.removeProxy(t)))});for(let e of t)Object.defineProperty(l,e,{configurable:!0,enumerable:!1,get:()=>(...t)=>WatchUtil.arrayFunction(i,e,t)})}return l},arrayFunction(t,e,i){let l=t.length,s=0;if("push"===e)s=l;else if("pop"===e)s=l-1;else if("splice"===e&&(s=0>i[0]?l-i[0]:i[0],0>s||s+i[1]>t.length))throw Error("Invalid index "+s);let r=Array.prototype[e].apply(t,i);["splice","shift","sort","reverse","unshift"].includes(e)&&WatchUtil.t(t,s,null,null);let n=Array.from(WatchUtil.getRoots(t));for(let a of n){let n=WatchUtil.getPaths(a,t);for(let f of WatchUtil.getCallbacks(a))for(let h of n)if("pop"===e)f("remove",[...h,s+""],r,null,a);else if("shift"===e)f("remove",[...h,"0"],r,null,a);else if("unshift"===e)f("insert",[...h,"0"],t[0],null,a);else if("splice"===e){let e=i[1],l=i.length-2,n=Math.min(l,e);for(o=0;n>o;o++)f("set",[...h,s+o+""],t[s+o],null,a);if(l>e)for(o=n;l>o;o++)f("insert",[...h,s+o+""],t[s+o],null,a);else if(e>l)for(o=e-1;o>=n;o--)f("remove",[...h,s+o+""],r[o-n+1],null,a)}else{for(var o=s;t.length>o;o++)f("set",[...h,o+""],t[o],null,a);for(;l>o;o++)f("delete",[...h,o+""],null,a)}}return r},t(t,e,i,l){if(i=i||[],void 0===e&&(e=0),!(l=l||new WeakSet).has(t)){if(l.add(t),i.length){let e=WatchUtil.roots.get(t);if(!e)return;for(let l of e){let e=WatchUtil.getPaths(l,t);for(let s in e){let r=e[s],n=r.length-i.length;if(n>=0){let o=r.slice();for(let t=n;r.length>t;t++)o[t]=i[t-n];let a=l;for(let t of o)if(a=a[t],!a)break;a===t&&(e[s]=o)}}}}if(Array.isArray(t))for(let s=e;t.length>s;s++)(Array.isArray(t[s])||isObj(t[s]))&&WatchUtil.t(t[s],0,[...i,s+""],l);else if(isObj(t))for(let e in t)(Array.isArray(t[e])||isObj(t[e]))&&WatchUtil.t(t[e],0,[...i,e+""],l)}},getRoots(t){return WatchUtil.roots.get(t=t.$removeProxy||t)||[]},addPath(t,e,i){t=t.$removeProxy||t;let l=WatchUtil.roots.get(i=i.$removeProxy||i);l||WatchUtil.roots.set(i,l=new Set),l.add(t);let s=WatchUtil.paths.get(t);s||WatchUtil.paths.set(t,s=new WeakMap);let r=s.get(i);if(r){for(let t of r){let i=t.length;if(i>e.length)continue;let l=!1;for(let s=0;i>s&&!(l=t[s]!==e[s]);s++);if(!l)return}r.push(e)}else s.set(i,[e])},getPaths(t,e){let i=WatchUtil.paths.get(t);return i&&i.get(e.$removeProxy||e)||[]},addCallback(t,e){let i=WatchUtil.callbacks.get(t=t.$removeProxy||t);i||WatchUtil.callbacks.set(t,i=[]),i.push(e)},getCallbacks(t){return WatchUtil.callbacks.get(t=t.$removeProxy||t)||[]}},watchProxy=(t,e)=>(WatchUtil.addPath(t,[],t),WatchUtil.addCallback(t,e),WatchUtil.getProxy(t))}function delve(t,e,i=delve.dontCreate,l=!1){let s=i!==delve.dontCreate;if(!t&&!s&&e.length)return;let r=0;for(let n of e){let o=r===e.length-1;if(l&&"object"==typeof(t=t.$removeProxy||t)&&(t.$disableWatch=!0),void 0===t[n]){if(!s)return void delete t.$disableWatch;o||(t[n]=(e[r+1]+"").match(/^\d+$/)?[]:{})}o&&s&&(t[n]=i),l&&delete t.$disableWatch,t=t[n],l&&(t=null!=t?t.$removeProxy||t:null),r++}return t}delve.dontCreate={};class WatchProperties{constructor(t){this.i=t,this.l={},this.o=watchProxy(this.l,this.h.bind(this)),this.u={}}h(t,e,i,l){if("info"===t)return this.u;let s=this.getAllCallbacks(e,t,i,l);for(let[t,e]of s)t.apply(this.i,e)}getAllCallbacks(t,e,i,l){let s=[],r=csv(t),n=t.slice(0,-1);for(;n.length;){let r=csv(n);if(r in this.u)for(let n of this.u[r])s.push([n,[e,t,i,l,this.i]]);n.pop()}if(r in this.u)for(let n of this.u[r])s.push([n,[e,t,i,l,this.i]]);let o=delve(this.i,t,delve.dontCreate,!0);for(let t in this.u)if(t.startsWith(r)&&t.length>r.length){let i=t.slice(r.length>0?r.length+1:r.length),n=JSON.parse("["+i+"]"),a=utils.removeProxy(delve(l,n,delve.dontCreate,!0)),f=utils.removeProxy(delve(o,n,delve.dontCreate,!0));if(a!==f){let i=this.u[t];if(i.length){let l=JSON.parse("["+t+"]");for(let t of i)s.push([t,[e,l,f,a,this.i]])}}}return s}m(t,e){t.startsWith&&(t=[t]);let i=this,l=t[0];l in i.l||(i.l[l]=i.i[l],delete i.i[l],Object.defineProperty(i.i,l,{enumerable:1,configurable:1,get:()=>i.i.$disableWatch?i.l[l]:i.o[l],set(t){i.i.$disableWatch?i.o.$removeProxy[l]=t:i.o[l]=t}}));let s=csv(t);s in i.u||(i.u[s]=[]),i.u[s].push(e)}p(t,e){t.startsWith&&(t=[t]);let i=csv(t);if(i in this.u){if(e){let t=this.u[i].indexOf(e);this.u[i].splice(t,1)}if(!e||!this.u[i].length){delete this.u[i];let e=csv([t[0]]);if(!utils.g(this.u,e)){t[0]in this.i&&(delete this.i[t[0]],this.i[t[0]]=this.l[t[0]]);let e=WatchUtil.roots.get(this.l[t[0]]);e&&(e.delete(this.l),e.size||WatchUtil.roots.delete(this.l[t[0]])),delete this.l[t[0]],Object.keys(this.l).length||(WatchUtil.paths.delete(this.l),WatchUtil.roots.delete(this.l),WatchUtil.roots.delete(this.i[t[0]])),Object.keys(this.i).length||(WatchUtil.paths.delete(this.i),WatchUtil.roots.delete(this.i))}}}}}var Watch={objects:new WeakMap,add(t,e,i){t=utils.removeProxy(t);var l=Watch.objects.get(t);l||Watch.objects.set(t,l=new WatchProperties(t)),l.m(e,i)},remove(t,e,i){t=utils.removeProxy(t);var l=Watch.objects.get(t);if(l){if(e)l.p(e,i);else for(let t in l.u)l.p(t);Object.keys(l.u).length||Watch.objects.delete(t)}}},utils={v(t,e,i){"string"==typeof e&&(e=[e]);var l=e.length;for(let s=i=i||0;t.length>s;s++)for(let i=0;l>i;i++){let l=e[i];if(t.slice(s,s+l.length)===l)return t.slice(s)}return t},removeProxy(t){return t&&t.$removeProxy||t},removeProxies(t,e){if(null==t)return t;if(t.$isProxy&&(t=t.$removeProxy),"object"==typeof t){if(e){if(e.has(t))return t}else e=new WeakSet;e.add(t);for(let i in Object.keys(t)){let l=t[i],s=this.removeProxies(l,e);if(s!==l)if(Object.getOwnPropertyDescriptor(t,i).writable)t[i]=s;else{let e=Watch.objects.get(t);(e?e.l:t)[i]=s}}}return t},_(t,e){if(t.length!==e.length)return!1;for(let i=0;t.length>i;i++)if(t[i]!==e[i])return!1;return!0},H(t,e){for(let i=0;e.length>i;i++)if(t[i]!==e[i])return!1;return!0},g(t,e){for(let i in t)if(i.startsWith(e))return!0;return!1},toString(t){return null==t?"":t+""},T(t){return t.replace(/\\r/g,"\r").replace(/\\n/g,"\n").replace(/\\t/g,"\t")},k(t,e){let i=t.tagName,l=t.hasAttribute("contenteditable")&&"false"!==t.getAttribute("contenteditable");"TEXTAREA"===i||l||"INPUT"===i&&!["button","color","file","hidden","image","radio","reset","submit"].includes(t.getAttribute("type"))?t.addEventListener("input",(i=>{let s=t.getAttribute("type")||"",r=l?t.innerHTML:t.value;"number"===s||"range"===s?r=parseFloat(r):"datetime-local"===s||"datetime"===s?r=new Date(r):"checkbox"===t.type&&(r=t.checked),e(r,i)}),!0):t.addEventListener("change",(s=>{let r;r="SELECT"===i&&t.hasAttribute("multiple")?Array.from(t.children).filter((t=>t.selected)).map((t=>t.value)):l?t.innerHTML:t.value,e(r,s)}),!0)}},csv=t=>JSON.stringify(t).slice(1,-1),isObj=t=>t&&"object"==typeof t;{let t=null,e=0,i=[],l=0,s=/^[ \t\v\f\xa0]+/,r=/^\r?\n/,n=/^<!?([\w\xA0-\uFFFF:-]+)/i,o=/^<\/[\w\xA0-\uFFFF:-]+\s*>/i,a="&& || => <<= >>= &= ^= |= &&= ||= & | ^ ~ >>> << >> === !=== == != >= > <= < = **= += -= *= /= %= ??= ++ -- ** + - * / % , ... . ( ) [ ] ?. ? : !".split(/ /g),f={};for(let t of a)f[t[0]]=[...f[t[0]]||[],t];let h=t=>{if("{"===t[1])return lexHtmlJs.allowHashTemplates&&t.startsWith("#{")||t.startsWith("${")?(l>0||(l=1),i.push(e),e=0,[t.slice(0,2),"js"]):void 0},c=t=>{if("`"===t[0])return--l,e=i.pop(),["`",-1]},u={attribute:/^[\-_$\w\xA0-\uFFFF:]+/i,string:t=>descendIf("'","squote")(t)||descendIf('"',"dquote")(t),equals:"=",tagEnd:t=>">"===t[0]?[">",-1]:t.startsWith("/>")?["/>",-1]:void 0},m=(e,i,l)=>{let s=l[l.length-1];if("script"===t&&s&&s.tokens&&">"==s.tokens[s.tokens.length-1])return["","js"]},p="await break case catch class constructor const continue debugger default delete do enum else export extends\n\t\t\t\tfinally for function if implements import in instanceof interface let new package private protected public\n\t\t\t\treturn static super switch this throw try typeof var void while with yield".split(/\s+/g),d="{ ( [ . ; , < > <= >= == != === !== + - * % << >> >>> & | ^ ! ~ && || ? : = += -= *= %= <<= >>= >>>= &= |= ^= /=".split(/ /g);var lexHtmlJs={js:{whitespace:s,ln:r,comment:/^\/\/.*(?=\r?\n)|^\/\*[\s\S]*?\*\//,end:t=>t.startsWith("<\/script>")?["",-1]:void 0,regex(t,e,i){if("/"!==t[0])return;if(i.length){let t;for(let e=i.length-1;e>=0;e--)if("ln"!==i[e].type&&"whitespace"!==i[e].type&&"comment"!==i[e].type){t=i[e]+"";break}if(!d.includes(t))return}let l=1;for(;;){if(l=t.indexOf("/",l+1),-1===l)return;try{let e=t.slice(0,l+1);return RegExp(e.slice(1,-1)),[e+t.slice(e.length).match(/^[agimsx]*/)[0]]}catch(t){}}},hex:/^0x[0-9a-f]+/,number:/^-?\d*\.?\d+(e\d+)?/,identifier(t){let e=(t.match(/^[_$a-z\xA0-\uFFFF][_$\w\xA0-\uFFFF]*/i)||[])[0];if(!p.includes(e))return[e]},template(t){if("`"===t[0])return++l,i.push(e),e=0,["`","template"]},brace1(t){if("{"===t[0])return e++,["{"]},brace2(t){if("}"===t[0])return 0===e&&l?(e=i.pop(),["}",-1]):(e--,["}"])},semicolon:";",keyword:p,operator:a,string:/^"(\\\\|\\"|[^"])*"|^'(\\\\|\\'|[^'])*'/},html:{script:m,comment:descendIf("\x3c!--","htmlComment"),closeTag:o,openTag:descendIf(n,"tag",(e=>t=e[1])),text:/^[\s\S]+?(?=<|$)/},htmlComment:{commentEnd:ascendIf("--\x3e"),commentBody:/^[\s\S]+?(?=-->|$)/},template:{script:m,expr:h,comment:descendIf("\x3c!--","templateComment"),closeTag:o,openTag:descendIf(n,"templateTag",(e=>t=e[1])),templateEnd:c,text(t){let e=t.match(lexHtmlJs.allowHashTemplates?/^(?:\\#{|\\\${|\s|(?!(#{|\${|`|<[\w\xA0-\uFFFF!:/-]|$)).)+/:/^(?:\\\${|\s|(?!(\${|`|<[\w\xA0-\uFFFF!:/-]|$)).)+/);if(e){let t=e[0];return t=utils.T(t),[t,void 0,e[0].length]}}},templateComment:{expr:h,commentEnd:ascendIf("--\x3e"),commentBody:t=>t.match(lexHtmlJs.allowHashTemplates?/^[\s\S]+?(?=-->|[$#]{|$)/:/^[\s\S]+?(?=-->|\${|$)/)||[]},tag:{whitespace:/^[ \r\n\t\v\f\xa0]+/,...u},templateTag:{whitespace(t){let e=t.match(/^( |\r|\n|\t|\v|\f|\xa0|\\r|\\n|\\t|\\v|\\f|\\xa0)+/);if(e){let t=e[0];return t=utils.T(t),[t,void 0,e[0].length]}},expr:h,templateEnd:c,...u},squote:{expr:h,quote:ascendIf("'"),text:t=>t.match(lexHtmlJs.allowHashTemplates?/^(?:\\'|(?!'|#{|\${)[\S\s])+/:/^(?:\\'|(?!'|\${)[\S\s])+/)||[]},dquote:{expr:h,quote:ascendIf('"'),text:t=>t.match(lexHtmlJs.allowHashTemplates?/^(?:\\"|(?!"|#{|\${)[\S\s])+/:/^(?:\\"|(?!"|\${)[\S\s])+/)||[]},allowHashTemplates:!1};function expandFastMatch_(t){for(let e in t)if(t[e].length||expandFastMatch_(t[e]),e.length>1){let i=e;if(e.includes("a-z")){for(let e of"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ")t[e]=t[i];e=e.replace("a-z","")}if(e.includes("0-9")){for(let e of"0123456789")t[e]=t[i];e=e.replace("0-9","")}if(e.length>1)for(let l of e)t[l]=t[i];delete t[i]}Object.freeze(t)}functionize(lexHtmlJs),lexHtmlJs.fastMatch={html:{"<":{"/":[lexHtmlJs.html,"closeTag"],"a-z0-9":[lexHtmlJs.html,"openTag"],"!":[lexHtmlJs.html,"comment"]},"a-z0-9 \t\r\n":[lexHtmlJs.html,"text"]},tag:{"a-z0-9":[lexHtmlJs.tag,"attribute"]," \t\r\n":[lexHtmlJs.tag,"whitespace"],'"':[lexHtmlJs.tag,"string"],"'":[lexHtmlJs.tag,"string"],">":[lexHtmlJs.tag,"tagEnd"],"/":{">":[lexHtmlJs.tag,"tagEnd"]},"=":[lexHtmlJs.tag,"equals"]},dquote:{'"':[lexHtmlJs.dquote,"quote"],"a-z0-9 \t.()[]/":[lexHtmlJs.dquote,"text"],"$#":[lexHtmlJs.dquote,"expr"]},js:{" \t\v\f ":[lexHtmlJs.js,"whitespace"],"=&|^!+-*%,.()[]?!>:":[lexHtmlJs.js,"operator"],"\r\n":[lexHtmlJs.js,"ln"],";":[lexHtmlJs.js,"semicolon"],"/":{"/*":[lexHtmlJs.js,"comment"]},"{":[lexHtmlJs.js,"brace1"],"}":[lexHtmlJs.js,"brace2"],W:[lexHtmlJs.js,"identifier"],"0-9":[lexHtmlJs.js,"number"],"'\"":[lexHtmlJs.js,"string"],"`":[lexHtmlJs.js,"template"]},template:{"`":[lexHtmlJs.template,"templateEnd"],"$#":[lexHtmlJs.template,"expr"],"<":{"a-z":[lexHtmlJs.template,"openTag"],"/":[lexHtmlJs.template,"closeTag"],"!":[lexHtmlJs.template,"comment"]}},templateTag:{$:[lexHtmlJs.templateTag,"expr"]},templateComment:{"-":[lexHtmlJs.templateComment,"commentEnd"],"a-z0-9\t\r\n ":[lexHtmlJs.templateComment,"commentBody"]}},lexHtmlJs.fastMatch.templateTag=lexHtmlJs.fastMatch.tag;for(let t in lexHtmlJs.fastMatch)expandFastMatch_(lexHtmlJs.fastMatch[t]);Object.freeze(lexHtmlJs.fastMatch)}function fregex(...t){return t=prepare(t),(e,i=[])=>{let l=0;for(let s of t){let t=s(e.slice(l),i);if(!1===t)return!1;l+=t}return l}}fregex.capture=(...t)=>(t=prepare(t),(e,i=[])=>{let l=0;for(let s of t){let t=s(e.slice(l),i);if(!1===t)return!1;l+=t}return i.push(e.slice(0,l)),l}),fregex.or=(...t)=>(t=prepare(t),(e,i=[])=>{for(let l of t){let t=l(e,i);if(!1!==t)return t}return!1}),fregex.not=(...t)=>{let e=fregex(t);return(t,i=[])=>!1===e(t,i)&&0},fregex.zeroOrOne=(...t)=>{let e=fregex(t);return(t,i=[])=>{let l=e(t,i);return!1===l?0:l}},fregex.xOrMore=(t,...e)=>{let i=fregex(e);return(e,l=[])=>{let s=0;for(let r=0;e.length;r++){let n=i(e,l);if(!1===n)return r>=t&&s;s+=n||1,e=e.slice(n||1)}return s}},fregex.zeroOrMore=(...t)=>fregex.xOrMore(0,...t),fregex.oneOrMore=(...t)=>fregex.xOrMore(1,...t),fregex.matchFirst=(t,e,i=0,l=[])=>{let s=fregex.matchAll(t,e,1,i,l);return s.length?s[0]:null},fregex.matchAll=(t,e,i=1/0,l=0,s=[])=>{Array.isArray(t)&&(t=fregex(t));let r=[];for(let n=l;e.length>n&&i>r.length;n++){let i=t(e.slice(n),s);!1!==i&&r.push(Object.assign(e.slice(n,n+i),{index:n}))}return r},fregex.lookAhead=(...t)=>(t=prepare(t),(e,i=[])=>{for(let l of t)if(!1===l(e,i))return!1;return 0}),fregex.end=t=>!t.length&&0;var prepare=t=>{Array.isArray(t[0])&&1===t.length&&(t=t[0]);let e=[];for(let i in t){let l=t[i];e[i]="string"==typeof l?t=>t[0]==l:Array.isArray(l)?fregex(l):"object"!=typeof l||l.prototype?t[i]:t=>{for(let e in l)if(t[0][e]!=l[e])return!1;return 1}}return e};function fastLex(t,e,i){let l;if(!t.fastMatch)return[!1,!1];let s=t.fastMatch[e];if(s){let t=0;do{if(s=s[i[t]],s&&s.length){[s,l]=s,s=s[l];break}t++}while(s)}return[s,l]}function valueOf(){return this.text}function toString(){return this.text}class Token{constructor(t,e,i,l,s,r,n){this.text=t,this.type=e,this.mode=i,this.line=l,this.col=s,this.originalLength=r,this.tokens=n}valueOf(){return this.text}toString(){return this.text}}function lex(t,e,i=null,l={},s=1,r=1,n=0){let o;i=i||Object.keys(t)[0];let a="";if(256>(e+="").length){var f=i+"|"+e.slice(0,24);if(o=cache[f],o&&o[0]===e)return o[1]}for(o=[];e.length>n;){let f,h,c,u,m,p=e.slice(0,n),d=e.slice(n);if([c,u]=fastLex(t,i,d),c&&([f,m,h]=c(d,p,o)||[]),!f){let e=t[i];for(u in e){let t=e[u];if([f,m,h]=t(d,p,o)||[],void 0!==f)break}}if(void 0===f){if(l.failOnUnknown){let t=e.slice(Math.max(n-15,0),n),l=d.slice(0,25).replace(/\r/g,"\\r").replace(/\n/g,"\\n");throw Error(`Unknown token within "${i}" at ${s}:${r}\r\n"${t+"⚠️"+l}"`)}a+=e.slice(0,1),e=e.slice(1);continue}a.length&&(f=a,m=!1,a="");let x={text:f,type:u,mode:m&&-1!==m?m:i,line:s,col:r,originalLength:h,valueOf,toString},g=h||f.length;if(-1===m)return[...o,x];if(m){let a=lex(t,e,m,l,s,r+g,n+g);if(!1===a)return o;let h=[x,...a].filter((t=>t.text.length));g=h.reduce(((t,e)=>t+(e.originalLength||e.text.length)),0),x={text:e.slice(n,n+g),type:u,tokens:h,mode:i,line:s,col:r,valueOf,toString},g!==f.length&&(x.originalLength=g)}if(g){if(n+=g,l.callback&&!1===l.callback(x))return o;o.push(x);let t=-1;for(let e=0,i=f.length;i>e;e++)"\n"==f[e]&&(s++,t=e);r=(t>-1?-t:r)+g}}return 256>e.length&&(cache[f]=[e,o]),o}var cache={};class ParsedFunction{name;type;P;J;S;j;constructor(t,e=!0,i=null){if("function"==typeof t&&(t=""+t),"string"==typeof t){let i;if(!e){let t=0;i=e=>{if("("===e.text?t++:")"===e.text&&t--,0===t&&("{"===e.text||"=>"===e.text))return!1}}t=lex(lexHtmlJs,t,"js",{callback:i})}i=i||(t=>{throw Error(t)});const l=(t,e=0)=>{let i=Parse.A(t,e);return null===i?-1:(this.J=t.slice(e+1,i-1),i-1)};if("function"===t[0].text){this.type="function";let e=t.slice(1).findIndex((t=>!["whitespace","ln","comment"].includes(t.type)));if(-1===e)return i("Not enough tokens to be a function.");"identifier"===t[e+1].type&&(this.name=t[e+1].text);let l=t.slice(e+1).findIndex((t=>"("===t.text));if(-1===l)return i("Cannot find opening ( for function arguments.");this.P=e+1+l+1}else if("identifier"===t[0].type){let e=t.findIndex((t=>"operator"===t.type));-1!==e&&"("===t[e]?.text&&(this.type="method",this.name=t[0].text,this.P=e+1)}if(["function","method"].includes(this.type)){let s=l(t,this.P-1);if(-1===s)return i("Cannot find closing ) and end of arguments list.");if(e){let e=t.slice(s).findIndex((t=>"{"===t.text));if(-1===this.S)return i("Cannot find start of function body.");this.S=s+e}}if(!this.type){let s,r;if("("===t[0].text){if(this.P=1,r=l(t,0),-1===r)return i("Cannot find ) and end of arguments list.");s="Params"}else r=1,s="Param",this.J=[t[0]];if(e){let e=t.slice(r).findIndex((t=>"=>"===t.text));if(-1===e)return i("Cannot find arrow before function body.");let l=t.slice(r+e+1).findIndex((t=>!["whitespace","ln","comment"].includes(t.type)));if(-1===l)return i("Cannot find function body.");this.S=r+e+1+l,this.type="{"===t[this.S]?.text?`arrow${s}Brace`:"arrow"+s}}if(e){let e,l=["arrowParam","arrowParams"].includes(this.type);if(l){const i=["{","(","["],l=["}",")","]"],s=[";",",",...l];let r=!1;for(let n,o=this.S;n=t[o];o++)if(!["whitespace","comment"].includes(n.type))if(i.includes(n.text))o=Parse.A(t,o,i,l);else{if(s.includes(n.text)){e=o;break}if("operator"===n.type)r=!0;else if(r||"ln"!==n.type)r=!1;else{let i=t.slice(o).find((t=>!["whitespace","ln","comment"].includes(t.type)));if(i){if(s.includes(i)||"operator"!==i.type){e=o;break}}else e=o-1}}}else e=Parse.A(t,this.S);if(null===e)return i("Cannot find end of function body.");l&&";"===t[e]?.text&&e++,this.j=t.slice(this.S,e)}}*getArgNames(){let t=this.J;if("arrowParam"===this.type)yield t[0].text;else{let e,i,l=[],s=null,r=!0,n=0;for(let o of t){let t=o.text;if("identifier"===o.type&&r?(s=t,e?i&&(i[s]=void 0):e=s):"("==t||"{"==t||"["==t?(n++,r=!0,e||"{"!=t||(e=i={}),s&&(i=i[s]={},l.push(i))):")"==t||"}"==t||"]"==t?(n--,i=l.pop()):","===t?r=!0:":"===t?r=!1:":"!==t&&"="!==t||(r=!1,s=null),0>n)return void(e&&(yield e));","===t&&0===n&&(yield e,e=i=void 0)}e&&(yield e)}}}var Parse={O(t=[]){let e=t.join(",");return varExprCache[e]||(varExprCache[e]=fregex(fregex.or(fregex("this",Parse.ws,fregex.oneOrMore(property)),...t.map((t=>fregex(t,fregex.zeroOrMore(property))))),terminator))},A(t,e=0,i=["(","{"],l=[")","}"],s=[],r=1){let n=0,o=i.includes(t[e].text);for(let a,f=e;a=t[f];f+=r){let t=a.text||a+"";if(i.includes(t))n+=r;else if(l.includes(t)){if(n-=r,o){if(0===n)return f+1}else if(0>n)return f}else if(!n&&s.includes(t))return f}return null},U(t){let e=[],i=1,l=0;for(let s of t)1!==i||"identifier"!==s.type||l?"("==s||"{"==s||"["==s?l++:")"!=s&&"}"!=s&&"]"!=s||l--:e.push(s+""),l||(i={",":1,"=":-1}[s]||i);return e},V(t,e=0){for(let i,l=e;i=t[l];l++){if("function"==i)return l;if("=>"==i){let e=0;for(let i,s=-1;i=t[l+s];s--)if("whitespace"!==i.type&&"ln"!==i.type&&"comment"!==i.type&&(")"==i?e++:"("==i&&e--,0===e))return l+s}}return null},F(t){let e=t.map((t=>({...t}))),i=this.V(e);for(let t,l=0;t=e[l];l++){if(l===i){let t=new ParsedFunction(e.slice(i));l=i+t.S+t.j.length+1,i=this.V(e,l)}"template"===t.type&&(e[l].text="`"+t.text.slice(1,-1).replace(/\${/g,"\\${").replace(/`/g,"\\`")+"`")}return e},C(t){return t=t.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"").replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*|<!--[\s\S]*?-->$/),t=utils.v(t,"{"),t=utils.v(t,"return"),t=utils.v(t,["`",'"',"'"]),(t=utils.v(t,["<"])).match(/<(\w+-[\w-]+)/)[1]},I(tokens){"string"==typeof tokens&&(tokens=lex(lexHtmlJs,tokens,"js"));let htmlMatch=fregex.matchFirst([fregex.or({type:"template"},{type:"string"}),Parse.ws,fregex.zeroOrOne(";")],tokens);if(!htmlMatch)return null;let template=htmlMatch.filter((t=>t.tokens||"string"===t.type))[0],innerTokens;if(template.tokens)innerTokens=template.tokens.slice(1,-1);else{let code=eval(template+"");innerTokens=lex(lexHtmlJs,code,"template")}for(;"openTag"!==innerTokens[0].type;)innerTokens=innerTokens.slice(1);return innerTokens},R(t,e,i){let l=[],s=!1;for(let e of t)if(e.tokens){let t=Parse.R(e.tokens,e.mode,i);l.push({text:t.map((t=>t.text)).join(""),type:e.type,tokens:t,mode:e.mode})}else"#{"==e.text&&"expr"==e.type?(l.push(new Token("${"),new Token(i),new Token("."),new Token("htmlEncode"),new Token("(")),s=!0):l.push(e);if(s){let t=[];"squote"===e?t=[new Token(","),new Token('"\'"')]:"dquote"===e&&(t=[new Token(","),new Token("'\"'")]),l.splice(l.length-1,0,...t,new Token(")"))}return l},M(t,e=[]){let i=[Parse.O(e),Parse.ws,".",Parse.ws,"map",Parse.ws,"(",Parse.ws],l=fregex.matchFirst(i,t);if(!l)return[null,null];let s=t.slice(l.length),r=Parse.V(s);if(null===r||0!==r)return[null,null];let n=new ParsedFunction(s.slice(r),!0,(()=>!1));return n&&fregex([Parse.ws,")",Parse.ws,fregex.zeroOrOne(";"),Parse.ws,fregex.end])(t.slice(l.length+n.S+n.j.length))?[[...n.getArgNames()],n.j]:[null,null]},N(t,e=[]){},q(t,e=[]){return fregex.matchAll(Parse.O(e),t).filter((e=>"."!=t[e.index-1]&&"?."!=t[e.index-1]))},G(expr){let result=[];for(let piece of expr)"this"==piece||"identifier"===piece.type||"number"===piece.type?result.push(piece+""):"string"!==piece.type&&"template"!==piece.type||result.push(eval(piece+""));return result}};let varExprCache={};Parse.ws=fregex.zeroOrMore(fregex.or({type:"whitespace"},{type:"ln"}));let indexType=[{type:"number"},{type:"hex"},{type:"string"},{type:"template"}];Parse.L=fregex.oneOrMore(fregex.or("this",".","[","]",{type:"identifier"},{type:"number"},{type:"hex"},{type:"string"},{type:"template"},{type:"whitespace"},{type:"ln"}));let terminator=fregex.lookAhead([fregex.or(fregex.end,fregex.not(Parse.ws,"("))]),property=fregex(fregex.or(fregex(Parse.ws,fregex.or(".","?."),Parse.ws,{type:"identifier"}),fregex(Parse.ws,fregex.zeroOrOne("?."),"[",Parse.ws,fregex.or(...indexType),Parse.ws,"]")),terminator);var div=document.createElement("div"),decodeCache_={},Html={decode(t){return t?t.replace(/&[#A-Z0-9]+;/gi,(t=>decodeCache_[t]||(div.innerHTML=t,decodeCache_[t]=div.textContent))):""},encode(t,e=""){return t=utils.toString(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\a0/g,"&nbsp;"),e.includes("'")&&(t=t.replace(/'/g,"&apos;")),e.includes('"')&&(t=t.replace(/"/g,"&quot;")),t}};class VText{text="";el=null;B=null;X=0;constructor(t="",e=null){this.B=e,null==t?t="":"string"==typeof t||t instanceof String||(t=JSON.stringify(t)),this.text=Html.decode(t)}D(t=null,e=null){if(e)this.el=e;else{let e;if("STYLE"!==t.tagName||this.B.contains(t.getRootNode()?.host))e=this.text;else{this.B.dataset.style||(this.B.constructor.styleId=(this.B.constructor.styleId||0)+1,this.B.dataset.style=this.B.constructor.styleId);let t=this.B.tagName.toLowerCase();e=VText.K(this.text,t,this.B.dataset.style)}this.el?this.el.textContent=e:(this.el=t.ownerDocument.createTextNode(e),(t=t.shadowRoot||t).insertBefore(this.el,t.childNodes[this.X])),Refract.elsCreated&&Refract.elsCreated.push(utils.toString(e))}return 1}Y(){let t=new VText;return t.text=this.text,t.B=this.B,t}Z(){this.el.parentNode.removeChild(this.el)}static K(t,e,i){return t.replace(RegExp(e+"|:host","g"),e+'[data-style="'+i+'"]')}}class ScopeItem{path;value;constructor(t,e){this.path=t,this.value=e}Y(){return new ScopeItem(this.path.slice(),this.value)}}class Scope extends Map{Y(){let t=new Scope;for(let[e,i]of this)t.set(e,i.Y());return t}tt(t){if("this"===t[0])return t;let e;for(;e=this.get(t[0]);)t=[...e.path,...t.slice(1)];return t}}class VExpression{et=[];it=null;lt=null;type="simple";isHash=!1;st=null;rt=[];nt=[];B=null;ot=null;ft=null;ht=[];ct={};ut=new Scope;X=0;dt=0;xt=[];constructor(t=null,e=null,i=null,l=null){if(this.ft=e,e&&(this.B=e.B,this.ct={...e.ct},this.ut=e.ut.Y()),t){let l="#{"==t[0].text;"${"!=t[0].text&&!l||"}"!=t[t.length-1].text||(this.isHash=l,t=t.slice(1,-1)),this.code=t.map((t=>t.text)).join("").trim(),i=(i||[]).slice();let s=Parse.q(t,i),[r,n]=Parse.M(t,i);if(n){this.type="loop",this.rt=r;for(let t of r)i.push(t);this.st=this.B.constructor.createFunction(...i,"return "+s[0].join(""));let t=n.filter((t=>"whitespace"!==t.type&&"ln"!==t.type));this.nt=1===t.length&&"template"===t[0].type?VElement.gt(t[0].tokens.slice(1,-1),i,e,this.B):[new VExpression(n,this,i)]}else{Parse.O(i)(t)!==t.length&&(this.type=Parse.L(t)===t.length?"simple":"complex"),t=Parse.R(t,null,this.B.constructor.name),t=Parse.F(t);let e=Html.decode(t.map((t=>t.text)).join(""));"{"!==t[0].text&&(e="return ("+e.trim()+")"),this.st=this.B.constructor.createFunction(...i,e)}for(let t of s)this.et.push(Parse.G(t))}}D(t=null,e=null){if(this.ot=t||this.ot,this.lt){for(let e of this.lt)t.removeAttribute(e);this.lt=[];let e=this.vt();if(e){let i=lex(lexHtmlJs,e,"tag"),l=null;for(let e of i)"attribute"===e.type?(l&&t.setAttribute(l,""),l=e,this.lt.push(l)):"string"===e.type&&(t.setAttribute(l,e.tokens[1]),l=null);l&&t.setAttribute(l,"")}return 0}{for(let t of this.ht)if(t instanceof HTMLElement)t.parentNode.removeChild(t);else for(let e of t.slice())e.Z();this.ht=this.bt();let t=0,e=this.X;for(let i of this.ht)if(i instanceof HTMLElement)this.ot.insertBefore(i,this.ot.childNodes[e]),e++;else for(let l of i){l.X=e;let i=l.D(this.ot,null);e+=i,t+=i}return t}}Y(t=null,e=null,i=null){let l=new VExpression;return l.et=this.et,l.it=this.it,l.lt=this.lt,l.type=this.type,l.st=this.st,l.rt=this.rt,l.nt=this.nt,l.B=t||this.B,l.ot=i||this.ot,l.ft=e||this.ft,l.X=this.X,l.dt=this.dt,l.ct={...this.ct},l.ut=this.ut.Y(),l.isHash=this.isHash,l.code=this.code,l}vt(){return this.st.apply(this.B,Object.values(this.ct))}bt(){for(let t of this.xt)Watch.remove(...t);this.xt=[],this._t||(this._t=this.wt.bind(this)),this.yt(this._t);let t=[];if("loop"!==this.type){let e=[this.vt()].flat().map((t=>void 0===t?"":t));if(this.isHash)t=[e.map((t=>new VText(t,this.B)))];else{let i=Object.keys(this.ct);for(let l of e)if(l instanceof HTMLElement)t.push(l);else if(l+="",l.length){let e=VElement.Et(l,i,this,this.B).flat();t.push(e)}}}else{let e=this.vt();if(!e)throw Error(`${this.et[0].join(".")} is not iterable in ${this.code}`);let i=0;for(let l of e){let l=[],s=[e[i],i,e];for(let t of this.nt){let e=t.Y(this.B,this);this.Ht(e,s,i),l.push(e)}t.push(l),i++}}return t}Ht(t,e,i){t.ct={...this.ct},t.ut=this.ut.Y();for(let l in this.rt){t.ct[this.rt[l]]=e[l];let s=[...this.et[0],i+""],r=this.ut.tt(s);t.ut.set(this.rt[l],new ScopeItem(r,[e[l]]))}}wt(t,e,i,l,s){if(this.ft&&("loop"!==this.type||2>=e.length||!utils.H(e.slice(0,-2),this.et[0].slice(1))))if(this.B.__autoRender||!this.B.virtualElement){if(Globals.Tt=this,this.dt=this.kt(),"complex"!==this.type&&e[e.length-1].match(/^\d+$/)){let i=e.slice(0,-1),l=delve(s,i);if(Array.isArray(l)&&utils._(this.et[0].slice(1),i)){let i=parseInt(e[e.length-1]);if("remove"===t){for(let t of this.ht[i])t.Z();this.ht.splice(i,1)}else{if("set"===t&&this.ht[i])for(let t of this.ht[i])t.Z();"insert"===t&&this.ht.splice(i,0,[]),this.ht[i]="simple"===this.type?[new VText(l[i],this.B)]:this.nt.map((t=>t.Y(this.B,this)));let e=0,s=this.Wt(i),r=[l[i],i,l];for(let t of this.ht[i])t.X=s+e,t.ot=this.ot,this.Ht(t,r,e+i),t.D(this.ot,null),e++}return this.Pt(),void(Globals.Tt=null)}}this.D(),this.Pt(),Globals.Tt=null}else this.B.__toRender.set(this,arguments)}Z(){for(let t of this.xt)Watch.remove(...t);this.xt=[];for(let t of this.ht)if(t instanceof HTMLElement)t.parentNode.removeChild(t);else for(let e of t)e.Z();if(this.ht=[],this.ft instanceof VElement){let t=this.ft.ht.indexOf(this);this.ft.ht.splice(t,1)}else for(let t of this.ft.ht){let e=t.indexOf(this);if(e>=0){t.splice(e,1);break}}this.ft=null}kt(){let t=0;for(let e of this.ht)if(e instanceof HTMLElement)t++;else for(let i of e)i.wt?t+=i.kt():t++;return t}Wt(t){let e=this.X;for(let i of this.ht.slice(0,t))for(let t of i)t instanceof VExpression?e+=t.kt():e++;return e}Jt(){let t=this.ft.ht.flat(),e=t.indexOf(this);for(let i of t.slice(e+1))if(i instanceof VExpression)return i;return this.ft.ot===this.ot&&this.ft instanceof VExpression?this.ft.Jt():null}Pt(){let t=this.kt()-this.dt,e=this;for(;e=e.Jt();)e.X+=t}yt(t){for(let e of this.et){let i,l=this.B;if("this"===e[0])e=e.slice(1);else if(e[0]in this.ct&&e.length>1)l=this.ct[e[0]],e=e.slice(1);else if(i=this.ut.get(e[0])){let t=delve(l,i.path.slice(1),delve.dontCreate,!0);if("object"!=typeof t&&!Array.isArray(t))continue;l=delve(this.B,i.path.slice(1,-1),delve.dontCreate,!0),e=i.path.slice(-1)}e.length&&("object"==typeof l||Array.isArray(l))&&(this.xt.push([l,e,t]),Watch.add(l,e,t))}}}lexHtmlJs.allowHashTemplates=!0;class VElement{tagName="";lt={};$t=[];B=null;el=null;ft=null;ht=[];ct={};ut=new Scope;X=0;constructor(t=null,e=null,i=null){if(e instanceof HTMLElement?this.B=e:e&&(this.ft=e,this.B=e.B,this.ct={...e.ct},this.ut=e.ut.Y()),t){let e="",l=t.filter((t=>"whitespace"!==t.type));for(let t,s=0;t=l[s];s++)if(0===s)this.tagName=t.text.slice(1);else if("attribute"===t.type)e=t.text,this.lt[e]=[];else if(e&&"="==l[s-1]){let l=[];if("string"===t.type)for(let s of t.tokens.slice(1,-1))l.push("expr"===s.type?new VExpression(s.tokens,this,i,e):s.text);else"expr"===t.type&&l.push(new VExpression(t.tokens,this,i,e));this.lt[e]=l,e=void 0}else if("expr"===t.type){let e=new VExpression(t.tokens,this,i);e.lt=[],this.$t.push(e)}else if(">"===t.text||"/>"===t.text)break}}D(t=null,e=null){let i=this.tagName;"svg"===i&&(inSvg=!0);var l=this.el;if(e)this.el=e,e.querySelector("slot")||(this.B.slotHtml=e.innerHTML),e.innerHTML="";else{var s;if(Globals.Tt=this,i.includes("-")&&customElements.get(i)){let t=customElements.get(i),e=[];t.prototype.init&&(e=Refract.compiler.populateArgsFromAttribs(this,t.St()));let l=2,n=i;for(;n.toUpperCase()in Globals.jt;){n=i+"_"+l;var r=customElements.get(n);if(r){t=r;break}t=class extends t{},customElements.define(n,t),l++}s=new t(...e)}else s=inSvg?document.createElementNS("http://www.w3.org/2000/svg",i):document.createElement(i);if(l)l.parentNode.insertBefore(s,l),l.remove();else if(!l){let e=t.shadowRoot||t;e!==this.B&&e.tagName&&e.tagName.includes("-")&&"SLOT"!==s.tagName&&(e=e.querySelector("slot")||e),e.insertBefore(s,e.childNodes[this.X])}this.el=s,Globals.Tt=null,Refract.elsCreated&&Refract.elsCreated.push("<"+i+">")}!this.el.shadowRoot&&"shadow"in this.lt&&this.el.attachShadow({mode:this.el.getAttribute("shadow")||"open"});let n=0;if("slot"===i){let t=VElement.Et(this.B.slotHtml,Object.keys(this.ct),this,this.B);for(let e of t)e.ct={...this.ct},e.ut=this.ut.Y(),e.X=n,n+=e.D(this.el)}let o="TEXTAREA"===this.el.tagName||this.lt.contenteditable&&this.lt.contenteditable+""!="false";for(let t of this.ht){if(o&&t instanceof VExpression)throw Error("textarea and contenteditable can't have templates as children. Use value=${this.variable} instead.");t.ct={...this.ct},t.ut=this.ut.Y(),t.B=this.B,t.X=n,n+=t.D(this.el)}for(let t in this.lt){let e=this.lt[t];for(let i of e)if(i instanceof VExpression){let l=i;l.ot=this.el,l.ct=this.ct,l.ut=this.ut.Y(),l.yt((()=>{if("value"===t)setInputValue_(this.B,this.el,e,this.ct);else{let i=VElement.At(this.B,e,this.ct);this.el.setAttribute(t,i)}}))}let i=VElement.At(this.B,e,this.ct);if(this.el.setAttribute(t,i),"id"===t||"data-id"===t){let e=this.el.getAttribute(t).split(".");delve(this.B,e,this.el)}else if(t.startsWith("on")&&t in div){let e=(this.B&&this.B.constructor||window.RefractCurrentClass).createFunction,i=this.el.getAttribute(t);this.el.removeAttribute(t),this.el[t]=t=>{let l=["event","el",...Object.keys(this.ct)];e(...l,i).bind(this.B)(t,this.el,...Object.values(this.ct))}}}for(let t of this.$t)t.ct=this.ct,t.ut=this.ut.Y(),t.D(this.el),t.yt((()=>{t.D(this.el)}));let a="value"in this.lt&&"option"!==i;if(a){let t=this.lt.value;if(1===t.length&&t[0]instanceof VExpression&&"simple"===t[0].type){let e=(0,(this.B&&this.B.constructor||window.RefractCurrentClass).createFunction)(...Object.keys(this.ct),"val",t[0].code+"=val;").bind(this.B);utils.k(this.el,((t,i)=>{Globals.Ot=i,e(...Object.values(this.ct),t),Globals.Ot=null}))}}return a&&setInputValue_(this.B,this.el,this.lt.value,this.ct),"svg"===i&&(inSvg=!1),1}Y(t,e=null){let i=new VElement;i.tagName=this.tagName,i.B=t||this.B,i.ft=e;for(let t in this.lt){i.lt[t]=[];for(let e of this.lt[t])i.lt[t].push(e instanceof VExpression?e.Y(i.B,this):e)}for(let t of this.$t)i.$t.push(t.Y(i.B,this));for(let t of this.ht)i.ht.push(t.Y(i.B,i));return i}Ut(name){let lname=name.toLowerCase(),val=name in this.lt?this.lt[name]:this.lt[lname];if(null==val)return val;if(val&&1===val.length&&val[0]instanceof VExpression)return val[0].st.apply(this.B,Object.values(this.ct));if(Array.isArray(val)&&!val.length)return!0;let result=VElement.At(this.B,val||[],this.ct);try{result=JSON.parse(result)}catch(e){if(result.startsWith("${")&&result.endsWith("}"))try{result=eval(result.slice(2,-1))}catch(t){}}return result}Z(){for(let t of this.ht)t.Z();this.el.parentNode.removeChild(this.el),this.ft=null}static Vt(t,e,i={}){let l=e.map((e=>e instanceof VExpression?e.st.apply(t,Object.values(i)):e));return 1===l.length?l[0]:l.flat().map(utils.toString).join("")}static At(t,e,i={}){let l=[];for(let s of e)if(s instanceof VExpression){let e=s.st.apply(t,Object.values(i));Array.isArray(e)||e instanceof Set?e=Array.from(e).join(" "):e&&"object"==typeof e&&(e=e.constructor===Object?Object.entries(e).map((([t,i])=>`${t}: ${e[t]}; `)).join(""):""),l.push(e)}else l.push(Html.decode(s));return l.map(utils.toString).join("")}static Et(t,e=[],i=null,l){let s=lex(lexHtmlJs,[t].flat().join(""),"template");return VElement.gt(s,e,i,l)}static gt(t,e=[],i=null,l,s=!1,r=0){if(!t.length)return[];let n=[];do{let o=t[r];if("text"===o.type)n.push(new VText(o.text,i?.B));else if("expr"===o.type)n.push(new VExpression(o.tokens,i,e));else if("openTag"===o.type){let s=new VElement(o.tokens,i||l,e);n.push(s),"/>"==o.tokens[o.tokens.length-1].text||s.tagName.toLowerCase()in selfClosingTags_||(r++,s.ht=VElement.gt(t,e,s,l,!1,r),r=s.ht.index)}else if("closeTag"===o.type)break;if(n.length===s)break;r++}while(t.length>r);return n.index=r,n}}var selfClosingTags_={area:1,base:1,br:1,col:1,embed:1,hr:1,img:1,input:1,link:1,meta:1,param:1,source:1,track:1,wbr:1,command:1,keygen:1,menuitem:1},inSvg=!1;function setInputValue_(t,e,i,l){if(Globals.Ot&&e===Globals.Ot.target)return;let s="TEXTAREA"===e.tagName||e.hasAttribute("contenteditable")&&"false"!==e.getAttribute("contenteditable");if(s||"INPUT"===e.tagName){let r=VElement.At(t,i,l);s?e.innerHTML=r:"checkbox"===e.type?e.checked=["1","true"].includes((r+"").toLowerCase()):e.value=r}else{let s=VElement.Vt(t,i,l);if("SELECT"===e.tagName)for(let t of e.children)t.selected=Array.isArray(s)?s.includes(t.value):s===t.value;else e.value=s}}class Compiler{static createModifiedClass(t){let e={};e.Ft=t;let i=`\n\t\t\t__preInit = (${""+(()=>{if("autoRender"in this?this.__autoRender=this.autoRender:"__autoRender"in this||(this.__autoRender=!0),!1!==Object.getOwnPropertyDescriptor(this,"autoRender")?.configurable&&Object.defineProperty(this,"autoRender",{get(){return this.__autoRender},set(t){this.__autoRender=t,t&&this.render()}}),this.__autoRender&&this.render(),this.init){let t=this.parentElement?this.constructor.compiler.populateArgsFromAttribs(this,this.constructor.St()):this.Ct;this.init(...t)}})})()`;return t.prototype.html&&(e.tagName=Parse.C(""+t.prototype.html),e.code=(""+t).slice(0,-1)+i+"}"),e}static decorateAndRegister(t,e){t.tagName=e.tagName,t.constructorArgs=e.constructorArgs,t.htmlTokens=e.htmlTokens;for(let i of Object.getOwnPropertyNames(e.Ft.prototype))"constructor"!==i&&(t.prototype[i]=e.Ft.prototype[i]);for(let i of Object.getOwnPropertyNames(e.Ft))i in Refract||(t[i]=e.Ft[i]);customElements.define(e.tagName,t)}static populateArgsFromAttribs(t,e){const i=e=>{for(let l in e)e[l]?i(e[l]):e[l]=t.Ut(l);return e};let l=[];for(let s of e)l.push("string"==typeof s?t.Ut(s):i(s));return l}}lexHtmlJs.allowHashTemplates=!0;var Globals={Ot:null,Tt:null,jt:{}};class Refract extends HTMLElement{static compiler=Compiler;static tagName;static htmlTokens=null;static virtualElement;static constructorArgs=null;static initArgs=null;static elsCreated=!1;slotHtml="";__autoRender=!0;__toRender=new Map;virtualElement=null;__connected=!1;__connectedCallbacks=[];__firstConnectedCallbacks=[];__disconnectedCallbacks=[];constructor(t=!0){super(),!1===t&&(this.__autoRender=!1),this.Ct=arguments}render(){if(this.__autoRender=!0,!this.virtualElement){if(!this.constructor.virtualElement){if(this.html&&"function"==typeof this.html&&(this.constructor.htmlTokens=Parse.I(""+this.html),!this.constructor.htmlTokens))throw Error("Class is missing an html function with a template value.");this.constructor.virtualElement=VElement.gt(this.constructor.htmlTokens,[],null,this,1)[0],this.constructor.htmlTokens=null}Globals.jt[this.tagName]=!0,this.virtualElement=this.constructor.virtualElement.Y(this),this.virtualElement.D(null,this),delete Globals.jt[this.tagName]}if(this.__toRender.size){for(let t of this.__toRender.keys()){let e=t;for(;e=e.ft;)if(this.__toRender.has(e)){this.__toRender.delete(t);break}}for(let[t,e]of this.__toRender.entries())t.wt(...e);this.__toRender=new Map}}Ut(name,alt){let velement=Refract.Tt;if(velement)return velement.getAttrib(name);{let hval=this.getAttribute(name);if(null===hval)return alt;let val=Html.decode(hval);try{return JSON.parse(val)}catch{}if(val.startsWith("${")&&val.endsWith("}"))try{return eval("("+val.slice(2,-1)+")")}catch{}return val}}static St(){if(!this.initArgs&&this.prototype.init){let t=new ParsedFunction(this.prototype.init,!1);this.initArgs=[...t.getArgNames()]}return this.initArgs||[]}onConnect(t){this.__connected&&t(),this.__connectedCallbacks.push(t)}onFirstConnect(t){this.__connected?t():this.__firstConnectedCallbacks.push(t)}onDisconnect(t){this.__connected&&t(),this.__disconnectedCallbacks.push(t)}connectedCallback(){this.__connected=!0;for(let t of this.__connectedCallbacks)t();for(let t of this.__firstConnectedCallbacks)t();this.__firstConnectedCallbacks=[]}disconnectedCallback(){this.__connected=!1;for(let t of this.__disconnectedCallbacks)t()}static compile(){return`\n\t\t\t(() => {\n\t\t\t\t${this.name}.createFunction = (...args) => {\n\t\t\t\t\tlet params = args.slice(0, -1).join(',');\n\t\t\t\t\tlet code = args[args.length-1];\n\t\t\t\t\treturn eval(\`(function(\${params}) {\${code}})\`);\n\t\t\t\t};\n\t\t\t\tlet modified = ${this.name}.compiler.createModifiedClass(${this.name});\n\t\t\t\t${this.name} = eval('('+modified.code+')');\t\t\n\t\t\t\t${this.name}.compiler.decorateAndRegister(${this.name}, modified);\n\t\t\t\treturn ${this.name};\t\n\t\t\t})();\t\t\n\t\t`}}Refract.htmlDecode=Html.decode,Refract.htmlEncode=Html.encode;var h=(t,e="\"'")=>Html.encode(t,e);export default Refract;export{Globals,utils as Utils,Watch,delve,fregex,h,lex,lexHtmlJs};